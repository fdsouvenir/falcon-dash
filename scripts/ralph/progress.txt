# Ralph Progress Log — Phase 2b: Chat Enhanced
Started: Sun Feb  8 2026
---

## Codebase Patterns
- Chat/session types live in `src/lib/gateway/types.ts` (single file, no separate types file)
- Type unions use string literal types (e.g., `'user' | 'assistant' | 'system' | 'inject'`)
- Params types for gateway methods named as `{Method}Params` (e.g., `ChatSendParams`)
- Response types named as `{Method}Response` or `{Method}Ack` for ack patterns
- AgentEvent types use `kind` discriminator field with `sessionKey` and `runId` for routing
- All types re-exported via `src/lib/gateway/index.ts` barrel (`export * from './types'`)
- Stores barrel: `src/lib/stores/index.ts` — explicitly named exports (not `export *`)
- Svelte store Maps need `new Map(map)` on update to trigger reactivity
- Chat store wires gateway.on('agent') to stream manager's handleEvent in initChatListeners()
- Optimistic inserts use temp IDs (`temp-{timestamp}-{counter}`), replaced after server ack
- For arrays inside a Map store, spread into new array `[...list]` to trigger Svelte reactivity
- activeRun derived store uses polling (setInterval 200ms) since stream manager is not a store
- Chat components live in `src/lib/components/chat/` directory
- Time utilities live in `src/lib/utils/time.ts`
- ESLint `svelte/no-reactive-functions` disallows `$: fn = (x) => ...` — use plain `function` declarations instead
- For reactive timestamps, pass a `now` variable to formatting functions so Svelte detects the dependency
- ESLint `svelte/require-each-key` enforces keyed `{#each}` blocks — use index `(i)` when items lack unique IDs
- Chat route: `src/routes/chat/+page.svelte` with `+page.ts` (ssr: false)
- Reconnection gap fill: track lastKnownSeq from agent events, detect RECONNECTING→READY via connectionState subscription, reload sessions + fill history gap

---
