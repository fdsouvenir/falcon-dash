# Ralph Progress Log
Started: Sun Feb  8 05:23:56 PM CST 2026
---

## Codebase Patterns

- Mobile tab bar: `MobileTabBar.svelte` — fixed bottom nav with 5 tabs, hidden on md+ via `md:hidden`
- Mobile more menu: `MobileMoreMenu.svelte` — bottom sheet with fly transition for overflow nav items
- Mobile padding: Main content uses `pb-14 md:pb-0` to avoid tab bar overlap
- Unread badge: Derived from sessions store, passed as `totalUnread` prop to tab bar
- Tab active state: Uses `$page.url.pathname` matching with wildcard support
- Gesture utilities: `src/lib/utils/gestures.ts` — Svelte actions for `swipe`, `longpress`, `pullToRefresh`
- BottomSheet: `BottomSheet.svelte` — reusable bottom sheet with backdrop, fly transition, drag handle
- Touch targets: Use `min-h-[44px] min-w-[44px]` on mobile, `md:min-h-0 md:min-w-0` to reset on desktop
- Mobile visibility: Use `opacity-100 md:opacity-0 md:group-hover:opacity-100` (not `opacity-0 group-hover:opacity-100`) for hover actions
- ConfirmDialog: Shows as centered modal on desktop (`hidden md:flex`), bottom sheet on mobile (`md:hidden`)
- Tailwind class: directive: `class:bg-slate-700/50={cond}` breaks Svelte parser — use string interpolation instead
- Offline store: `src/lib/stores/offline.ts` — `isOnline`, `isOffline` stores + `offlineQueue` for background sync
- OfflineIndicator: `src/lib/components/OfflineIndicator.svelte` — amber banner with slide transition when offline
- Notification service: `src/lib/services/notifications.ts` — push registration, browser notifications, tab title, sound
- Services barrel: `src/lib/services/index.ts` — barrel export for notification service
- Preferences key: `falcon-dash:preferences` — includes `notificationSound` alongside existing fields
- Web Audio API: Use `AudioContext` with oscillator for notification sounds (no external audio files needed)
- `Uint8Array.buffer` type: Returns `ArrayBufferLike`, needs cast `as ArrayBuffer` for `PushManager.subscribe`
- Virtual scrolling: Inline implementation (scroll handler + computed visible slice) avoids typed slot issues in Svelte 4
- VirtualList component: `src/lib/components/VirtualList.svelte` — reusable for fixed-height items, exposes `getViewport()`
- Lazy KaTeX: Two-processor approach — base (no KaTeX), math (with KaTeX loaded on first math detection)
- Lazy images: Rehype plugin `lazy-images-plugin.ts` adds `loading="lazy"` to all `<img>` elements
- Content-visibility: Use `style="content-visibility: auto; contain-intrinsic-size: auto 60px;"` for variable-height list items
- Bundle splitting: `manualChunks` in vite config separates shiki/mermaid/katex into own chunks
- Workbox limit: Set `maximumFileSizeToCacheInBytes: 5MB` to accommodate large Shiki chunk (2.3MB)

## 2026-02-08 17:30 - US-072
- Implemented mobile bottom tab bar with 5 tabs (Chat, Projects, Files, Jobs, More)
- Created `MobileMoreMenu` bottom sheet for Settings, Passwords, Custom Apps overflow
- Integrated into `+layout.svelte` with unread badge support from sessions store
- Tab bar: fixed bottom, `md:hidden`, active tab highlighted in `text-blue-400`
- More menu: backdrop + fly transition panel, shows custom apps when pinned
- Files changed:
  - `src/lib/components/MobileTabBar.svelte` (new)
  - `src/lib/components/MobileMoreMenu.svelte` (new)
  - `src/routes/+layout.svelte` (modified — added imports, totalUnread, moreMenu state, pb-14)
- **Learnings for future iterations:**
  - CustomApp type has no `icon` field — don't assume properties exist
  - No `/apps` index route exists, only `/apps/[id]` — don't link to non-existent routes
  - a11y ignore comments needed for click-only backdrop divs

## 2026-02-08 17:45 - US-073
- Implemented touch gestures and mobile interactions across the app
- Created `src/lib/utils/gestures.ts` with three Svelte actions:
  - `swipe`: Detect swipe left/right/up/down with configurable threshold
  - `longpress`: Detect long-press with position callback, cancels on move
  - `pullToRefresh`: Pull-down refresh on scrollable containers with indicator
- Created `src/lib/components/BottomSheet.svelte` — reusable bottom sheet modal
- Added swipe-to-go-back on chat conversation view (swipe right = back to session list)
- Added pull-to-refresh on: Sidebar session list, file browser list, projects view
- Added long-press context menus:
  - Chat messages: bottom sheet with Copy, Reply actions
  - Kanban task cards: bottom sheet with status change quick actions + View Details
- Updated ConfirmDialog to show as bottom sheet on mobile, centered modal on desktop
- Fixed 44x44px tap targets on:
  - MessageActionBar (copy button — also fixed mobile visibility, was hover-only)
  - MessageComposer (Send/Abort buttons)
  - Layout mobile header hamburger button
  - File delete buttons (also fixed mobile visibility)
  - Projects sidebar toggle, search toggle, view switcher tabs
  - Kanban add task button
- Fixed file list horizontal scroll on mobile by hiding Modified/Size columns
- Files changed:
  - `src/lib/utils/gestures.ts` (new)
  - `src/lib/components/BottomSheet.svelte` (new)
  - `src/lib/components/Sidebar.svelte` (pull-to-refresh on sessions)
  - `src/lib/components/chat/MessageActionBar.svelte` (44px targets, mobile visibility)
  - `src/lib/components/chat/MessageComposer.svelte` (44px button targets)
  - `src/lib/components/files/ConfirmDialog.svelte` (desktop modal + mobile bottom sheet)
  - `src/lib/components/pm/KanbanBoard.svelte` (longpress, task action bottom sheet, 44px targets)
  - `src/routes/+layout.svelte` (44px hamburger button)
  - `src/routes/chat/+page.svelte` (swipe-back, longpress messages, context menu)
  - `src/routes/files/+page.svelte` (pull-to-refresh, responsive grid, 44px delete button)
  - `src/routes/projects/+page.svelte` (pull-to-refresh, 44px sidebar/search/view targets)
- **Learnings for future iterations:**
  - `class:bg-slate-700/50={cond}` breaks Svelte parser — the `/50` confuses it. Use string interpolation `class="{cond ? 'bg-slate-700/50' : ''}"` instead
  - MessageActionBar used `opacity-0 group-hover:opacity-100` — completely invisible on mobile. Fix: show by default, hide on md+
  - File list grid with fixed-width columns (w-24, w-20) overflows on small screens — hide on mobile with `hidden md:block`
  - Svelte actions (`use:directive`) work great as Svelte 4 patterns for touch gestures

## 2026-02-08 17:55 - US-074
- Implemented PWA offline mode and push notifications
- Enhanced workbox config in `vite.config.ts`:
  - Added `navigateFallback: '/'` for offline navigation
  - Added runtime caching: CacheFirst for images/fonts, StaleWhileRevalidate for JS/CSS
- Created `src/lib/stores/offline.ts`:
  - `isOnline`/`isOffline` reactive stores with browser `online`/`offline` event listeners
  - `offlineQueue` store with `queueAction`/`dequeueAction`/`clearQueue` for background sync
  - Queue persisted to localStorage under `falcon-dash:offline-queue`
- Created `src/lib/components/OfflineIndicator.svelte`:
  - Fixed amber banner at top with slide transition
  - Shows "You're offline — viewing cached data" with pending action count
  - Uses `aria-live="assertive"` for screen reader announcements
- Created `src/lib/services/notifications.ts`:
  - `showNotification()` — browser Notification API with sound, respects preferences
  - `requestNotificationPermission()` / `getNotificationPermission()` — permission management
  - `registerPushNotifications(vapidPublicKey)` — VAPID-based push subscription
  - `updateTabTitle(unreadCount)` — tab title with unread count badge `(N) Falcon Dash`
  - `playNotificationSound()` — Web Audio API oscillator (no external files)
- Updated `DashboardTab.svelte`:
  - Added "Notification Sound" toggle (persisted in preferences)
  - Added "Push Notifications" section with permission status (Enabled/Blocked/Enable button)
- Updated `+layout.svelte`:
  - Integrated OfflineIndicator component
  - Wired `initOfflineListeners()` in onMount
  - Reactive `updateTabTitle(totalUnread)` for tab title badge
  - Notification on unread count increase when tab is not focused
- Updated barrel exports: `src/lib/stores/index.ts`, created `src/lib/services/index.ts`
- Files changed:
  - `vite.config.ts` (enhanced workbox config)
  - `src/lib/stores/offline.ts` (new)
  - `src/lib/services/notifications.ts` (new)
  - `src/lib/services/index.ts` (new)
  - `src/lib/components/OfflineIndicator.svelte` (new)
  - `src/lib/components/settings/DashboardTab.svelte` (notification sound + push UI)
  - `src/lib/stores/index.ts` (added offline exports)
  - `src/routes/+layout.svelte` (offline indicator + notification wiring)
- **Learnings for future iterations:**
  - `Uint8Array.buffer` returns `ArrayBufferLike` not `ArrayBuffer` — cast with `as ArrayBuffer` for `PushManager.subscribe`
  - Web Audio API oscillator is a lightweight alternative to shipping audio files for notification sounds
  - `document.hasFocus()` is the simplest way to suppress notifications when the user is already looking at the tab

## 2026-02-08 18:10 - US-075
- Comprehensive accessibility audit and fixes across all 27 files
- **Skip link:** Added skip-to-content link in `+layout.svelte` (sr-only, visible on focus)
- **ARIA landmarks:** `aria-label` on main sidebar nav, mobile tab bar nav, more menu nav
- **aria-hidden on decorative SVGs:** Added across all components (hamburger, search, tab icons, etc.)
- **aria-labels on interactive elements:**
  - MobileTabBar: tab buttons, more button, unread badge
  - MobileMoreMenu: nav items
  - Sidebar: new chat button, unpin buttons, session buttons
  - ConnectionStatus: role="status", aria-live="polite"
  - MessageComposer: textarea, send/abort buttons
  - CommandPalette: role="listbox", role="option", aria-selected
  - Chat page: scroll-to-bottom button, context menu actions
  - Files page: breadcrumb nav, sort buttons, rename input, delete buttons
  - Jobs page: heartbeat interval input
  - Passwords page: search input
  - KanbanBoard: add task button/input, task card checkboxes
  - BulkActions: action buttons
  - PmSearch: search input
  - CronJobForm: form inputs
  - CronJobList: action buttons
- **aria-live regions:**
  - Chat messages: role="log" aria-live="polite" on MessageList
  - Error messages: aria-live="assertive" on error containers (jobs, files, projects, passwords)
  - Save errors: aria-live="assertive" on heartbeat save error
- **ARIA roles on tabs:**
  - Jobs page: role="tablist", role="tab", aria-selected on Heartbeat/Cron tabs
  - Projects page: role="tablist", role="tab", aria-selected on Dashboard/List/Kanban tabs
  - Settings page: role="tablist", role="tab", aria-selected on settings tabs
- **Visible focus indicators:** focus-visible:ring-2 focus-visible:ring-blue-500 on:
  - Jobs tab buttons, projects view switcher tabs
  - KanbanBoard task cards
  - TaskDetail form inputs
- **Keyboard navigation:**
  - KanbanBoard task cards: Space key handler alongside Enter
  - BottomSheet: Escape key to close
- **aria-current:** Already present on Sidebar nav items and MobileTabBar tabs
- **Form input labels:** aria-label on all inputs (heartbeat interval, search, file rename, cron form fields)
- Files changed (27 files):
  - `src/routes/+layout.svelte` (skip link, landmarks)
  - `src/routes/+page.svelte` (landing page a11y)
  - `src/routes/chat/+page.svelte` (aria-live, aria-labels, aria-hidden)
  - `src/routes/files/+page.svelte` (breadcrumb, sort labels, aria-live)
  - `src/routes/jobs/+page.svelte` (tab roles, aria-live, focus indicators)
  - `src/routes/projects/+page.svelte` (tab roles, aria-live, focus indicators)
  - `src/routes/passwords/+page.svelte` (search label, aria-live)
  - `src/routes/apps/[id]/+page.svelte` (a11y improvements)
  - `src/lib/components/Sidebar.svelte` (aria-labels)
  - `src/lib/components/ConnectionStatus.svelte` (role=status, aria-live)
  - `src/lib/components/MobileTabBar.svelte` (nav label, tab labels)
  - `src/lib/components/MobileMoreMenu.svelte` (nav label, aria-hidden)
  - `src/lib/components/BottomSheet.svelte` (escape key, aria-modal)
  - `src/lib/components/chat/MessageList.svelte` (role=log, aria-live)
  - `src/lib/components/chat/MessageActionBar.svelte` (aria-hidden SVGs)
  - `src/lib/components/chat/MessageComposer.svelte` (input/button labels)
  - `src/lib/components/chat/CommandPalette.svelte` (listbox/option roles)
  - `src/lib/components/chat/ChannelSettings.svelte` (a11y improvements)
  - `src/lib/components/chat/ChatHeader.svelte` (a11y improvements)
  - `src/lib/components/files/ConfirmDialog.svelte` (a11y improvements)
  - `src/lib/components/files/FileActions.svelte` (button labels)
  - `src/lib/components/jobs/CronJobForm.svelte` (form input labels)
  - `src/lib/components/jobs/CronJobList.svelte` (action button labels)
  - `src/lib/components/pm/KanbanBoard.svelte` (task card a11y, keyboard)
  - `src/lib/components/pm/BulkActions.svelte` (button labels)
  - `src/lib/components/pm/PmSearch.svelte` (search input label)
  - `src/lib/components/pm/TaskDetail.svelte` (focus indicators)
- **Learnings for future iterations:**
  - Agents using `sed` for Svelte files can corrupt syntax (missing `>` brackets) — always use Edit tool instead
  - When multiple agents touch the same file, one will get "File has been modified since read" errors — assign exclusive file ownership
  - `role="tablist"` text injected by sed outside HTML tags causes parse errors — must be placed as attributes inside the opening tag
  - Pre-existing `autofocus` warnings (14 total) are acceptable — they come from intentional UX patterns (inline editing)

## 2026-02-08 22:30 - US-076
- Performance optimization across rendering, bundling, and loading
- **Virtual scrolling on file list:**
  - Inline virtual scrolling in files page with scroll handler + computed visible slice
  - Fixed 44px row height, 10-item buffer, padding spacers for scroll position
  - Preserves pull-to-refresh gesture on scroll container
- **VirtualList component:**
  - Created reusable `VirtualList.svelte` for fixed-height items
  - Exposes `getViewport()` for external scroll container access
  - Supports `scrollToEnd` for auto-scroll-to-bottom behavior
- **Content-visibility for chat messages:**
  - Added `content-visibility: auto` with `contain-intrinsic-size` on all message containers
  - Applied to both chat page (assistant + user messages) and MessageList component
  - Browser skips layout/paint for off-screen messages automatically
- **Lazy KaTeX loading:**
  - Split markdown pipeline into base processor (no KaTeX) and math processor (with KaTeX)
  - KaTeX only loaded via dynamic `import('rehype-katex')` when math syntax detected
  - Math detection regex: `$$...$$`, `$...$`, `\(...\)`, `\[...\]`
  - RenderedContent tries sync render first, then async-loads KaTeX if math detected
- **Image lazy loading:**
  - Created `rehypeLazyImagesPlugin` that adds `loading="lazy"` to all `<img>` elements
  - Added `loading` to sanitize schema allowed attributes for `img`
  - Applied in both base and math processor pipelines
- **Bundle optimization:**
  - Added `manualChunks` in vite config to split shiki, mermaid, katex into separate chunks
  - Increased workbox `maximumFileSizeToCacheInBytes` to 5MB for large Shiki chunk
  - Route-based code splitting verified working (SvelteKit default behavior)
- **Verified:**
  - Debounced search consistency: PmSearch uses debounced API calls, passwords uses reactive filter
  - Shiki and Mermaid already lazy-loaded via dynamic imports
  - npm run format passes, npm run check 0 errors, npm run build succeeds
- Files changed:
  - `src/lib/components/VirtualList.svelte` (new)
  - `src/lib/utils/markdown/lazy-images-plugin.ts` (new)
  - `src/lib/utils/markdown/pipeline.ts` (lazy KaTeX, dual processor)
  - `src/lib/utils/markdown/index.ts` (export renderMarkdownAsync)
  - `src/lib/utils/markdown/sanitize-schema.ts` (img loading attr)
  - `src/lib/components/chat/RenderedContent.svelte` (async KaTeX, content-visibility on imgs)
  - `src/lib/components/chat/MessageList.svelte` (content-visibility on messages)
  - `src/routes/chat/+page.svelte` (content-visibility on messages)
  - `src/routes/files/+page.svelte` (virtual scrolling on file list)
  - `vite.config.ts` (manualChunks, workbox limit)
- **Learnings for future iterations:**
  - `content-visibility: auto` is the simplest performance win for variable-height lists — no JS virtual scrolling needed
  - Typed slot variables in Svelte 4 VirtualList component are `unknown` — inline virtual scrolling avoids cast issues
  - Shiki with 17 languages produces a ~2.3MB chunk — this is normal and expected, lazy-loaded
  - `ReturnType<typeof unified>` type inference breaks with multi-use chains — use explicit interface type instead
