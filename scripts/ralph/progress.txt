# Ralph Progress Log
Started: Sun Feb  8 01:33:42 PM CST 2026

## Codebase Patterns
- SvelteKit server routes: export named handlers (GET, POST, PUT, DELETE, PATCH) from `+server.ts`
- Use `json()` and `error()` from `@sveltejs/kit` in server routes
- Type handlers with `RequestHandler` from `./$types` (auto-generated)
- Server-only code goes in `src/lib/server/` — SvelteKit excludes from client bundles
- `[...path]` catch-all routes: `params.path` is a single string
- `@types/node` is installed as devDependency for Node.js API types in server routes
- Error casting pattern: `(err as NodeJS.ErrnoException).code === 'ENOENT'`
- SvelteKit error objects have a `.status` property for HTTP status codes
- Fetch-based stores: use `fetch('/api/...')` for SvelteKit server routes, `gateway.call()` for WS methods
- Module-specific types go in `src/lib/types/`, gateway types in `src/lib/gateway/types.ts`
- Directory listing API returns `{ files: [...] }` — destructure with `data.files`
- Prettier fails on `class:bg-slate-700/30={expr}` — use inline ternary in `class=` attr instead
- `onMount` async cannot return cleanup function — use `onDestroy` for cleanup instead

---

## 2026-02-08 - US-038
- Implemented workspace file server routes (first +server.ts files in the project)
- Files created:
  - `src/lib/server/workspace.ts` — getWorkspacePath(), computeHash(), validatePath()
  - `src/routes/api/workspace/files/+server.ts` — GET directory listing
  - `src/routes/api/workspace/files/[...path]/+server.ts` — GET, PUT, DELETE, PATCH file CRUD
- Also installed `@types/node` as devDependency (needed for Node.js types in server routes)
- **Learnings for future iterations:**
  - `@types/node` was not previously installed; needed for `node:fs/promises`, `node:path`, `node:os`, `node:crypto`, and `NodeJS.ErrnoException`
  - Hash-based concurrency: PUT compares baseHash to current file hash, returns 409 on conflict
  - Traverse protection: validatePath() rejects paths resolving outside workspace root and `.secrets` paths
---

## 2026-02-08 - US-039
- Implemented file types and fetch-based store for workspace file operations
- Files created:
  - `src/lib/types/files.ts` — WorkspaceFile, FileContent, FileWriteRequest, FileWriteResponse interfaces
  - `src/lib/types/index.ts` — barrel export for types directory
  - `src/lib/stores/files.ts` — writable stores (files, currentPath, activeFile, activeFileName) + fetch functions (loadFiles, loadFile, saveFile, deleteFile, createFile, renameFile, navigateTo)
- Files modified:
  - `src/lib/stores/index.ts` — added barrel exports for file stores
- **Learnings for future iterations:**
  - The directory listing API returns `{ files: [...] }` not a bare array — must use `data.files` not `data`
  - Fetch-based stores use standard `fetch()` to SvelteKit API routes, not `gateway.call()`
  - `src/lib/types/` is the new home for module-specific types (vs gateway types in `src/lib/gateway/types.ts`)
  - 409 conflict handling: throw descriptive Error that the UI can catch and display
---

## 2026-02-08 - US-040
- Implemented /files route with two-pane file browser UI
- Files created:
  - `src/lib/utils/format.ts` — formatFileSize(bytes) returning human-readable B/KB/MB/GB
  - `src/routes/files/+page.ts` — SSR disabled
  - `src/routes/files/+page.svelte` — two-pane layout with breadcrumb nav, sortable columns, file/folder icons, loading/error/empty states
- Features:
  - Breadcrumb navigation with clickable segments
  - Sortable columns (name, modified, size) with direction indicators
  - Directories always sort first
  - Active file highlighted in list
  - Responsive: stacked on mobile, side-by-side on desktop
  - Relative timestamps via formatRelativeTime, auto-refreshing every 30s
  - Preview pane shows plain text (FilePreview/FileEditor components come in US-041)
- **Learnings for future iterations:**
  - Prettier Svelte parser fails on `class:bg-slate-700/30={expr}` — the `/` in the class name confuses the parser. Use inline ternary in `class="... {expr ? 'bg-slate-700/30' : ''}"` instead
  - `onMount` with async function cannot return a cleanup function (TypeScript error). Use `onDestroy` for cleanup instead, or use `.catch()/.finally()` on the promise
  - Helper functions like `isFileActive(file)` are cleaner than inline expressions with store values in template attributes
---

## 2026-02-08 - US-041
- Implemented file preview and editor components for the /files route
- Files created:
  - `src/lib/components/files/FilePreview.svelte` — renders .md via RenderedContent, code files via HighlighterManager, plain text as pre
  - `src/lib/components/files/FileEditor.svelte` — textarea with save/cancel, dirty state, Ctrl+S/Escape shortcuts
- Files modified:
  - `src/routes/files/+page.svelte` — replaced plain text preview with FilePreview, added Edit button toggling to FileEditor, hash-based save with 409 conflict error display
- Features:
  - Extension-to-Shiki-language mapping function (18 extensions)
  - Markdown files rendered via existing RenderedContent pipeline (markdown, math, mermaid, admonitions)
  - Code files highlighted via Shiki (lazy init on mount)
  - Unrecognized extensions shown as plain text
  - FileEditor dispatches save/cancel events, tracks dirty state
  - Save passes baseHash from activeFile, handles 409 conflict with user-facing error message
  - Editing state resets on file switch and directory navigation
- **Learnings for future iterations:**
  - FilePreview and FileEditor are in `src/lib/components/files/` and will be reused by US-045 (heartbeat HEARTBEAT.md editing)
  - RenderedContent requires `isStreaming` prop — pass `false` for static file preview
  - createEventDispatcher generic typing: `createEventDispatcher<{ save: { content: string }; cancel: void }>()`
---

## 2026-02-08 - US-042
- Implemented file create, rename, delete with reusable ConfirmDialog modal
- Files created:
  - `src/lib/components/files/ConfirmDialog.svelte` — reusable confirmation modal with title, message, confirmLabel, open props; dispatches confirm/cancel events; backdrop click, Escape key, focus trap
  - `src/lib/components/files/FileActions.svelte` — toolbar with New File and New Folder buttons; inline input with Enter to submit, Escape/blur to cancel
- Files modified:
  - `src/routes/api/workspace/files/+server.ts` — added POST handler for creating directories
  - `src/lib/stores/files.ts` — added createFolder(dir, name) function
  - `src/lib/stores/index.ts` — added createFolder to barrel exports
  - `src/routes/files/+page.svelte` — added FileActions toolbar, inline rename (double-click name → input, Enter/blur saves, Escape cancels), delete button per row with ConfirmDialog confirmation, grid column updated to 4-column layout for delete button
- Features:
  - ConfirmDialog: backdrop overlay, focus trap, Escape to cancel, reusable by US-046 and US-050
  - FileActions: New File and New Folder with inline input prompts
  - Inline rename: double-click file name enters edit mode, selects filename without extension, Enter/blur submits, Escape cancels
  - Delete: trash icon appears on hover (group-hover:opacity-100), requires ConfirmDialog confirmation, clears active file if deleted
  - File row changed from button to div with clickable spans (needed for inline rename input and delete button)
- **Learnings for future iterations:**
  - ConfirmDialog lives at `src/lib/components/files/ConfirmDialog.svelte` — reuse for cron job delete and password entry delete
  - Inline rename input needs `on:click|stopPropagation` wrapper to prevent row click handler from firing
  - `requestAnimationFrame` needed before `focus()` on dynamically rendered inputs in Svelte
  - File row changed from `<button>` to `<div>` with inner clickable `<span>` elements to support nested interactive elements (rename input, delete button)
  - `svelte-ignore a11y-click-events-have-key-events` and `a11y-no-static-element-interactions` needed for clickable spans
---

## 2026-02-08 - US-043
- Implemented cron job types and gateway-based store
- Files created:
  - `src/lib/stores/cron.ts` — writable stores (cronJobs, cronRuns), gateway.call functions (loadCronJobs, addCronJob, editCronJob, removeCronJob, enableCronJob, disableCronJob, runCronJob, loadCronRuns), real-time event listeners (initCronListeners, destroyCronListeners)
- Files modified:
  - `src/lib/gateway/types.ts` — added CronScheduleType, CronJobPayload, CronJob, CronRunStatus, CronRun, CronListResponse, CronRunsResponse, CronAddParams, CronEditParams
  - `src/lib/stores/index.ts` — added barrel exports for cron store
- Features:
  - Gateway-based store using gateway.call() (not fetch)
  - Listener pattern matching initChatListeners/destroyChatListeners from chat.ts
  - Real-time event handling for cron events: added, updated, removed, run_update actions
  - Optimistic local updates for enable/disable/remove (+ full reload for add/edit)
- **Learnings for future iterations:**
  - Gateway.call params typed as Record<string, unknown>, so interfaces need `as unknown as Record<string, unknown>` cast for nested objects
  - Real-time cron events use action-based dispatch: 'added'/'updated' carry full job, 'removed' carries jobId, 'run_update' carries full run
  - Event listener name is 'cron' (matches gateway.on('cron', handler)), not 'event:cron'
---
