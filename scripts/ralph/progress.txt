# Ralph Progress Log
Started: Sun Feb  8 10:00:52 AM CST 2026
---

## Codebase Patterns
- Chat/session types live in `src/lib/gateway/types.ts` (single file, no separate types file)
- Type unions use string literal types (e.g., `'user' | 'assistant' | 'system' | 'inject'`)
- Params types for gateway methods named as `{Method}Params` (e.g., `ChatSendParams`)
- Response types named as `{Method}Response` or `{Method}Ack` for ack patterns
- AgentEvent types use `kind` discriminator field with `sessionKey` and `runId` for routing
- All types re-exported via `src/lib/gateway/index.ts` barrel (`export * from './types'`)
- Stores barrel: `src/lib/stores/index.ts` — explicitly named exports (not `export *`)
- Svelte store Maps need `new Map(map)` on update to trigger reactivity

---

## 2026-02-08 - US-017
- Extended `src/lib/gateway/types.ts` with all Phase 2a chat and session types
- Added: MessageRole, ThinkingBlock, ToolCall, ChatMessage, ChatSendParams, ChatSendAck, ChatHistoryParams, ChatHistoryResponse, ChatAbortParams, ChatInjectParams, Session, SessionListParams, SessionListResponse, SessionPatchParams, AgentRunState, AgentRunStatus, ToolCallStatus
- Files changed: `src/lib/gateway/types.ts`
- **Learnings for future iterations:**
  - Existing AgentEvent types already have sessionKey/runId — no need to duplicate in chat types
  - SessionListParams mirrors ws-protocol.md: kinds, limit, activeMinutes, messageLimit
  - Idempotency keys are NOT in param types — correlator auto-generates them
  - All types auto-exported through existing barrel export in index.ts
---

## 2026-02-08 - US-018
- Created `src/lib/gateway/stream.ts` with AgentStreamManager class
- Tracks active runs by runId, routes agent events by kind discriminator
- text_delta replaces content (full accumulated text, NOT append)
- Thinking accumulation: creates new ThinkingBlock or appends to last incomplete one
- Tool tracking: tool_start creates pending ToolCall, tool_result matches by toolName (last pending)
- Callbacks: onMessage, onRunComplete, onRunError for chat store integration
- Exported from `src/lib/gateway/index.ts` barrel
- Files changed: `src/lib/gateway/stream.ts` (new), `src/lib/gateway/index.ts`
- **Learnings for future iterations:**
  - Stream manager is stateless regarding gateway — chat store wires gateway.on('agent') to handleEvent
  - sessionRuns map provides O(1) lookup of active run by sessionKey
  - cleanup() removes from all three maps (runs, sessionRuns, messages) after text_end or abort
  - getStreamMessage(runId) allows chat store to read in-progress message for reactive updates
---

## 2026-02-08 - US-019
- Created `src/lib/stores/sessions.ts` with Svelte writable/derived stores for session management
- Added: sessions (Map<string, Session>), activeSessionKey, activeSession (derived)
- Functions: loadSessions(), switchSession(), updateSession(), incrementUnread(), addSession(), removeSession()
- switchSession() auto-resets unread count for the newly active session
- removeSession() clears activeSessionKey if the removed session was active
- Updated `src/lib/stores/index.ts` barrel export with all session exports
- Files changed: `src/lib/stores/sessions.ts` (new), `src/lib/stores/index.ts`
- **Learnings for future iterations:**
  - Session store uses Map<string, Session> keyed by session key for O(1) lookup
  - Svelte store reactivity with Maps requires creating a new Map instance on update (`new Map(map)`)
  - updateSession() takes Omit<SessionPatchParams, 'sessionKey'> for clean API — sessionKey passed separately
  - `get()` from svelte/store used for one-off reads (e.g., checking activeSessionKey in removeSession)
---
