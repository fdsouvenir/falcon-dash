# Ralph Progress Log
Started: Sun Feb  8 02:55:07 PM CST 2026
---

## Codebase Patterns

### PM Store Pattern
- Store file: `src/lib/stores/pm.ts`
- Writable stores for each entity: `pmDomains`, `pmFocuses`, `pmMilestones`, `pmProjects`, `pmTasks`, `pmComments`, `pmActivities`, `pmStats`, `pmBlocks`, `pmAttachments`
- Load functions accept optional filter params and use `gateway.call<ResponseType>('pm.entity.method', params)`
- Optimistic updates: update store immediately, call gateway, revert on error (try/catch pattern)
- `handleEntityEvent<T>()` generic function handles create/update/delete for all entity types
- `handlePmEvent()` dispatches by `entityType` using switch/case
- stateVersion gap detection: if incoming version > current + 1, refetch all entities
- `initPmListeners()`/`destroyPmListeners()` pattern matches cron store
- Params cast to `Record<string, unknown>` for gateway.call compatibility

### PM Component Pattern
- Components live in `src/lib/components/pm/` with barrel export from `index.ts`
- PmSidebar: secondary navigation within `/projects` route (not main app sidebar)
- Props for selection state: `selectedDomainId`, `selectedFocusId` — dispatches `select` event
- Inline forms for create/edit with Enter to submit, Escape to cancel
- Hover-reveal action buttons using Tailwind `group`/`group-hover` + `opacity-0`/`group-hover:opacity-100`
- Nested group hover: use `group/name` syntax for focus items inside domain group
- ConfirmDialog reused from Phase 3 files module
- Svelte `class:hover:bg-*` directives: do NOT use Tailwind opacity modifiers (`/60`) — Prettier fails. Use solid colors like `bg-slate-800` instead

### PM Kanban / Drag-Drop Pattern
- HTML5 DnD: `draggable="true"`, `on:dragstart`, `on:dragover`, `on:drop`, `on:dragend`
- Track drag state with local vars: `draggedTaskId`, `dragOverColumn`
- Column containers need `role="list"` + `aria-label` for a11y
- Use helper booleans (`isDragging`, `isColumnDragOver`) to avoid template-level casts
- Cross-column drop = status change via `updateTask({ id, status })`
- Same-column drop = reorder via `reorderTasks({ parentProjectId, ids })`
- Scope filtering: derive `projectIdsInScope` set from props → filter tasks

### PM Dashboard Route Pattern
- Route at `/projects` with `ssr: false` in `+page.ts`
- `onMount`: call `initPmListeners()` + parallel data loads via `Promise.all`
- `onDestroy`: call `destroyPmListeners()`
- TypeScript casts in Svelte templates: NEVER use `as Type` inside `{expressions}` — Prettier fails. Use helper functions to cast in the `<script>` block instead.
- Reactive derived data: `$:` declarations filter/sort store data for sections

### PM Types Pattern
- Entity types prefixed with `Pm`: `PmDomain`, `PmFocus`, `PmProject`, etc.
- Method param/response types: `Pm{Group}{Action}Params` / `Pm{Group}{Action}Response`
- Single-entity returns use the entity type directly (no wrapper response)
- Enums: `PmStatus` (6 values), `PmPriority` (4 values)
- Barrel exports from `src/lib/types/index.ts` — enums use value export, interfaces use `export type`
- PmEvent carries `stateVersion: { pm: number }` for gap detection

---

## 2026-02-08 - US-051
- Created `src/lib/types/pm.ts` with all PM entity interfaces, enums, event types, and method param/response types
- Updated `src/lib/types/index.ts` barrel export with all PM type exports
- Files changed: `src/lib/types/pm.ts` (new), `src/lib/types/index.ts`
- **Learnings for future iterations:**
  - ~45 method types across 13 groups — comprehensive coverage done
  - `PmTargetType` ('project' | 'task') reused across Comment, Block, Attachment params
  - `PmEntity` union type useful for PmEvent payload typing

## 2026-02-08 - US-052
- Created `src/lib/stores/pm.ts` with full PM store layer: 10 writable stores, CRUD functions for all entities, event listeners, search, bulk operations
- Updated `src/lib/stores/index.ts` barrel exports with all PM store exports
- Files changed: `src/lib/stores/pm.ts` (new), `src/lib/stores/index.ts`
- **Learnings for future iterations:**
  - Generic `handleEntityEvent<T>()` reduces boilerplate for create/update/delete across all entity types
  - Block entity has no `id` — uses `blockerId`+`blockedId` compound key for filtering
  - `loadTasks(projectId)` merges new tasks while preserving tasks from other projects in the store
  - Optimistic updates pattern: save prev value, update store, try gateway call, revert with prev on error

## 2026-02-08 - US-053
- Created PM dashboard view at `src/routes/projects/+page.svelte` with `+page.ts` (ssr: false)
- Dashboard sections: stats header (projects, tasks, overdue, blocked counts), tasks by status breakdown, due soon (7 days), blocked tasks, in-progress tasks, recent activity feed
- Used parallel loading: `Promise.all([loadStats, loadActivities, loadProjects, loadBlocks])`
- Derived reactive data: `dueSoonTasks`, `blockedTasks`, `inProgressTasks`, `recentActivities`
- Files changed: `src/routes/projects/+page.ts` (new), `src/routes/projects/+page.svelte` (new)
- **Learnings for future iterations:**
  - `as TypeName` casts inside Svelte template expressions cause Prettier parse errors — use helper functions to cast in script block instead
  - `PmBlock` entities track blocking via `blockerId`/`blockedId` — blocked tasks derived from `$pmBlocks` set
  - `statusEntries()` helper converts `Record<string, number>` to typed array to avoid template-level casts
  - Sidebar already has `/projects` link from Phase 3, no sidebar changes needed

## 2026-02-08 - US-054
- Created `src/lib/components/pm/PmSidebar.svelte` — collapsible tree showing Domain → Focus hierarchy
- Created `src/lib/components/pm/index.ts` barrel export
- Features: expand/collapse domains, click to select domain/focus/all, inline create/edit forms, delete with confirmation, reorder via up/down buttons, hover-reveal action buttons
- Uses ConfirmDialog from Phase 3, dispatches `select` event with `{ domainId, focusId }` payload
- Files changed: `src/lib/components/pm/PmSidebar.svelte` (new), `src/lib/components/pm/index.ts` (new)
- **Learnings for future iterations:**
  - `class:hover:bg-slate-700/60` fails Prettier — the `/` in Tailwind opacity modifier breaks Svelte class directive parsing. Use solid colors like `hover:bg-slate-800` instead
  - Tailwind `group/name` nested hover variant works well for focus items inside domain rows
  - Keyboard helpers (Enter/Escape) on inline forms improve UX without adding complexity

## 2026-02-08 - US-055
- Created `src/lib/components/pm/ProjectList.svelte` — filterable, sortable table of projects
- Updated `src/lib/components/pm/index.ts` barrel export with ProjectList
- Features: filter bar (status/priority dropdowns), sortable columns (title, status, priority, due date, created date), click-to-navigate, status badges with color coding, priority indicators, due date with overdue detection, task count per project, empty state, responsive columns (focus hidden on sm, tasks hidden on md)
- Props accept `selectedDomainId`/`selectedFocusId` from sidebar for domain/focus filtering
- Dispatches `select` event with `{ projectId }` for navigation
- Files changed: `src/lib/components/pm/ProjectList.svelte` (new), `src/lib/components/pm/index.ts`
- **Learnings for future iterations:**
  - Sort weight functions (prioritySortWeight, statusSortWeight) keep sort logic clean
  - Domain filtering requires deriving focus IDs from `$pmFocuses` store, then checking project's `focusId`
  - `$pmTasks` store can be used for task count per project via `filter(t => t.parentProjectId === projectId).length`
  - Unicode sort arrows (\u25B2/\u25BC) work well for sort indicators without needing SVG icons

## 2026-02-08 - US-056
- Created `src/lib/components/pm/KanbanBoard.svelte` — kanban board with drag-and-drop
- Updated `src/lib/components/pm/index.ts` barrel export with KanbanBoard
- Features: 4 status columns (todo, in_progress, review, done), task cards with title/priority/due date, HTML5 drag-and-drop between columns (status change) and within columns (reorder), add task button per column with inline form, horizontal scroll, column task counts, empty column state, drag-over visual highlight, cancelled/archived tasks hidden
- Props: `selectedProjectId`, `selectedFocusId`, `selectedDomainId` for scoping tasks
- Dispatches `select` event with `{ taskId }` for task detail navigation
- Files changed: `src/lib/components/pm/KanbanBoard.svelte` (new), `src/lib/components/pm/index.ts`
- **Learnings for future iterations:**
  - Drag-drop column containers need `role="list"` and `aria-label` for a11y — svelte-check warns otherwise
  - Helper functions like `isDragging(taskId)` and `isColumnDragOver(status)` avoid `as` casts in templates
  - `projectIdsInScope` derived set enables efficient multi-project filtering for focus/domain scope
  - `tasksForColumn(status)` as a function (not reactive) works fine since it references reactive `visibleTasks`
