# Ralph Progress Log
Started: Sun Feb  8 11:50:41 AM CST 2026
---

## Codebase Patterns
- unified/remark/rehype pipeline is synchronous via processSync() — all plugins must be sync
- rehype-sanitize Schema type from hast-util-sanitize has strict PropertyDefinition types — avoid explicit type annotation on custom schema objects, let TypeScript infer then cast at usage site with `as typeof defaultSchema`
- RenderedContent.svelte uses `doRender()` function wrapper to avoid svelte/infinite-reactive-loop lint rule while still doing debounced rendering
- `<!-- eslint-disable-next-line svelte/no-at-html-tags -->` must be placed directly above the `{@html}` usage line, not as a file-level comment
- Streaming detection for a message: `isRunning && !!message.runId && !!$activeRun && $activeRun.runId === message.runId`
- Prettier will reformat markdown tables in .md files — use `git checkout --` to restore instructions files before commit

---

## 2026-02-08 - US-028
- Implemented markdown rendering pipeline with unified/remark/rehype ecosystem
- Files created:
  - `src/lib/utils/markdown/pipeline.ts` — renderMarkdown(text) returns sanitized HTML
  - `src/lib/utils/markdown/sanitize-schema.ts` — custom schema extending GitHub default (allows class on code/pre/div/span, data-* on div)
  - `src/lib/utils/markdown/index.ts` — barrel exports
  - `src/lib/components/chat/RenderedContent.svelte` — {@html} wrapper with 50ms debounced re-render during streaming
- Files modified:
  - `src/routes/chat/+page.svelte` — assistant messages now use RenderedContent, user messages remain plain text
  - `package.json` / `package-lock.json` — added unified, remark-parse, remark-gfm, remark-rehype, rehype-sanitize, rehype-stringify
- Prose styling via :global() CSS in RenderedContent.svelte (dark slate theme, no @tailwindcss/typography)
- **Learnings for future iterations:**
  - rehype-sanitize Schema type import from 'rehype-sanitize' fails — it's re-exported as `export type` which TypeScript resolves differently; let inference handle it
  - The svelte/infinite-reactive-loop ESLint rule triggers on `$:` blocks with setTimeout that assign reactive vars — wrapping in a function avoids detection
  - Pipeline: remarkParse → remarkGfm → remarkRehype → rehypeSanitize(customSchema) → rehypeStringify (later stories add plugins between these)
---
