# Ralph Progress Log
Started: Sun Feb  8 01:33:42 PM CST 2026

## Codebase Patterns
- SvelteKit server routes: export named handlers (GET, POST, PUT, DELETE, PATCH) from `+server.ts`
- Use `json()` and `error()` from `@sveltejs/kit` in server routes
- Type handlers with `RequestHandler` from `./$types` (auto-generated)
- Server-only code goes in `src/lib/server/` — SvelteKit excludes from client bundles
- `[...path]` catch-all routes: `params.path` is a single string
- `@types/node` is installed as devDependency for Node.js API types in server routes
- Error casting pattern: `(err as NodeJS.ErrnoException).code === 'ENOENT'`
- SvelteKit error objects have a `.status` property for HTTP status codes
- Fetch-based stores: use `fetch('/api/...')` for SvelteKit server routes, `gateway.call()` for WS methods
- Module-specific types go in `src/lib/types/`, gateway types in `src/lib/gateway/types.ts`
- Directory listing API returns `{ files: [...] }` — destructure with `data.files`
- Prettier fails on `class:bg-slate-700/30={expr}` — use inline ternary in `class=` attr instead
- `onMount` async cannot return cleanup function — use `onDestroy` for cleanup instead
- `<tr>` elements with `on:click` do NOT trigger a11y-click-events/a11y-no-static-element-interactions — don't add unused svelte-ignore comments
- `execFile` callback form needed for stdin piping (promisify doesn't expose child.stdin) — wrap in Promise manually
- Session token pattern: server stores token in memory, client sends via `X-Vault-Token` header, validate with `validateSession(token)`

---

## 2026-02-08 - US-038
- Implemented workspace file server routes (first +server.ts files in the project)
- Files created:
  - `src/lib/server/workspace.ts` — getWorkspacePath(), computeHash(), validatePath()
  - `src/routes/api/workspace/files/+server.ts` — GET directory listing
  - `src/routes/api/workspace/files/[...path]/+server.ts` — GET, PUT, DELETE, PATCH file CRUD
- Also installed `@types/node` as devDependency (needed for Node.js types in server routes)
- **Learnings for future iterations:**
  - `@types/node` was not previously installed; needed for `node:fs/promises`, `node:path`, `node:os`, `node:crypto`, and `NodeJS.ErrnoException`
  - Hash-based concurrency: PUT compares baseHash to current file hash, returns 409 on conflict
  - Traverse protection: validatePath() rejects paths resolving outside workspace root and `.secrets` paths
---

## 2026-02-08 - US-039
- Implemented file types and fetch-based store for workspace file operations
- Files created:
  - `src/lib/types/files.ts` — WorkspaceFile, FileContent, FileWriteRequest, FileWriteResponse interfaces
  - `src/lib/types/index.ts` — barrel export for types directory
  - `src/lib/stores/files.ts` — writable stores (files, currentPath, activeFile, activeFileName) + fetch functions (loadFiles, loadFile, saveFile, deleteFile, createFile, renameFile, navigateTo)
- Files modified:
  - `src/lib/stores/index.ts` — added barrel exports for file stores
- **Learnings for future iterations:**
  - The directory listing API returns `{ files: [...] }` not a bare array — must use `data.files` not `data`
  - Fetch-based stores use standard `fetch()` to SvelteKit API routes, not `gateway.call()`
  - `src/lib/types/` is the new home for module-specific types (vs gateway types in `src/lib/gateway/types.ts`)
  - 409 conflict handling: throw descriptive Error that the UI can catch and display
---

## 2026-02-08 - US-040
- Implemented /files route with two-pane file browser UI
- Files created:
  - `src/lib/utils/format.ts` — formatFileSize(bytes) returning human-readable B/KB/MB/GB
  - `src/routes/files/+page.ts` — SSR disabled
  - `src/routes/files/+page.svelte` — two-pane layout with breadcrumb nav, sortable columns, file/folder icons, loading/error/empty states
- Features:
  - Breadcrumb navigation with clickable segments
  - Sortable columns (name, modified, size) with direction indicators
  - Directories always sort first
  - Active file highlighted in list
  - Responsive: stacked on mobile, side-by-side on desktop
  - Relative timestamps via formatRelativeTime, auto-refreshing every 30s
  - Preview pane shows plain text (FilePreview/FileEditor components come in US-041)
- **Learnings for future iterations:**
  - Prettier Svelte parser fails on `class:bg-slate-700/30={expr}` — the `/` in the class name confuses the parser. Use inline ternary in `class="... {expr ? 'bg-slate-700/30' : ''}"` instead
  - `onMount` with async function cannot return a cleanup function (TypeScript error). Use `onDestroy` for cleanup instead, or use `.catch()/.finally()` on the promise
  - Helper functions like `isFileActive(file)` are cleaner than inline expressions with store values in template attributes
---

## 2026-02-08 - US-041
- Implemented file preview and editor components for the /files route
- Files created:
  - `src/lib/components/files/FilePreview.svelte` — renders .md via RenderedContent, code files via HighlighterManager, plain text as pre
  - `src/lib/components/files/FileEditor.svelte` — textarea with save/cancel, dirty state, Ctrl+S/Escape shortcuts
- Files modified:
  - `src/routes/files/+page.svelte` — replaced plain text preview with FilePreview, added Edit button toggling to FileEditor, hash-based save with 409 conflict error display
- Features:
  - Extension-to-Shiki-language mapping function (18 extensions)
  - Markdown files rendered via existing RenderedContent pipeline (markdown, math, mermaid, admonitions)
  - Code files highlighted via Shiki (lazy init on mount)
  - Unrecognized extensions shown as plain text
  - FileEditor dispatches save/cancel events, tracks dirty state
  - Save passes baseHash from activeFile, handles 409 conflict with user-facing error message
  - Editing state resets on file switch and directory navigation
- **Learnings for future iterations:**
  - FilePreview and FileEditor are in `src/lib/components/files/` and will be reused by US-045 (heartbeat HEARTBEAT.md editing)
  - RenderedContent requires `isStreaming` prop — pass `false` for static file preview
  - createEventDispatcher generic typing: `createEventDispatcher<{ save: { content: string }; cancel: void }>()`
---

## 2026-02-08 - US-042
- Implemented file create, rename, delete with reusable ConfirmDialog modal
- Files created:
  - `src/lib/components/files/ConfirmDialog.svelte` — reusable confirmation modal with title, message, confirmLabel, open props; dispatches confirm/cancel events; backdrop click, Escape key, focus trap
  - `src/lib/components/files/FileActions.svelte` — toolbar with New File and New Folder buttons; inline input with Enter to submit, Escape/blur to cancel
- Files modified:
  - `src/routes/api/workspace/files/+server.ts` — added POST handler for creating directories
  - `src/lib/stores/files.ts` — added createFolder(dir, name) function
  - `src/lib/stores/index.ts` — added createFolder to barrel exports
  - `src/routes/files/+page.svelte` — added FileActions toolbar, inline rename (double-click name → input, Enter/blur saves, Escape cancels), delete button per row with ConfirmDialog confirmation, grid column updated to 4-column layout for delete button
- Features:
  - ConfirmDialog: backdrop overlay, focus trap, Escape to cancel, reusable by US-046 and US-050
  - FileActions: New File and New Folder with inline input prompts
  - Inline rename: double-click file name enters edit mode, selects filename without extension, Enter/blur submits, Escape cancels
  - Delete: trash icon appears on hover (group-hover:opacity-100), requires ConfirmDialog confirmation, clears active file if deleted
  - File row changed from button to div with clickable spans (needed for inline rename input and delete button)
- **Learnings for future iterations:**
  - ConfirmDialog lives at `src/lib/components/files/ConfirmDialog.svelte` — reuse for cron job delete and password entry delete
  - Inline rename input needs `on:click|stopPropagation` wrapper to prevent row click handler from firing
  - `requestAnimationFrame` needed before `focus()` on dynamically rendered inputs in Svelte
  - File row changed from `<button>` to `<div>` with inner clickable `<span>` elements to support nested interactive elements (rename input, delete button)
  - `svelte-ignore a11y-click-events-have-key-events` and `a11y-no-static-element-interactions` needed for clickable spans
---

## 2026-02-08 - US-043
- Implemented cron job types and gateway-based store
- Files created:
  - `src/lib/stores/cron.ts` — writable stores (cronJobs, cronRuns), gateway.call functions (loadCronJobs, addCronJob, editCronJob, removeCronJob, enableCronJob, disableCronJob, runCronJob, loadCronRuns), real-time event listeners (initCronListeners, destroyCronListeners)
- Files modified:
  - `src/lib/gateway/types.ts` — added CronScheduleType, CronJobPayload, CronJob, CronRunStatus, CronRun, CronListResponse, CronRunsResponse, CronAddParams, CronEditParams
  - `src/lib/stores/index.ts` — added barrel exports for cron store
- Features:
  - Gateway-based store using gateway.call() (not fetch)
  - Listener pattern matching initChatListeners/destroyChatListeners from chat.ts
  - Real-time event handling for cron events: added, updated, removed, run_update actions
  - Optimistic local updates for enable/disable/remove (+ full reload for add/edit)
- **Learnings for future iterations:**
  - Gateway.call params typed as Record<string, unknown>, so interfaces need `as unknown as Record<string, unknown>` cast for nested objects
  - Real-time cron events use action-based dispatch: 'added'/'updated' carry full job, 'removed' carries jobId, 'run_update' carries full run
  - Event listener name is 'cron' (matches gateway.on('cron', handler)), not 'event:cron'
---

## 2026-02-08 - US-044
- Implemented heartbeat config store — hybrid store combining gateway config and workspace file API
- Files created:
  - `src/lib/stores/heartbeat.ts` — writable stores (heartbeatConfig, heartbeatFileContent, heartbeatFileHash), gateway functions (loadHeartbeatConfig, updateHeartbeatConfig), fetch functions (loadHeartbeatFile, saveHeartbeatFile)
- Files modified:
  - `src/lib/gateway/types.ts` — added HeartbeatConfig, GatewayConfigResponse interfaces
  - `src/lib/stores/index.ts` — added barrel exports for heartbeat store
- Features:
  - Gateway-based: heartbeat config via config.get/config.patch
  - Fetch-based: HEARTBEAT.md content via workspace file API routes
  - loadHeartbeatFile handles 404 gracefully (empty content/hash)
  - saveHeartbeatFile handles 409 conflict with user-facing error
  - updateHeartbeatConfig applies optimistic local update after gateway call
- **Learnings for future iterations:**
  - Hybrid stores combine both data sources (gateway.call + fetch) — keep each function clearly typed
  - GatewayConfigResponse.payload is Record<string, unknown> and needs `as unknown as HeartbeatConfig` cast
  - 404 handling for optional files: set empty defaults rather than throwing
---

## 2026-02-08 - US-045
- Implemented /jobs route with two-tab layout (Heartbeat + Cron Jobs)
- Files created:
  - `src/routes/jobs/+page.ts` — SSR disabled
  - `src/routes/jobs/+page.svelte` — tab layout with heartbeat config card, HEARTBEAT.md preview/edit, cron placeholder
- Features:
  - Two tabs: Heartbeat (default active), Cron Jobs
  - Tab switching preserves state (simple state variable, not router)
  - Status card: enabled/paused toggle, interval input with dirty-state save button, last run time, run status
  - HEARTBEAT.md rendered via FilePreview (cross-module reuse from files module)
  - Edit mode via FileEditor with hash-based concurrency (saveHeartbeatFile with baseHash)
  - Save error display for 409 conflicts
  - Loading, error (with retry), and empty states
  - Interval value synced from store after initial load, not reactively (avoids overwriting user edits)
  - Cron Jobs tab shows placeholder text (implemented in US-046)
- **Learnings for future iterations:**
  - Cross-module component reuse works cleanly — FilePreview/FileEditor imported from `$lib/components/files/` into /jobs route
  - Reactive `$: localVar = $store.prop` overwrites user edits — sync from store only after explicit load, not reactively
  - `onDestroy` for interval cleanup (consistent with files route pattern)
  - Tab state preserved naturally via `{#if activeTab === ...}` blocks — Svelte doesn't destroy/recreate the hidden branch
---

## 2026-02-08 - US-046
- Implemented Cron Jobs tab with job list and CRUD operations
- Files created:
  - `src/lib/components/jobs/CronJobList.svelte` — table component with columns (name, schedule, next/last run, status badge, actions), row selection, hover-reveal action buttons, empty state
  - `src/lib/components/jobs/CronJobForm.svelte` — modal form for create/edit with validation, schedule type selector, prompt textarea, enabled checkbox, focus trap, Escape/backdrop close
- Files modified:
  - `src/routes/jobs/+page.svelte` — replaced placeholder cron tab with full CronJobList, CronJobForm, and ConfirmDialog integration; lazy-loads cron data on first tab visit; initCronListeners on mount, destroyCronListeners on destroy
- Features:
  - CronJobList: name, schedule type badge + value, relative next/last run times, clickable enable/disable badge, edit/run now/delete action buttons (hover reveal), selected row highlighting
  - CronJobForm: create/edit modes, pre-fill from existing job, inline validation errors on submit, schedule placeholder by type
  - Delete confirmation via ConfirmDialog (reuse from US-042)
  - Lazy loading: cron jobs loaded on first tab switch, not on mount
  - Real-time updates via initCronListeners/destroyCronListeners lifecycle
  - Row selection for future run history expansion (US-047)
- **Learnings for future iterations:**
  - `svelte-ignore a11y-click-events-have-key-events` and `a11y-no-static-element-interactions` are NOT needed for `<tr>` elements with `on:click` — the Svelte ESLint plugin doesn't warn for table row clicks, and unused svelte-ignore comments trigger `svelte/no-unused-svelte-ignore`
  - CronJobForm modal follows same pattern as ConfirmDialog: fixed overlay, dialog with role="dialog" aria-modal="true", focus trap, Escape/backdrop
  - Lazy tab loading: use a `cronLoaded` boolean guard so data only loads once on first tab visit
---

## 2026-02-08 - US-047
- Implemented cron job run history component with expandable output and auto-polling
- Files created:
  - `src/lib/components/jobs/CronRunHistory.svelte` — table with started at, duration, status badge, expandable output via details/summary, 30s polling for running jobs
- Files modified:
  - `src/routes/jobs/+page.svelte` — added CronRunHistory import, conditional render below CronJobList when selectedJobId is set
- Features:
  - Duration formatting: ms, seconds (1 decimal), minutes+seconds
  - Status badges: success (green), error (red), running (blue with animated pulse dot)
  - Output expandable via HTML `<details><summary>` element with scrollable pre block
  - Reactive jobId change: reloads run history when selectedJobId changes via `$:` reactive statement
  - Poll interval: 30s polling active only when at least one run has status 'running', auto-clears when all complete
  - Loading, error, and empty states
  - `onDestroy` cleanup for poll interval
- **Learnings for future iterations:**
  - Reactive `$: if (prop)` pattern works well for reloading data when a prop changes
  - Reactive `$: updatePolling($store)` cleanly manages conditional setInterval/clearInterval based on store state
  - `<details><summary>` is a clean no-JS-needed pattern for expandable content in tables
---

## 2026-02-08 - US-048
- Implemented password vault server routes wrapping keepassxc-cli
- Files created:
  - `src/lib/server/passwords.ts` — PasswordVault singleton class with session management, idle timeout, keepassxc-cli wrapping
  - `src/routes/api/passwords/+server.ts` — GET (availability + list entries), POST (unlock/lock/init actions)
  - `src/routes/api/passwords/[...path]/+server.ts` — GET (read entry), PUT (create/edit entry), DELETE (remove entry)
- Features:
  - PasswordVault singleton with `getInstance()`, cached availability check
  - Master password always piped via stdin (never as CLI argument) using `execWithStdin()` helper
  - Session token (UUID) returned on unlock, validated via `X-Vault-Token` header
  - 15-minute idle timeout auto-locks vault (clears token + cached master password)
  - keepassxc-cli commands: ls (list), show (get entry), add (create), edit (update), rm (delete), db-create (init)
  - Graceful degradation: GET returns `{ available: false }` when keepassxc-cli not installed, mutations return 503
  - Route structure follows existing workspace files pattern (root + catch-all `[...path]`)
- **Learnings for future iterations:**
  - `execFile` callback form is needed for stdin piping — `promisify(execFile)` doesn't expose child.stdin
  - keepassxc-cli `add` command needs both master password and entry password on separate stdin lines: `masterPassword\nentryPassword\n`
  - keepassxc-cli `edit -p` flag enables password update, also needs two stdin lines
  - keepassxc-cli `db-create -p` flag means "use password" (vs key file)
  - Session token pattern: server stores token + master password in memory, client sends token in `X-Vault-Token` header
  - Vault path configurable via `OPENCLAW_VAULT_PATH` env var, defaults to `~/.openclaw/passwords.kdbx`
---

## 2026-02-08 - US-049
- Implemented password types and fetch-based store for vault operations
- Files created:
  - `src/lib/types/passwords.ts` — PasswordEntry, PasswordEntryFull, VaultStatus, VaultState types
  - `src/lib/stores/passwords.ts` — writable stores (vaultState, passwordEntries, sessionToken), fetch functions (checkVault, unlockVault, lockVault, initVault, getEntry, createEntry, editEntry, deleteEntry)
- Files modified:
  - `src/lib/types/index.ts` — added barrel exports for password types
  - `src/lib/stores/index.ts` — added barrel exports for password store
- Features:
  - Fetch-based store pattern matching files.ts
  - Session token stored in memory only (writable store, never localStorage) — page refresh requires re-entering master password
  - All API calls include X-Vault-Token header via authHeaders() helper
  - checkVault() determines vault status: unavailable, locked, or unlocked
  - Server returns entry titles as string[] from listEntries — mapped to PasswordEntry[] in store
  - Error responses parsed for message field when available
- **Learnings for future iterations:**
  - Server listEntries returns string[] (entry titles), not full PasswordEntry objects — client maps these to PasswordEntry with just `title` field
  - `get()` from svelte/store is needed to read store values in non-reactive contexts (e.g., building headers)
  - Memory-only session token is a deliberate security pattern — never persist to localStorage or cookies
---
