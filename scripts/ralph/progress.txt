# Ralph Progress Log
Started: Sun Feb  8 10:00:52 AM CST 2026
---

## Codebase Patterns
- Chat/session types live in `src/lib/gateway/types.ts` (single file, no separate types file)
- Type unions use string literal types (e.g., `'user' | 'assistant' | 'system' | 'inject'`)
- Params types for gateway methods named as `{Method}Params` (e.g., `ChatSendParams`)
- Response types named as `{Method}Response` or `{Method}Ack` for ack patterns
- AgentEvent types use `kind` discriminator field with `sessionKey` and `runId` for routing
- All types re-exported via `src/lib/gateway/index.ts` barrel (`export * from './types'`)
- Stores barrel: `src/lib/stores/index.ts` — explicitly named exports (not `export *`)
- Svelte store Maps need `new Map(map)` on update to trigger reactivity
- Chat store wires gateway.on('agent') to stream manager's handleEvent in initChatListeners()
- Optimistic inserts use temp IDs (`temp-{timestamp}-{counter}`), replaced after server ack
- For arrays inside a Map store, spread into new array `[...list]` to trigger Svelte reactivity
- activeRun derived store uses polling (setInterval 200ms) since stream manager is not a store
- Chat components live in `src/lib/components/chat/` directory
- Time utilities live in `src/lib/utils/time.ts`
- ESLint `svelte/no-reactive-functions` disallows `$: fn = (x) => ...` — use plain `function` declarations instead
- For reactive timestamps, pass a `now` variable to formatting functions so Svelte detects the dependency

---

## 2026-02-08 - US-017
- Extended `src/lib/gateway/types.ts` with all Phase 2a chat and session types
- Added: MessageRole, ThinkingBlock, ToolCall, ChatMessage, ChatSendParams, ChatSendAck, ChatHistoryParams, ChatHistoryResponse, ChatAbortParams, ChatInjectParams, Session, SessionListParams, SessionListResponse, SessionPatchParams, AgentRunState, AgentRunStatus, ToolCallStatus
- Files changed: `src/lib/gateway/types.ts`
- **Learnings for future iterations:**
  - Existing AgentEvent types already have sessionKey/runId — no need to duplicate in chat types
  - SessionListParams mirrors ws-protocol.md: kinds, limit, activeMinutes, messageLimit
  - Idempotency keys are NOT in param types — correlator auto-generates them
  - All types auto-exported through existing barrel export in index.ts
---

## 2026-02-08 - US-018
- Created `src/lib/gateway/stream.ts` with AgentStreamManager class
- Tracks active runs by runId, routes agent events by kind discriminator
- text_delta replaces content (full accumulated text, NOT append)
- Thinking accumulation: creates new ThinkingBlock or appends to last incomplete one
- Tool tracking: tool_start creates pending ToolCall, tool_result matches by toolName (last pending)
- Callbacks: onMessage, onRunComplete, onRunError for chat store integration
- Exported from `src/lib/gateway/index.ts` barrel
- Files changed: `src/lib/gateway/stream.ts` (new), `src/lib/gateway/index.ts`
- **Learnings for future iterations:**
  - Stream manager is stateless regarding gateway — chat store wires gateway.on('agent') to handleEvent
  - sessionRuns map provides O(1) lookup of active run by sessionKey
  - cleanup() removes from all three maps (runs, sessionRuns, messages) after text_end or abort
  - getStreamMessage(runId) allows chat store to read in-progress message for reactive updates
---

## 2026-02-08 - US-019
- Created `src/lib/stores/sessions.ts` with Svelte writable/derived stores for session management
- Added: sessions (Map<string, Session>), activeSessionKey, activeSession (derived)
- Functions: loadSessions(), switchSession(), updateSession(), incrementUnread(), addSession(), removeSession()
- switchSession() auto-resets unread count for the newly active session
- removeSession() clears activeSessionKey if the removed session was active
- Updated `src/lib/stores/index.ts` barrel export with all session exports
- Files changed: `src/lib/stores/sessions.ts` (new), `src/lib/stores/index.ts`
- **Learnings for future iterations:**
  - Session store uses Map<string, Session> keyed by session key for O(1) lookup
  - Svelte store reactivity with Maps requires creating a new Map instance on update (`new Map(map)`)
  - updateSession() takes Omit<SessionPatchParams, 'sessionKey'> for clean API — sessionKey passed separately
  - `get()` from svelte/store used for one-off reads (e.g., checking activeSessionKey in removeSession)
---

## 2026-02-08 - US-020
- Created `src/lib/stores/chat.ts` — central chat store managing messages, streaming, and gateway ops
- Added: messages store (Map<string, ChatMessage[]>), getMessages(), activeRun derived store
- Functions: sendMessage(), loadHistory(), injectMessage(), abortRun(), initChatListeners(), destroyChatListeners()
- sendMessage() does optimistic user message insert with temp ID, replaces after ack
- initChatListeners() wires gateway.on('agent') to stream manager's handleEvent
- onMessage callback updates assistant messages in-place for streaming reactivity
- loadHistory() supports afterSeq param for reconnection gap fill (deduplicates by ID)
- Updated `src/lib/stores/index.ts` barrel with all chat exports
- Files changed: `src/lib/stores/chat.ts` (new), `src/lib/stores/index.ts`
- **Learnings for future iterations:**
  - activeRun uses polling (setInterval 200ms) since AgentStreamManager is a plain class, not a Svelte store
  - Optimistic insert pattern: insert temp message → call gateway → replace temp ID with server ID → stream manager handles ack
  - Array reactivity in Map stores requires both `[...list]` spread and `new Map(map)` for Svelte to detect changes
  - destroyChatListeners() resets stream manager to prevent stale state across route navigations
---

## 2026-02-08 - US-021
- Created `src/lib/components/chat/MessageList.svelte` — renders chat messages with auto-scroll and relative timestamps
- Created `src/lib/utils/time.ts` — formatRelativeTime() and formatFullTimestamp() utilities
- MessageList features: user/assistant/system styling, auto-scroll to bottom on new messages, "Jump to bottom" button when scrolled up, empty state, relative timestamps with full timestamp on hover
- Auto-scroll uses afterUpdate lifecycle + isAtBottom tracking via scroll event
- Relative timestamps refresh every 30s via setInterval, passed as `now` param for Svelte reactivity
- Files changed: `src/lib/components/chat/MessageList.svelte` (new), `src/lib/utils/time.ts` (new)
- **Learnings for future iterations:**
  - ESLint `svelte/no-reactive-functions` disallows `$: fn = (x) => ...` syntax — use plain function declarations
  - ESLint `svelte/no-immutable-reactive-statements` catches `$: void now` — pass reactive vars as function args instead
  - formatRelativeTime accepts optional `now` parameter so Svelte template picks up the dependency for re-renders
  - Chat component directory: `src/lib/components/chat/`
---

## 2026-02-08 - US-022
- Created `src/lib/components/chat/ThinkingBlock.svelte` — displays thinking content with native `<details>` element
- Features: collapsed by default with `bind:open`, "Thinking..." while streaming, "Thought for Xs" when complete
- Reactive duration calculation from `durationMs` or computed from `completedAt - startedAt`
- Styled with Tailwind: muted text, left border, indented content
- Content updates live during streaming via Svelte reactivity on the `thinking` prop
- Files changed: `src/lib/components/chat/ThinkingBlock.svelte` (new)
- **Learnings for future iterations:**
  - `bind:open` on `<details>` preserves collapse state across re-renders automatically
  - `$: isStreaming = !thinking.completedAt` — simple streaming detection from the ThinkingBlock type
  - Duration fallback chain: durationMs → computed from completedAt-startedAt → empty string
  - Component is minimal (~28 lines) — no need for event dispatchers or lifecycle hooks
---

## 2026-02-08 - US-023
- Created `src/lib/components/chat/ToolCallCard.svelte` — displays tool calls with native `<details>` element
- Features: collapsed by default with `bind:open`, tool name + status badge (pending=yellow, complete=green, error=red)
- Expanded view shows formatted JSON for args and result (if available)
- Uses `<pre>` blocks with `font-mono` for JSON display, `overflow-x-auto` for wide content
- Styled with Tailwind: status color badges, monospace JSON, subtle border
- Files changed: `src/lib/components/chat/ToolCallCard.svelte` (new)
- **Learnings for future iterations:**
  - Same pattern as ThinkingBlock: `<details>` + `bind:open` + Tailwind styling
  - `JSON.stringify(value, null, 2)` with try/catch fallback to `String(value)` for safe formatting
  - No `{@html}` needed — `<pre>` blocks handle JSON display without XSS risk
  - Status badge uses ternary chain with `$:` reactive declaration for color/label mapping
---
