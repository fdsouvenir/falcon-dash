{
	"project": "falcon-dash",
	"branchName": "ralph/phase-2a-chat-core",
	"description": "Phase 2a: Chat Core — minimum working chat with streaming responses, thinking blocks, tool calls, session switching, and reconnection gap fill",
	"userStories": [
		{
			"id": "US-017",
			"title": "Chat and session types",
			"description": "Extend src/lib/gateway/types.ts with all chat/session types needed for Phase 2a. Add ChatMessage, ToolCall, ThinkingBlock, chat method params/responses, Session, session method params/responses, and AgentRunState.",
			"acceptanceCriteria": [
				"ChatMessage type: id, sessionKey, role ('user'|'assistant'|'system'|'inject'), content, timestamp, runId?, thinking?, toolCalls?",
				"ToolCall type: toolName, args, result?, status ('pending'|'complete'|'error')",
				"ThinkingBlock type: content, startedAt, completedAt?, durationMs?",
				"ChatSendParams: sessionKey, content, model?, thinkingLevel?",
				"ChatSendAck: runId, status ('started')",
				"ChatHistoryParams: sessionKey, afterSeq?, limit?",
				"ChatHistoryResponse: messages array, hasMore boolean",
				"ChatAbortParams: sessionKey",
				"ChatInjectParams: sessionKey, role, content",
				"Session type: key, displayName, lastMessage?, unreadCount, updatedAt, model?, thinkingLevel?",
				"SessionListParams (empty or with filters) and SessionListResponse: sessions array",
				"SessionPatchParams: sessionKey, displayName?, model?, thinkingLevel?",
				"AgentRunState: runId, sessionKey, status ('running'|'complete'|'error'), startedAt, seq",
				"All types extend existing types.ts (do NOT create new file)",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run test passes"
			],
			"priority": 1,
			"passes": true,
			"notes": "Extend the existing types.ts file — do NOT create a separate types file. Existing AgentEvent types already use 'kind' field and include sessionKey/runId. Idempotency keys are auto-generated by the correlator — do NOT include them in param types. Reference builddocs/ws-protocol.md for exact protocol shapes."
		},
		{
			"id": "US-018",
			"title": "Agent stream manager",
			"description": "Create src/lib/gateway/stream.ts — manages the two-stage chat.send response pattern (ack followed by agent events followed by final response). Tracks active runs by runId, handles text_delta (full accumulated text, NOT incremental), thinking accumulation, and tool tracking.",
			"acceptanceCriteria": [
				"AgentStreamManager class in src/lib/gateway/stream.ts",
				"Tracks active runs by runId in a Map<string, AgentRunState>",
				"handleAck(sessionKey, ack) registers a new active run",
				"handleEvent(event: AgentEvent) routes events by kind to appropriate handler",
				"text_delta handling: REPLACES content (full accumulated text, NOT append)",
				"Thinking accumulation: appends thinking content, tracks duration",
				"tool_start: creates pending ToolCall, tool_result: updates with result and status",
				"Callbacks: onMessage(msg: ChatMessage), onRunComplete(runId), onRunError(runId, error)",
				"abort(sessionKey) marks run as error and cleans up",
				"reset() clears all active runs",
				"getActiveRun(sessionKey) returns current run or undefined",
				"Tracks latest seq on AgentRunState for reconnection gap detection",
				"Exported from src/lib/gateway/index.ts barrel",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run test passes"
			],
			"priority": 2,
			"passes": true,
			"notes": "CRITICAL: text_delta.content contains the FULL accumulated text, not an incremental diff. Replace the assistant message content entirely on each text_delta — do NOT concatenate. The stream manager does NOT own gateway subscription — the chat store will wire gateway.on('agent', ...) to this. Switch on event.kind (discriminated union). Track latest seq on AgentRunState for reconnection gap detection."
		},
		{
			"id": "US-019",
			"title": "Session store",
			"description": "Create src/lib/stores/sessions.ts — Svelte writable stores for session management. Provides session list, active session switching, and gateway integration for sessions.list and sessions.patch.",
			"acceptanceCriteria": [
				"sessions writable store: Map<string, Session> or Session[]",
				"activeSessionKey writable store",
				"activeSession derived store from sessions + activeSessionKey",
				"loadSessions() calls gateway.call('sessions.list') and populates store",
				"switchSession(key) updates activeSessionKey",
				"updateSession(key, patch) calls gateway.call('sessions.patch') and updates local store",
				"incrementUnread(key) increments unreadCount for a session",
				"addSession(session) adds a session to the store",
				"removeSession(key) removes a session from the store",
				"Exported from src/lib/stores/index.ts barrel",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run test passes"
			],
			"priority": 3,
			"passes": true,
			"notes": "Wire to gateway via gateway.call('sessions.list') and gateway.call('sessions.patch'). The session store is consumed by the sidebar for session switching and by the chat route for active session context."
		},
		{
			"id": "US-020",
			"title": "Chat store",
			"description": "Create src/lib/stores/chat.ts — the central nervous system of chat. Manages message storage per session, wires to AgentStreamManager for streaming, and provides send/history/inject/abort operations.",
			"acceptanceCriteria": [
				"messages store: Map<string, ChatMessage[]> keyed by sessionKey",
				"getMessages(sessionKey) returns a derived readable store for that session's messages",
				"activeRun derived store from AgentStreamManager + activeSessionKey",
				"sendMessage(content) does optimistic user message insert, then gateway.call('chat.send'), handles ack via stream manager",
				"loadHistory(sessionKey, afterSeq?) calls gateway.call('chat.history') and populates messages",
				"injectMessage(sessionKey, role, content) calls gateway.call('chat.inject')",
				"abortRun() calls gateway.call('chat.abort') for active session",
				"initChatListeners() wires gateway agent events to stream manager",
				"destroyChatListeners() cleans up event listeners",
				"AgentStreamManager.onMessage callback updates assistant message in-place for streaming effect",
				"Exported from src/lib/stores/index.ts barrel",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run test passes"
			],
			"priority": 4,
			"passes": true,
			"notes": "This is the central nervous system of chat. The onMessage callback from AgentStreamManager should update the assistant message in the messages store in-place so Svelte reactivity picks up the streaming text. Optimistic user messages get a temporary ID, replaced by the real ID from the server ack."
		},
		{
			"id": "US-021",
			"title": "Message list component",
			"description": "Create src/lib/components/chat/MessageList.svelte and src/lib/utils/time.ts — renders the message list with plain text (no markdown, deferred to Phase 2b), auto-scroll, and relative timestamps.",
			"acceptanceCriteria": [
				"MessageList.svelte in src/lib/components/chat/",
				"Accepts messages array as prop (export let messages)",
				"Plain text rendering only (no markdown — Phase 2b)",
				"User vs assistant message styling: different background colors and alignment",
				"Auto-scroll to bottom on new messages (unless user has scrolled up)",
				"'Jump to bottom' button appears when scrolled up",
				"Relative timestamps (e.g., '2m ago') with full timestamp on hover via title attribute",
				"time.ts utility with formatRelativeTime() and formatFullTimestamp()",
				"Empty state: friendly message when no messages",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run test passes"
			],
			"priority": 5,
			"passes": true,
			"notes": "Use Svelte 4 syntax: export let messages, on:scroll, createEventDispatcher if needed. Auto-scroll logic: track whether user has manually scrolled up, and only auto-scroll when at the bottom. Use afterUpdate lifecycle for scroll behavior."
		},
		{
			"id": "US-022",
			"title": "Thinking block component",
			"description": "Create src/lib/components/chat/ThinkingBlock.svelte — displays thinking content using native <details> element, collapsed by default, with live content updates during streaming.",
			"acceptanceCriteria": [
				"ThinkingBlock.svelte in src/lib/components/chat/",
				"Accepts thinking prop (ThinkingBlock type)",
				"Uses native <details> element (collapsed by default)",
				"Summary shows 'Thinking...' while streaming (no completedAt), 'Thought for Xs' when complete",
				"Content updates live during streaming",
				"Collapse state preserved across re-renders (bind:open)",
				"Styled with Tailwind: muted text, indented, subtle border",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run test passes"
			],
			"priority": 6,
			"passes": true,
			"notes": "Use Svelte 4 syntax: export let thinking, bind:open. The thinking prop will update reactively as the stream manager accumulates thinking content. Use $: reactive declarations for computed values like duration display."
		},
		{
			"id": "US-023",
			"title": "Tool call card component",
			"description": "Create src/lib/components/chat/ToolCallCard.svelte — displays a tool call using native <details> element with tool name, status indicator, and formatted args/result.",
			"acceptanceCriteria": [
				"ToolCallCard.svelte in src/lib/components/chat/",
				"Accepts toolCall prop (ToolCall type)",
				"Uses native <details> element (collapsed by default)",
				"Summary: tool name + status badge (pending=yellow, complete=green, error=red)",
				"Expanded view: formatted args as JSON",
				"Expanded view: formatted result as JSON (if available)",
				"Styled with Tailwind: monospace for JSON, status colors",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run test passes"
			],
			"priority": 7,
			"passes": true,
			"notes": "Use Svelte 4 syntax: export let toolCall. JSON.stringify(args, null, 2) for formatted display. Use {@html} with eslint-disable comment if needed for syntax highlighting, otherwise use <pre><code> blocks."
		},
		{
			"id": "US-024",
			"title": "Message composer",
			"description": "Create src/lib/components/chat/MessageComposer.svelte — textarea with auto-resize, Enter to send, Shift+Enter for newline, disabled state during agent runs, and abort button.",
			"acceptanceCriteria": [
				"MessageComposer.svelte in src/lib/components/chat/",
				"Textarea with auto-resize (grows with content, max height)",
				"ENTER sends message (dispatches 'send' event with content)",
				"SHIFT+ENTER inserts newline",
				"Disabled when isRunning prop is true",
				"Abort button visible when isRunning is true (dispatches 'abort' event)",
				"Uses createEventDispatcher for send and abort events",
				"Clears textarea after send",
				"Focus management: auto-focus on mount",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run test passes"
			],
			"priority": 8,
			"passes": true,
			"notes": "Use Svelte 4 syntax: export let isRunning = false, on:keydown, createEventDispatcher. Auto-resize: set textarea height to scrollHeight on input. Dispatch events, don't call store functions directly — the parent route wires events to the chat store."
		},
		{
			"id": "US-025",
			"title": "Session switcher in sidebar",
			"description": "Modify src/lib/components/Sidebar.svelte to replace the 'No channels yet' placeholder with a live session list from the sessions store, with active highlighting, unread badges, and a New Chat button.",
			"acceptanceCriteria": [
				"Replace 'No channels yet' placeholder in Channels section with live session list",
				"Each session shows: display name, unread badge (if > 0), active highlight",
				"Click on session switches active session (calls switchSession) and navigates to /chat",
				"'New Chat' button in Channels section header",
				"Import sessions, activeSessionKey from $lib/stores/sessions",
				"Active session highlighted with different background color",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run test passes"
			],
			"priority": 9,
			"passes": true,
			"notes": "The Sidebar.svelte already exists from Phase 1 with a placeholder 'No channels yet' text (around line 33). Replace that placeholder with the live session list. Use Svelte 4 syntax: on:click, $sessions store subscription. Use goto() from $app/navigation for routing to /chat."
		},
		{
			"id": "US-026",
			"title": "Chat route and gateway integration",
			"description": "Create src/routes/chat/+page.svelte and +page.ts — the main chat page that composes MessageList, ThinkingBlock, ToolCallCard, and MessageComposer. Wires everything to the chat and session stores. Full end-to-end: send message, see streaming response with thinking + tools, abort, switch sessions.",
			"acceptanceCriteria": [
				"src/routes/chat/+page.svelte created",
				"src/routes/chat/+page.ts with ssr: false",
				"onMount: initChatListeners(), loadSessions(), loadHistory() for active session",
				"onDestroy: destroyChatListeners()",
				"Composes: MessageList, ThinkingBlock (inline in messages), ToolCallCard (inline in messages), MessageComposer",
				"Wires send event to chat store sendMessage()",
				"Wires abort event to chat store abortRun()",
				"Reactive: switches message view when activeSessionKey changes",
				"Shows 'Not connected' state when connectionState is not READY",
				"Shows empty state when no active session",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run build succeeds",
				"npm run test passes"
			],
			"priority": 10,
			"passes": false,
			"notes": "This is the integration story — it wires all the pieces together. Use Svelte 4 syntax throughout: on:send, on:abort, $activeSessionKey, $connectionState. The +page.ts must have export const ssr = false (chat needs browser APIs). ThinkingBlock and ToolCallCard render inline within assistant messages, not as separate list items."
		},
		{
			"id": "US-027",
			"title": "Reconnection gap fill",
			"description": "Extend src/lib/stores/chat.ts to detect reconnection (RECONNECTING to READY transition), reload history since last known seq, deduplicate messages, and recover any runs that completed during disconnect.",
			"acceptanceCriteria": [
				"Detects RECONNECTING → READY transition via connectionState store subscription",
				"On reconnect: calls loadHistory(activeSessionKey, lastKnownSeq) to fill gap",
				"Deduplicates messages by ID (no duplicate entries after reconnect)",
				"Recovers active runs that completed during disconnect",
				"Refreshes session list on reconnect (calls loadSessions())",
				"Increments unread count for non-active sessions that received messages during disconnect",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run test passes"
			],
			"priority": 11,
			"passes": false,
			"notes": "Subscribe to connectionState store. Track lastKnownSeq from the most recent EventFrame.seq seen before disconnect. On READY after RECONNECTING, fetch history with afterSeq to get only new messages. Deduplicate by message ID before merging into the messages store."
		}
	]
}
