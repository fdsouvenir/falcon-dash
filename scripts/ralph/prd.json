{
	"project": "falcon-dash",
	"branchName": "ralph/phase-2b-chat-enhanced",
	"description": "Phase 2b: Chat Enhanced — rich markdown rendering pipeline, syntax-highlighted code blocks, KaTeX math, Mermaid diagrams, admonition blocks, message actions, chat header with model indicators, channel settings, and slash command framework with core commands",
	"userStories": [
		{
			"id": "US-028",
			"title": "Markdown rendering pipeline",
			"description": "Create src/lib/utils/markdown/ module with unified/remark/rehype pipeline. renderMarkdown(text) returns sanitized HTML string. RenderedContent.svelte wraps {@html} output with 50ms debounced re-render during streaming.",
			"acceptanceCriteria": [
				"src/lib/utils/markdown/pipeline.ts exports renderMarkdown(text: string): string",
				"Pipeline: remarkParse → remarkGfm → remarkRehype → rehypeSanitize(customSchema) → rehypeStringify",
				"src/lib/utils/markdown/sanitize-schema.ts exports custom schema allowing class on code/pre/div/span, data-* on div",
				"src/lib/utils/markdown/index.ts barrel exports",
				"src/lib/components/chat/RenderedContent.svelte with content:string and isStreaming:boolean props",
				"RenderedContent uses {@html} with eslint-disable svelte/no-at-html-tags comment",
				"50ms debounce during streaming (isStreaming=true), immediate render when not streaming",
				"Clear debounce timer on component destroy",
				"src/routes/chat/+page.svelte: assistant messages use RenderedContent instead of plain text div (line ~172)",
				"User messages remain plain text (whitespace-pre-wrap)",
				"Prose styling via hand-written Tailwind :global() classes in RenderedContent (dark slate theme)",
				"Do NOT use @tailwindcss/typography plugin",
				"Do NOT enable allowDangerousHtml on remarkRehype",
				"Dependencies installed: unified, remark-parse, remark-gfm, remark-rehype, rehype-sanitize, rehype-stringify",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run build succeeds",
				"npm run test passes"
			],
			"priority": 1,
			"passes": true,
			"notes": "unified ecosystem is ESM-only (Vite handles fine). Incomplete markdown during streaming (unclosed fences) is acceptable — final render on text_end corrects it. The sanitize schema is in its own file because later stories (US-029, US-030, US-031) will extend it with additional allowlisted elements."
		},
		{
			"id": "US-029",
			"title": "Code blocks with Shiki and copy button",
			"description": "Integrate Shiki syntax highlighting into the markdown pipeline. Singleton HighlighterManager with async init and sync highlight. Custom rehype plugin injects copy button HTML and language label. Svelte action attaches copy event listeners post-DOM.",
			"acceptanceCriteria": [
				"src/lib/utils/markdown/highlighter.ts exports HighlighterManager singleton class",
				"HighlighterManager.init() creates highlighter with pre-loaded languages: javascript, typescript, python, bash, json, html, css, svelte, go, rust, java, sql, yaml, diff, markdown, jsx, tsx",
				"HighlighterManager.highlight(code, lang) is sync after init, returns HTML string",
				"HighlighterManager.isReady() returns boolean",
				"Custom rehype plugin in pipeline.ts (or separate file) that uses HighlighterManager for code blocks",
				"Plugin injects copy button HTML and language label into code block output",
				"Before highlighter ready: fallback to unstyled <pre><code> with language-xxx class",
				"src/lib/actions/codeBlockActions.ts exports Svelte action attaching click handlers to copy buttons",
				"Copy button extracts <code> text content only (not button HTML)",
				"RenderedContent.svelte calls HighlighterManager.init() in onMount, re-renders when ready",
				"RenderedContent.svelte applies use:codeBlockActions on the rendered HTML container",
				"Theme: github-dark or one-dark-pro",
				"sanitize-schema.ts extended: allow style on span inside code blocks (Shiki inline token colors)",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run build succeeds",
				"npm run test passes"
			],
			"priority": 2,
			"passes": true,
			"notes": "CRITICAL: rehype-sanitize strips style attributes by default — MUST allowlist style on span elements for Shiki token colors. Use Shiki's codeToHtml() which is synchronous after createHighlighter() resolves. Do NOT use rehype-shiki — write a custom rehype plugin for control over copy button injection. The Svelte action pattern (use:codeBlockActions) is the correct way to attach event listeners to {@html} rendered content."
		},
		{
			"id": "US-030",
			"title": "KaTeX math rendering",
			"description": "Add remark-math and rehype-katex to the markdown pipeline for LaTeX math rendering. KaTeX CSS via CDN link in app.html. Extend sanitize schema for KaTeX elements.",
			"acceptanceCriteria": [
				"remark-math added to pipeline (before remarkRehype)",
				"rehype-katex added to pipeline (after remarkRehype, BEFORE rehype-sanitize)",
				"Pipeline order: remarkParse → remarkGfm → remarkMath → remarkRehype → rehypeKatex → [shiki plugin] → rehypeSanitize → rehypeStringify",
				"KaTeX CSS loaded via <link> in app.html, version-matched to npm katex package",
				"throwOnError: false — invalid LaTeX shows raw source with red indicator",
				"sanitize-schema.ts extended: allow MathML elements (math, semantics, mrow, mi, mo, mn, msup, msub, mfrac, msqrt, mover, munder, mtext, annotation, mspace, mtable, mtr, mtd, menclose)",
				"sanitize-schema.ts extended: allow style on KaTeX elements, KaTeX class names",
				"Dependencies installed: remark-math, rehype-katex, katex",
				"Inline math ($...$) and display math ($$...$$) both render correctly",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run build succeeds",
				"npm run test passes"
			],
			"priority": 3,
			"passes": true,
			"notes": "Pipeline order is critical: remark-math runs in remark phase (mdast), rehype-katex runs in rehype phase (hast) BEFORE sanitize. Single $ for currency won't conflict — remark-math requires no space after opening $. KaTeX generates hundreds of spans for complex equations — this is normal. rehype-katex MUST run before rehype-sanitize or the generated KaTeX HTML will be stripped."
		},
		{
			"id": "US-031",
			"title": "Mermaid diagram rendering",
			"description": "Add Mermaid diagram support via post-pipeline rendering. Rehype plugin replaces ```mermaid code blocks with placeholder divs. Svelte action dynamically imports mermaid and renders SVG.",
			"acceptanceCriteria": [
				"src/lib/utils/markdown/mermaid-plugin.ts exports rehype plugin that replaces ```mermaid blocks with <div class=\"mermaid-placeholder\" data-mermaid-source=\"...\">",
				"Mermaid source is base64-encoded in data-mermaid-source attribute",
				"src/lib/actions/mermaidAction.ts exports Svelte action that finds .mermaid-placeholder divs and renders them",
				"Mermaid dynamically imported on first use (not bundled upfront)",
				"Uses mermaid.render() (returns SVG string) not mermaid.init() (DOM mutation)",
				"mermaid.initialize() called once before first render with dark theme config",
				"Each diagram gets unique ID (e.g., mermaid-{timestamp}-{counter}) to avoid conflicts",
				"Error fallback: show raw source in code block with error message above",
				"Errors caught per-diagram (one broken diagram doesn't block others)",
				"During streaming, incomplete mermaid blocks stay as regular code blocks",
				"sanitize-schema.ts extended: allow SVG elements (svg, g, rect, path, text, circle, line, polyline, polygon, ellipse, foreignObject, tspan, marker, defs, use, style)",
				"RenderedContent.svelte applies use:mermaidAction on the rendered HTML container",
				"Dependency installed: mermaid",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run build succeeds",
				"npm run test passes"
			],
			"priority": 4,
			"passes": true,
			"notes": "Mermaid requires DOM access — cannot run in the rehype pipeline. The pattern is: rehype plugin creates placeholder divs → Svelte action finds placeholders after DOM update → mermaid.render() returns SVG string → insert SVG into placeholder div. Dynamic import keeps the mermaid bundle out of initial load. The Svelte action fires on mount and whenever the DOM content changes."
		},
		{
			"id": "US-032",
			"title": "Admonition blocks",
			"description": "Add GitHub-style blockquote admonitions (> [!NOTE], > [!TIP], > [!WARNING], > [!CAUTION], > [!IMPORTANT]) via remark plugin.",
			"acceptanceCriteria": [
				"src/lib/utils/markdown/admonition-plugin.ts exports remark plugin or uses remark-github-blockquote-admonitions",
				"Plugin runs in remark phase (BEFORE remarkRehype)",
				"Supported types: NOTE (blue), TIP (green), WARNING (amber), CAUTION (red), IMPORTANT (purple)",
				"Each admonition has SVG icon + type label + content",
				"Admonition content preserves nested markdown (code, math, etc.)",
				"Styling via :global() Tailwind classes in RenderedContent.svelte",
				"Does not conflict with remark-gfm blockquote handling",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run build succeeds",
				"npm run test passes"
			],
			"priority": 5,
			"passes": false,
			"notes": "Remark plugins run BEFORE remarkRehype (mdast transform). Check if remark-github-blockquote-admonitions package exists and is compatible — if not, write a custom remark plugin that transforms blockquotes matching > [!TYPE] pattern into styled div containers."
		},
		{
			"id": "US-033",
			"title": "Message action bar",
			"description": "Create MessageActionBar.svelte — copy response button on assistant messages, visible on hover. Copies raw markdown (message.content), not rendered HTML.",
			"acceptanceCriteria": [
				"src/lib/components/chat/MessageActionBar.svelte created",
				"Accepts content:string prop (raw markdown content to copy)",
				"Copy button using navigator.clipboard.writeText()",
				"'Copied!' feedback text for 2 seconds after copy",
				"Uses Tailwind group/group-hover for visibility on parent hover",
				"src/routes/chat/+page.svelte: assistant messages wrapped with hover container and MessageActionBar",
				"Only shown on assistant messages that have content",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run build succeeds",
				"npm run test passes"
			],
			"priority": 6,
			"passes": false,
			"notes": "Copies raw markdown (message.content), NOT rendered HTML. The action bar sits outside the message bubble but within a group container so hover on the message reveals it. Future-proof: more actions (reactions, bookmark, edit) can be added to the bar later."
		},
		{
			"id": "US-034",
			"title": "Chat header with model and thinking indicators",
			"description": "Extract the inline session header in +page.svelte to a ChatHeader.svelte component. Add model badge and thinking level indicator. Settings gear dispatches event.",
			"acceptanceCriteria": [
				"src/lib/components/chat/ChatHeader.svelte created",
				"Accepts session prop (Session type or undefined)",
				"Displays session displayName",
				"Model badge: small pill showing model name, 'Default' when no override",
				"Thinking indicator: brain icon, off=muted, on=blue, stream=animated",
				"Settings gear icon that dispatches 'settings' event via createEventDispatcher",
				"src/routes/chat/+page.svelte: inline header replaced with <ChatHeader>",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run build succeeds",
				"npm run test passes"
			],
			"priority": 7,
			"passes": false,
			"notes": "The existing inline header is just a simple h2 in a flex container (around line 137-141 of +page.svelte). Extract it to a component and add the model/thinking indicators. Use Svelte 4: export let session, createEventDispatcher. The parent page will handle the 'settings' event to open the settings panel (US-035)."
		},
		{
			"id": "US-035",
			"title": "Channel settings panel",
			"description": "Create ChannelSettings.svelte slide-out panel and models.ts store. Panel allows model override, thinking toggle, and session rename. Models fetched from gateway.",
			"acceptanceCriteria": [
				"src/lib/components/chat/ChannelSettings.svelte created",
				"Accepts session prop (Session type) and open:boolean prop",
				"Slide-out panel from right side of chat area",
				"Model dropdown populated from models store (calls gateway 'models.list')",
				"'Default' option in model dropdown means use server default",
				"Thinking level: three-state toggle (off/on/stream)",
				"Session rename: inline text input that calls updateSession(key, { displayName })",
				"All changes applied via sessions.patch through existing updateSession()",
				"Panel closes on Escape, outside click, or session switch",
				"Dispatches 'close' event",
				"src/lib/stores/models.ts exports models store that fetches/caches from gateway 'models.list'",
				"New types in gateway/types.ts: ModelsListResponse, ModelInfo (id, name, provider)",
				"src/routes/chat/+page.svelte: wire ChatHeader settings event to toggle ChannelSettings",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run build succeeds",
				"npm run test passes"
			],
			"priority": 8,
			"passes": false,
			"notes": "The models store calls gateway.call('models.list') once and caches the result. Invalidate on reconnect. The ChannelSettings panel is overlay/slide-out, not a new route. Use Svelte 4 transition:fly for slide animation. Close on Escape via on:keydown handler on window."
		},
		{
			"id": "US-036",
			"title": "Slash command framework",
			"description": "Create slash command registry, CommandPalette autocomplete component, and wire / detection in MessageComposer. Framework only — real commands in US-037.",
			"acceptanceCriteria": [
				"src/lib/chat/commands/registry.ts exports SlashCommand interface and commands array",
				"SlashCommand: { name: string, description: string, usage?: string, execute: (args: string, context: CommandContext) => void | Promise<void> }",
				"CommandContext: { sessionKey: string, sendMessage, abortRun, updateSession, injectMessage, gateway }",
				"src/lib/chat/commands/index.ts barrel export",
				"src/lib/components/chat/CommandPalette.svelte — autocomplete dropdown",
				"CommandPalette: accepts commands array, filter string, dispatches 'select' event with selected command",
				"Simple includes() filter on command name",
				"Arrow keys navigate, Enter selects, Escape closes the palette",
				"Dropdown positioned ABOVE textarea (composer is at bottom of screen)",
				"MessageComposer.svelte modified: detect / prefix, render CommandPalette, intercept Enter for selection",
				"When palette is open, Enter selects command (does NOT send message)",
				"If no match, /text sent as normal message",
				"2-3 placeholder commands for UI testing (e.g., /help, /ping)",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run build succeeds",
				"npm run test passes"
			],
			"priority": 9,
			"passes": false,
			"notes": "This is the framework story — only placeholder commands for UI testing. Real commands come in US-037. The CommandPalette should be a separate component rendered conditionally in MessageComposer when / is detected. CommandContext is constructed in the chat route and passed down."
		},
		{
			"id": "US-037",
			"title": "Core slash commands",
			"description": "Implement 10 slash commands: /new, /stop, /status, /reasoning, /compact, /usage, /verbose, /context, /subagents, /send. Mix of local, remote, and hybrid commands.",
			"acceptanceCriteria": [
				"One file per command in src/lib/chat/commands/: new.ts, stop.ts, status.ts, reasoning.ts, compact.ts, usage.ts, verbose.ts, context.ts, subagents.ts, send.ts",
				"All commands registered in registry.ts commands array",
				"Add localOnly?: boolean to ChatMessage type (excluded from history/gap-fill)",
				"/new: creates new session (navigate to fresh session key or use available method)",
				"/stop: calls abortRun() for active session, inserts local feedback",
				"/status: generates local-only message with session metadata (model, thinking, message count)",
				"/reasoning [off|on|stream]: modifies session thinkingLevel via sessions.patch + local feedback",
				"/compact: calls gateway chat.inject or dedicated method for context compaction",
				"/usage: inserts local-only message showing usage stats, persisted in localStorage",
				"/verbose [on|off]: toggles verbose mode setting, persisted in localStorage",
				"/context: calls gateway to show context window info",
				"/subagents: calls gateway to list active sub-agents",
				"/send [message]: sends a message (useful for messages starting with /)",
				"Error handling: gateway errors shown as local-only system messages",
				"src/lib/stores/usage.ts created if needed for usage tracking",
				"CommandContext properly wired in chat route with all required functions",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run build succeeds",
				"npm run test passes"
			],
			"priority": 10,
			"passes": false,
			"notes": "Local commands (/stop, /status, /usage) execute client-side and insert local-only messages. Remote commands (/compact, /context, /subagents, /send) call gateway methods. Hybrid commands (/new, /reasoning, /verbose) modify session state and give local feedback. Gateway method names may need chat.inject fallback if dedicated methods don't exist. The localOnly flag on ChatMessage prevents these messages from being included in history requests or gap-fill on reconnect."
		}
	]
}
