{
	"project": "falcon-dash",
	"branchName": "ralph/phase-3-files-jobs-passwords",
	"description": "Phase 3: Files + Agent Jobs + Passwords — SvelteKit server routes for workspace filesystem, gateway cron CRUD with heartbeat config, and encrypted password vault via keepassxc-cli",
	"userStories": [
		{
			"id": "US-038",
			"title": "Workspace file server routes",
			"description": "First +server.ts files in the project. SvelteKit server routes for workspace filesystem access. Creates src/lib/server/workspace.ts with shared utilities (path resolution, hashing, traversal protection) and two route files for directory listing and file CRUD.",
			"acceptanceCriteria": [
				"src/lib/server/workspace.ts exports getWorkspacePath(), computeHash(content), validatePath(requestedPath, workspaceRoot)",
				"getWorkspacePath() reads process.env.OPENCLAW_WORKSPACE, defaults to path.join(os.homedir(), '.openclaw/workspace')",
				"computeHash(content) returns SHA-256 hex digest of the content string",
				"validatePath(requestedPath, workspaceRoot) resolves the joined path and rejects if outside workspace root (throws 403)",
				"Paths containing .secrets return 403 Forbidden",
				"src/routes/api/workspace/files/+server.ts: GET handler lists directory contents",
				"GET /api/workspace/files?dir=memory returns { files: [{ name, isDirectory, size, mtime }] }",
				"src/routes/api/workspace/files/[...path]/+server.ts: GET, PUT, DELETE, PATCH handlers",
				"GET /api/workspace/files/SOUL.md returns { content, hash, mtime }",
				"PUT /api/workspace/files/SOUL.md with body { content, baseHash } returns { hash, ok } or 409 conflict",
				"DELETE /api/workspace/files/SOUL.md returns { ok } or 404",
				"PATCH /api/workspace/files/SOUL.md with body { newName } returns { ok } or 409",
				"Uses Node.js fs/promises and crypto (server-only imports)",
				"Uses json() and error() from @sveltejs/kit",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run build succeeds",
				"npm run test passes"
			],
			"priority": 1,
			"passes": true,
			"notes": "First +server.ts files in the project. These establish the pattern for all future server routes. The workspace.ts module provides shared utilities (path resolution, hashing, validation) used by both the workspace file routes and later by the password vault routes. SvelteKit auto-excludes src/lib/server/ from client bundles. The [...path] catch-all route receives the path as a single string in params.path."
		},
		{
			"id": "US-039",
			"title": "File types and store",
			"description": "TypeScript types for workspace files and Svelte stores wrapping fetch calls to the workspace API. This is the first fetch-based store (as opposed to gateway.call-based stores).",
			"acceptanceCriteria": [
				"src/lib/types/files.ts exports WorkspaceFile (name, isDirectory, size, mtime), FileContent (content, hash, mtime), FileWriteRequest (content, baseHash), FileWriteResponse (hash, ok)",
				"src/lib/types/index.ts barrel exports all types from files.ts",
				"src/lib/stores/files.ts exports files (writable WorkspaceFile[]), currentPath (writable string), activeFile (writable FileContent | null), activeFileName (writable string)",
				"loadFiles(dir?) fetches GET /api/workspace/files?dir= and updates files store",
				"loadFile(path) fetches GET /api/workspace/files/{path} and updates activeFile/activeFileName stores",
				"saveFile(path, content, baseHash) fetches PUT, returns response, handles 409 conflict",
				"deleteFile(path) fetches DELETE",
				"createFile(path, content) fetches PUT with empty baseHash",
				"renameFile(path, newName) fetches PATCH",
				"navigateTo(dir) updates currentPath and calls loadFiles",
				"src/lib/stores/index.ts updated with barrel exports for file stores",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run build succeeds",
				"npm run test passes"
			],
			"priority": 2,
			"passes": true,
			"notes": "Fetch-based stores (unlike gateway stores that use gateway.call()). These stores use standard fetch() to call the SvelteKit API routes. Error handling should throw or return error info the UI can display. The activeFile store holds the currently viewed/edited file content."
		},
		{
			"id": "US-040",
			"title": "Files route and browser UI",
			"description": "Create the /files route with a two-pane layout: file browser (left) and preview area (right). Breadcrumb navigation, sortable columns, click to navigate folders and select files.",
			"acceptanceCriteria": [
				"src/routes/files/+page.ts exports ssr = false",
				"src/routes/files/+page.svelte created with two-pane layout",
				"Breadcrumb navigation at top showing current path (e.g., Home / memory / subfolder)",
				"Each breadcrumb segment is clickable, navigates to that directory",
				"File list with columns: icon (folder/file), name, modified (relative time via formatRelativeTime), size (humanized via formatFileSize)",
				"Click folder navigates into it, click file loads preview",
				"Column headers clickable for sorting by name, modified, size",
				"src/lib/utils/format.ts exports formatFileSize(bytes) returning human-readable string (B, KB, MB, GB)",
				"Active file highlighted in list",
				"Empty state when directory is empty",
				"Loading state while fetching",
				"Error state with retry button",
				"Loads files on mount (root directory)",
				"Responsive: stacked on mobile, side-by-side on desktop",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run build succeeds",
				"npm run test passes"
			],
			"priority": 3,
			"passes": true,
			"notes": "Uses stores from US-039. The preview pane (right side) shows placeholder text when no file is selected — actual preview/editor components come in US-041. formatFileSize goes in src/lib/utils/format.ts (new file or extend existing). formatRelativeTime already exists in src/lib/utils/time.ts."
		},
		{
			"id": "US-041",
			"title": "File preview and editor",
			"description": "Components for viewing and editing files in the files route. Preview detects file type and renders accordingly (markdown, code, plain text). Editor provides a textarea with save/cancel and dirty state tracking.",
			"acceptanceCriteria": [
				"src/lib/components/files/FilePreview.svelte renders by extension",
				".md files rendered via RenderedContent.svelte (reuse from Phase 2b)",
				"Code files rendered via HighlighterManager (reuse from Phase 2b)",
				"Plain text files rendered as pre with monospace font",
				"Props: content (string), filename (string)",
				"File extension to Shiki language mapping function",
				"src/lib/components/files/FileEditor.svelte provides textarea editing",
				"FileEditor props: content (string), filename (string)",
				"FileEditor dispatches save event with { content } payload",
				"FileEditor dispatches cancel event",
				"Dirty state tracking (warns about unsaved changes)",
				"Hash-based save: passes baseHash from activeFile, handles 409 conflict with user-facing message",
				"Edit/Preview toggle button in the files route",
				"src/routes/files/+page.svelte updated to show FilePreview for selected file, with edit button switching to FileEditor",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run build succeeds",
				"npm run test passes"
			],
			"priority": 4,
			"passes": true,
			"notes": "Reuses RenderedContent.svelte and HighlighterManager from Phase 2b chat module. Needs a mapping from file extensions to Shiki language names (e.g., .ts → typescript, .py → python, .md → markdown). FilePreview will also be reused by the Agent Jobs module (US-045) for rendering HEARTBEAT.md. FileEditor similarly reused."
		},
		{
			"id": "US-042",
			"title": "File create, rename, delete",
			"description": "Toolbar with create actions and inline rename. ConfirmDialog reusable modal for destructive operations across all three modules.",
			"acceptanceCriteria": [
				"src/lib/components/files/FileActions.svelte toolbar with New File and New Folder buttons",
				"New File: prompts for filename, calls createFile(currentPath/name, '')",
				"New Folder: prompts for folder name, creates directory",
				"src/lib/components/files/ConfirmDialog.svelte reusable confirmation modal",
				"ConfirmDialog props: title (string), message (string), confirmLabel (string, default 'Confirm'), open (boolean)",
				"ConfirmDialog dispatches confirm and cancel events",
				"ConfirmDialog has backdrop overlay, focus trap basics, Escape to cancel",
				"Inline rename: double-click file name to enter edit mode, Enter to save, Escape to cancel",
				"Delete: button on each file row, requires ConfirmDialog confirmation",
				"All destructive operations (delete, rename overwrite) use ConfirmDialog",
				"ConfirmDialog designed for reuse by Agent Jobs (US-046) and Passwords (US-050) modules",
				"src/routes/files/+page.svelte updated with FileActions toolbar and inline rename/delete",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run build succeeds",
				"npm run test passes"
			],
			"priority": 5,
			"passes": true,
			"notes": "ConfirmDialog is the first reusable modal component — it will be imported by cron job delete (US-046) and password entry delete (US-050). Keep it generic with slot or message prop. FileActions toolbar sits above the file list. Inline rename uses a text input that replaces the file name span on double-click."
		},
		{
			"id": "US-043",
			"title": "Cron job types and store",
			"description": "Types and store for cron job management via gateway WebSocket methods (cron.*). Real-time updates via event:cron listener pattern.",
			"acceptanceCriteria": [
				"CronJob type in src/lib/gateway/types.ts: id, name, schedule, scheduleType (CronScheduleType), enabled, nextRun, lastRun, payload (CronJobPayload)",
				"CronScheduleType type: 'cron' | 'interval' | 'oneshot'",
				"CronJobPayload type: type, prompt, sessionKey?",
				"CronRun type: id, jobId, startedAt, completedAt, status ('success' | 'error' | 'running'), output",
				"CronListResponse type: { jobs: CronJob[] }",
				"CronRunsResponse type: { runs: CronRun[] }",
				"CronAddParams type: name, schedule, scheduleType, payload, enabled?",
				"CronEditParams type: jobId, name?, schedule?, scheduleType?, payload?, enabled?",
				"src/lib/stores/cron.ts exports cronJobs (writable CronJob[]), cronRuns (writable CronRun[])",
				"loadCronJobs() calls gateway.call('cron.list')",
				"addCronJob(params) calls gateway.call('cron.add', params)",
				"editCronJob(params) calls gateway.call('cron.edit', params)",
				"removeCronJob(jobId) calls gateway.call('cron.rm', { jobId })",
				"enableCronJob(jobId) / disableCronJob(jobId) calls gateway.call('cron.enable'/'cron.disable')",
				"runCronJob(jobId) calls gateway.call('cron.run', { jobId })",
				"loadCronRuns(jobId) calls gateway.call('cron.runs', { jobId })",
				"initCronListeners() / destroyCronListeners() for event:cron real-time updates",
				"src/lib/stores/index.ts updated with cron store exports",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run build succeeds",
				"npm run test passes"
			],
			"priority": 6,
			"passes": true,
			"notes": "Gateway-based store pattern (uses gateway.call(), not fetch). Follow the same listener init/destroy pattern used by initChatListeners/destroyChatListeners in src/lib/stores/chat.ts. The event:cron updates should add/update/remove jobs in the cronJobs store in real-time. Import gateway from $lib/gateway."
		},
		{
			"id": "US-044",
			"title": "Heartbeat config store",
			"description": "Store that bridges gateway config (heartbeat settings via config.get/config.patch) with workspace file API (HEARTBEAT.md content). First hybrid store combining both data sources.",
			"acceptanceCriteria": [
				"HeartbeatConfig type in src/lib/gateway/types.ts: enabled (boolean), intervalMinutes (number), lastRun? (number), status? (string)",
				"GatewayConfigResponse type: { payload: Record<string, unknown>, hash: string }",
				"src/lib/stores/heartbeat.ts exports heartbeatConfig (writable HeartbeatConfig), heartbeatFileContent (writable string), heartbeatFileHash (writable string)",
				"loadHeartbeatConfig() calls gateway.call('config.get', { key: 'agents.defaults.heartbeat' })",
				"updateHeartbeatConfig(patch) calls gateway.call('config.patch', { key: 'agents.defaults.heartbeat', ...patch })",
				"loadHeartbeatFile() fetches GET /api/workspace/files/HEARTBEAT.md",
				"saveHeartbeatFile(content, baseHash) fetches PUT /api/workspace/files/HEARTBEAT.md",
				"src/lib/stores/index.ts updated with heartbeat store exports",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run build succeeds",
				"npm run test passes"
			],
			"priority": 7,
			"passes": true,
			"notes": "Hybrid store: heartbeat settings come from gateway config.get/config.patch, but HEARTBEAT.md content comes from the workspace file API (fetch-based, using routes from US-038). This is the first store that bridges both data sources."
		},
		{
			"id": "US-045",
			"title": "Agent Jobs route with heartbeat tab",
			"description": "Create the /jobs route with two tabs: Heartbeat (default) and Cron Jobs. Heartbeat tab shows config status and HEARTBEAT.md with edit capability, reusing FilePreview/FileEditor from the Files module.",
			"acceptanceCriteria": [
				"src/routes/jobs/+page.ts exports ssr = false",
				"src/routes/jobs/+page.svelte created with tab layout",
				"Two tabs: Heartbeat (default active), Cron Jobs",
				"Tab switching preserves state (no reload on switch back)",
				"Heartbeat tab: status card showing enabled/paused, interval minutes, last run time",
				"Heartbeat tab: toggle button to enable/disable heartbeat",
				"Heartbeat tab: interval input to change heartbeat interval",
				"Heartbeat tab: HEARTBEAT.md content rendered via FilePreview (reuse from US-041)",
				"Heartbeat tab: edit button switches HEARTBEAT.md to FileEditor (reuse from US-041)",
				"Heartbeat tab: save HEARTBEAT.md with hash-based concurrency",
				"Loads heartbeat config and file on mount",
				"Cron Jobs tab content is placeholder (implemented in US-046)",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run build succeeds",
				"npm run test passes"
			],
			"priority": 8,
			"passes": true,
			"notes": "Reuses FilePreview and FileEditor from src/lib/components/files/ for rendering HEARTBEAT.md. This demonstrates cross-module component reuse. The tab container should use a simple state variable, not a router."
		},
		{
			"id": "US-046",
			"title": "Cron jobs tab with list and CRUD",
			"description": "Complete the Cron Jobs tab in the jobs route with a table listing all cron jobs and a modal form for creating/editing jobs. Reuses ConfirmDialog for delete confirmation.",
			"acceptanceCriteria": [
				"src/lib/components/jobs/CronJobList.svelte table component",
				"Columns: name, schedule, next run (relative time), last run (relative time), status (enabled/disabled badge), actions (edit, delete, run now)",
				"Empty state message when no cron jobs",
				"src/lib/components/jobs/CronJobForm.svelte modal form for create/edit",
				"Form fields: name (text), schedule type (select: cron/interval/oneshot), schedule value (text), payload prompt (textarea), enabled (checkbox)",
				"Form validates required fields before submit",
				"Edit mode: pre-fills form with existing job data",
				"Create mode: empty form",
				"Dispatches save event with form data, cancel event",
				"Delete confirmation uses ConfirmDialog from US-042",
				"Run Now button triggers runCronJob(jobId)",
				"Real-time updates via event:cron keep list fresh (uses initCronListeners from US-043)",
				"src/routes/jobs/+page.svelte Cron Jobs tab updated with CronJobList",
				"Loads cron jobs when Cron Jobs tab is first selected",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run build succeeds",
				"npm run test passes"
			],
			"priority": 9,
			"passes": false,
			"notes": "Reuses ConfirmDialog from US-042 for delete confirmation. CronJobForm is a modal overlay similar to ChannelSettings pattern. initCronListeners/destroyCronListeners should be called on mount/destroy of the jobs page."
		},
		{
			"id": "US-047",
			"title": "Cron job run history",
			"description": "Component showing execution history for a selected cron job with expandable output rows and auto-polling for active runs.",
			"acceptanceCriteria": [
				"src/lib/components/jobs/CronRunHistory.svelte component",
				"Props: jobId (string)",
				"Table: started at (formatted timestamp), duration (computed from startedAt/completedAt), status badge (success=green, error=red, running=blue), expandable output",
				"Output shown via HTML details/summary element",
				"Loads run history via loadCronRuns(jobId) on mount and when jobId changes",
				"Polls every 30 seconds when a run has status 'running'",
				"Clears poll interval on destroy",
				"Empty state when no run history",
				"CronJobList updated: clicking a job row expands/shows CronRunHistory below",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run build succeeds",
				"npm run test passes"
			],
			"priority": 10,
			"passes": false,
			"notes": "Duration is computed as completedAt - startedAt in seconds/minutes. Running jobs show elapsed time since startedAt. Poll interval should only be active when at least one run has status 'running'. Use setInterval/clearInterval pattern with onDestroy cleanup."
		},
		{
			"id": "US-048",
			"title": "Password vault server routes",
			"description": "Server routes wrapping keepassxc-cli for encrypted password management. PasswordVault singleton with session tokens and idle timeout. Graceful degradation when CLI not installed.",
			"acceptanceCriteria": [
				"src/lib/server/passwords.ts exports PasswordVault singleton class",
				"PasswordVault wraps keepassxc-cli via child_process execFile",
				"Master password piped via stdin (NEVER as CLI argument)",
				"Session token (UUID) cached in memory with 15-minute idle timeout",
				"Vault path defaults to ~/.openclaw/passwords.kdbx",
				"isAvailable() checks if keepassxc-cli is installed (which keepassxc-cli)",
				"unlock(masterPassword) opens vault, returns session token",
				"lock() clears session",
				"isUnlocked() returns boolean",
				"listEntries(group?) returns entry list",
				"getEntry(path) returns full entry with password",
				"createEntry(path, fields) creates new entry",
				"editEntry(path, fields) updates entry",
				"deleteEntry(path) removes entry",
				"initVault(masterPassword) creates new vault file",
				"resetIdleTimer() called on every operation, auto-locks after 15 min",
				"src/routes/api/passwords/+server.ts: GET (availability + list), POST (unlock/lock/init actions)",
				"GET /api/passwords returns { available: boolean, unlocked: boolean, entries?: [...] }",
				"POST /api/passwords with body { action: 'unlock', masterPassword } or { action: 'lock' } or { action: 'init', masterPassword }",
				"src/routes/api/passwords/[...path]/+server.ts: GET (read entry), PUT (create/edit), DELETE",
				"When keepassxc-cli not installed: GET returns { available: false }, mutations return 503",
				"Uses json() and error() from @sveltejs/kit",
				"Session token validated on all operations (401 if expired/invalid)",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run build succeeds",
				"npm run test passes"
			],
			"priority": 11,
			"passes": false,
			"notes": "execFile is used instead of exec to avoid shell injection. Master password is piped via stdin using the child process stdin.write() + stdin.end() pattern — NEVER passed as a CLI argument where it would appear in process listings. The session token is an in-memory UUID that the client must send via X-Vault-Token header. The 15-minute idle timeout auto-locks the vault. Graceful degradation is key: the UI should work even without keepassxc-cli installed, just showing an unavailable state with install instructions."
		},
		{
			"id": "US-049",
			"title": "Password types and store",
			"description": "TypeScript types for password entries and Svelte stores wrapping fetch calls to the password vault API. Session token is memory-only for security.",
			"acceptanceCriteria": [
				"src/lib/types/passwords.ts exports PasswordEntry (title, username, url?, group?, icon?), PasswordEntryFull (extends PasswordEntry with password, notes?, attributes?), VaultStatus ('unavailable' | 'locked' | 'first-run' | 'unlocked'), VaultState (status, entries?)",
				"src/lib/types/index.ts updated with password type exports",
				"src/lib/stores/passwords.ts exports vaultState (writable VaultState), passwordEntries (writable PasswordEntry[]), sessionToken (writable string, memory-only NOT localStorage)",
				"checkVault() fetches GET /api/passwords, updates vaultState and passwordEntries",
				"unlockVault(masterPassword) fetches POST /api/passwords with action 'unlock', stores session token in memory",
				"lockVault() fetches POST /api/passwords with action 'lock', clears session token and entries",
				"initVault(masterPassword) fetches POST /api/passwords with action 'init'",
				"getEntry(path) fetches GET /api/passwords/{path} with session token header",
				"createEntry(path, fields) fetches PUT /api/passwords/{path}",
				"editEntry(path, fields) fetches PUT /api/passwords/{path}",
				"deleteEntry(path) fetches DELETE /api/passwords/{path}",
				"All fetch calls include X-Vault-Token header with session token",
				"Session token is memory-only (never persisted to localStorage)",
				"src/lib/stores/index.ts updated with password store exports",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run build succeeds",
				"npm run test passes"
			],
			"priority": 12,
			"passes": false,
			"notes": "Fetch-based stores like the file stores. The session token is deliberately memory-only — page refresh requires re-entering the master password. This is a security feature. All API calls include the X-Vault-Token header for server-side session validation."
		},
		{
			"id": "US-050",
			"title": "Passwords route and vault UI",
			"description": "Create the /passwords route with four states (unavailable, first-run, locked, unlocked). Full entry list, click-to-reveal passwords, copy-to-clipboard with auto-clear, idle timeout auto-lock.",
			"acceptanceCriteria": [
				"src/routes/passwords/+page.ts exports ssr = false",
				"src/routes/passwords/+page.svelte created with four-state UI",
				"Unavailable state: message explaining keepassxc-cli is not installed, install instructions",
				"First-run state: create vault form with master password input (type=password), confirm password, create button",
				"Locked state: unlock form with master password input, unlock button",
				"Unlocked state: entry list with search filter, click to view entry details",
				"Entry list columns: title, username, URL (truncated), group",
				"Click entry to view details in side panel or expanded row",
				"Click-to-reveal password (initially hidden as dots), auto-hides after 30 seconds",
				"Copy-to-clipboard button for username and password, with auto-clear clipboard after 30 seconds",
				"Create new entry form (title, username, password with generate option, URL, notes)",
				"Edit entry (pre-fills form with existing data, password field shows unchanged placeholder)",
				"Delete entry with ConfirmDialog confirmation (reuse from US-042)",
				"Idle timeout auto-lock: after 15 minutes of no interaction, vault locks and user must re-enter password",
				"Checks vault status on mount via checkVault()",
				"npm run format passes",
				"npm run check passes with 0 errors",
				"npm run build succeeds",
				"npm run test passes"
			],
			"priority": 13,
			"passes": false,
			"notes": "Four states managed by vaultState.status from the store. The idle timeout on the client mirrors the server-side timeout — both independently lock after 15 minutes. Click-to-reveal uses a timer that auto-hides after 30 seconds for security. Clipboard auto-clear uses setTimeout to write empty string to clipboard. Reuses ConfirmDialog from US-042 for delete confirmation."
		}
	]
}
