# Ralph Agent Instructions — falcon-dash Phase 2a: Chat Core

You are an autonomous coding agent building **falcon-dash**, a SvelteKit web dashboard for the OpenClaw AI platform. Phase 1 (Core Infrastructure) is complete. You are now implementing **Phase 2a: Chat Core** — the minimum working chat module.

## Project Context

Read the root `CLAUDE.md` at the project root for tech stack, conventions, and folder structure. That file is the source of truth for coding standards.

Reference docs live in `builddocs/`:

- `builddocs/falcon-dash-architecture-v02.md` — full architecture, module specs, data flows
- `builddocs/ws-protocol.md` — WebSocket protocol reference (frames, methods, events)
- `builddocs/pm-spec.md` — project management specification

## What Phase 1 Built

Phase 1 created the core infrastructure you build on:

- **Gateway client layer:** `src/lib/gateway/` — connection, correlator, events, snapshot, auth, client, types
- **Stores:** `src/lib/stores/connection.ts` — connection state bridged to Svelte
- **Components:** `src/lib/components/Sidebar.svelte`, `ConnectionStatus.svelte`
- **Routes:** `/` (connection page), app shell layout
- **Tests:** Playwright smoke test, PWA config

Key files you'll extend:

- `src/lib/gateway/types.ts` — add chat/session types here
- `src/lib/gateway/index.ts` — update barrel exports
- `src/lib/stores/index.ts` — update barrel exports
- `src/lib/components/Sidebar.svelte` — add session list (US-025)

## Your Task

1. Read the PRD at `scripts/ralph/prd.json`
2. Read the progress log at `scripts/ralph/progress.txt` (check Codebase Patterns section first)
3. Check you're on the correct branch from PRD `branchName`. If not, create it from the current branch.
4. Pick the **highest priority** user story where `passes: false`
5. Implement that single user story
6. Run quality checks: `npm run check`, `npm run lint`, `npm run build`, `npm run test`
7. Run `npm run format` before committing (agents never match Prettier config exactly)
8. If checks pass, commit ALL changes with message: `feat: [Story ID] - [Story Title]`
9. Update the PRD (`scripts/ralph/prd.json`) to set `passes: true` for the completed story
10. Append your progress to `scripts/ralph/progress.txt`

## Key Conventions (from root CLAUDE.md)

- **Svelte 4** syntax: use `on:event`, NOT Svelte 5 `onevent` syntax
- **Props:** use `export let propName`, NOT `$props()`
- **Reactivity:** use `$:` declarations, NOT `$derived()` or `$effect()`
- **Events:** use `createEventDispatcher`, NOT callback props
- **Blocks:** use `{#if}`, `{#each}`, `{#await}` template blocks
- **Formatting:** Prettier with tabs, single quotes, no trailing commas
- **TypeScript:** strict mode, no `any` unless absolutely necessary
- **Tailwind CSS 3** for styling
- **Barrel exports** from `index.ts` in each module directory
- `{@html}` requires `<!-- eslint-disable svelte/no-at-html-tags -->` comment
- `EventListener` global type triggers ESLint `no-undef` — use wrapper functions instead of `as EventListener`

## Gateway WS Protocol — Chat Methods

### Existing (Phase 1)

- `connect` — initial handshake, returns hello-ok
- Gateway events: `agent`, `presence`, `health`, `tick`, `shutdown`

### New for Phase 2a

**Request methods (via gateway.call()):**

- `chat.send` — Send a user message. Params: `{ sessionKey, content, model?, thinkingLevel? }`. Returns ack: `{ runId, status: 'started' }`.
- `chat.history` — Fetch message history. Params: `{ sessionKey, afterSeq?, limit? }`. Returns: `{ messages[], hasMore }`.
- `chat.abort` — Abort an active agent run. Params: `{ sessionKey }`.
- `chat.inject` — Inject a system/context message. Params: `{ sessionKey, role, content }`.
- `sessions.list` — List all sessions. Returns: `{ sessions[] }`.
- `sessions.patch` — Update session metadata. Params: `{ sessionKey, displayName?, model?, thinkingLevel? }`.

**Two-stage response pattern for chat.send:**

1. **Ack response** (immediate): `{ runId, status: 'started' }` — confirms the run began
2. **Agent events** (streaming): `agent` EventFrames with `kind` discriminator
3. **Final response** (completion): `{ runId, status: 'ok', summary }` — run finished

**CRITICAL: text_delta contains FULL accumulated text, NOT incremental diffs.**
When you receive a `text_delta` agent event, the `content` field contains the complete text so far. REPLACE the assistant message content — do NOT append/concatenate.

**Agent event routing:**

- Events arrive as EventFrames with `event: 'agent'`
- The payload is an AgentEvent union, discriminated by `kind` field
- Kinds: `thinking`, `tool_start`, `tool_result`, `text_delta`, `text_end`
- Each event includes `sessionKey` and `runId` for routing to the correct stream

**Idempotency keys:**

- Auto-generated by RequestCorrelator for chat.send, chat.inject, chat.abort
- Do NOT include idempotency keys in your param types — the correlator handles this

**EventFrame.seq:**

- Each EventFrame has an optional `seq` number for ordering
- Track the latest seq for reconnection gap detection (US-027)

## Progress Report Format

APPEND to `scripts/ralph/progress.txt` (never replace, always append):

```
## [Date/Time] - [Story ID]
- What was implemented
- Files changed
- **Learnings for future iterations:**
  - Patterns discovered
  - Gotchas encountered
  - Useful context
---
```

## Consolidate Patterns

If you discover a **reusable pattern**, add it to the `## Codebase Patterns` section at the TOP of `scripts/ralph/progress.txt` (create it if it doesn't exist):

```
## Codebase Patterns
- Example: Svelte stores use writable() from svelte/store
- Example: Gateway types are in src/lib/gateway/types.ts
```

Only add patterns that are **general and reusable**, not story-specific details.

## Quality Requirements

- ALL commits must pass: `npm run check` (0 errors), `npm run lint`, `npm run build`, `npm run test`
- Always run `npm run format` before committing
- Do NOT commit broken code
- Keep changes focused and minimal
- Follow existing code patterns

## Stop Condition

After completing ONE user story, STOP IMMEDIATELY. Do NOT proceed to the next story.

Check if ALL stories have `passes: true`. If so, reply with:
<promise>COMPLETE</promise>

Otherwise, end your response. The next iteration will pick up the next story.

IMPORTANT: You must complete exactly ONE story per iteration. After committing and marking
the story as passing, your work for this iteration is done. Stop.

## Important

- Work on ONE story per iteration
- Commit frequently
- Keep CI green
- Read the Codebase Patterns section in progress.txt before starting
- When in doubt, consult `builddocs/` for architecture decisions
