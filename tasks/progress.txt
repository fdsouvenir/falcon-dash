# Ralph Progress Log
Started: Tue Feb 10 01:06:48 AM CST 2026

## Codebase Patterns
- Prettier config: tabs, single quotes, no trailing commas, printWidth 100
- Svelte 5 syntax: use `$props()` not `export let`, use `{@render children()}` not `<slot />`
- TypeScript strict mode enabled in tsconfig.json
- Tailwind CSS v4 with `@import 'tailwindcss'` in app.css (not v3 @tailwind directives)
- ESLint v9 flat config format (eslint.config.js, not .eslintrc)
- Vite dev proxy at `/ws` routes to `ws://127.0.0.1:18789`
- Always run `npm run format` after writing code
- Don't commit `.omc/` directory (local state)
- Gateway connection: client.id must be "openclaw-control-ui", client.mode must be "webchat" (gateway validates)
- Prettier adds semicolons on format — don't write them manually, let Prettier handle it
- Use `.js` extension in TypeScript imports (e.g., `from './types.js'`) for ESM compatibility
- `svelte/no-navigation-without-resolve` ESLint rule: use `<!-- eslint-disable svelte/no-navigation-without-resolve -->` for placeholder routes not yet created
- Svelte 5 children prop type: `{ children }: { children: import('svelte').Snippet }`

---

## 2026-02-10 01:15 CST - US-001
- Scaffolded SvelteKit project with TypeScript strict mode
- Configured Tailwind CSS v4, ESLint v9 flat config, Prettier
- Created directory structure: src/lib/gateway/, src/lib/stores/, src/lib/components/, src/routes/
- Configured vite.config.ts with dev proxy to gateway port 18789
- Files changed: package.json, svelte.config.js, vite.config.ts, tsconfig.json, .prettierrc, .prettierignore, eslint.config.js, src/app.html, src/app.css, src/app.d.ts, src/routes/+layout.svelte, src/routes/+page.svelte, src/lib/gateway/.gitkeep, src/lib/stores/.gitkeep, src/lib/components/.gitkeep
- **Learnings for future iterations:**
  - Tailwind CSS v4 uses `@import 'tailwindcss'` instead of v3's `@tailwind base/components/utilities`
  - ESLint v9 uses flat config (eslint.config.js) with `ts.config()` wrapper, not .eslintrc
  - SvelteKit `svelte-kit sync` must run before `svelte-check` to generate types
  - `.svelte-kit/tsconfig.json` is auto-generated — our tsconfig.json extends it
  - `@tailwindcss/vite` plugin is used for Tailwind v4 integration (not postcss)
---

## 2026-02-10 01:20 CST - US-002
- Implemented GatewayConnection class in src/lib/gateway/connection.ts
- Created type definitions in src/lib/gateway/types.ts (Frame types, ConnectionState, HelloOkPayload, etc.)
- Created barrel export in src/lib/gateway/index.ts
- Connection lifecycle: DISCONNECTED → CONNECTING → AUTHENTICATING → CONNECTED → READY
- Handles connect.challenge event, sends connect frame with protocol v3
- Parses hello-ok response, exposes snapshot/features/policy via helloOk readable store
- Exposes connection state as Svelte readable store
- Files changed: src/lib/gateway/connection.ts, src/lib/gateway/types.ts, src/lib/gateway/index.ts
- **Learnings for future iterations:**
  - ESLint flags unused params even with underscore prefix — store challenge for future Ed25519 signing (US-102)
  - Prettier auto-adds semicolons — the original code was written without them but Prettier normalizes
  - Use `readonly()` from svelte/store to expose writable stores as read-only to consumers
  - Connection uses id "1" for the connect request — future RequestCorrelator will use different IDs
  - WebSocket close code 1008 indicates "pairing required" from gateway
---

## 2026-02-10 01:25 CST - US-003
- Implemented RequestCorrelator class in src/lib/gateway/correlator.ts
- Maps req.id → pending Promise, resolves on ok:true, rejects on ok:false with GatewayRequestError
- Monotonic counter for request IDs, crypto.randomUUID() for idempotency keys
- Configurable timeout per request (default 30s), cancelAll() for disconnect cleanup
- Updated src/lib/gateway/index.ts with new exports
- Files changed: src/lib/gateway/correlator.ts, src/lib/gateway/index.ts
- **Learnings for future iterations:**
  - GatewayRequestError wraps gateway error shape (code, message, details, retryable, retryAfterMs)
  - Use `track<T>()` generic to get typed Promise returns
  - cancelAll() should be called on disconnect to reject all pending requests
  - Monotonic counter starts at 0 — avoid using id "1" for connect (reserved in GatewayConnection)
---

## 2026-02-10 01:30 CST - US-004
- Implemented EventBus class in src/lib/gateway/event-bus.ts
- on(event, handler) returns unsubscribe function, once(event) returns Promise
- Wildcard support: "pm.*" matches "pm.task.create", "*" matches everything
- clear() for auto-cleanup on disconnect
- handleFrame() dispatches EventFrame to exact and wildcard handlers
- Files changed: src/lib/gateway/event-bus.ts, src/lib/gateway/index.ts
- **Learnings for future iterations:**
  - Wildcard matching uses prefix: "pm.*" → startsWith("pm.")
  - EventBus.clear() must be called on disconnect to prevent stale handler references
  - Handlers receive both payload and full EventFrame (for seq/stateVersion access)
---

## 2026-02-10 01:35 CST - US-005
- Implemented SnapshotStore class in src/lib/gateway/snapshot-store.ts
- Seven readable stores: presence, health, stateVersion, sessionDefaults, features, server, policy
- hydrate() initializes from hello-ok payload, subscribe() connects to EventBus for incremental updates
- Presence events: add/update/remove entries by instanceId, tracks stateVersion
- Health events: merge payload into health store, tracks stateVersion
- hasMethod() derived store for runtime feature detection (e.g., check pm.* availability)
- Files changed: src/lib/gateway/snapshot-store.ts, src/lib/gateway/index.ts
- **Learnings for future iterations:**
  - SnapshotStore.subscribe(eventBus) must be called after hydrate() for incremental updates
  - Presence dedup is by instanceId (unique per tab)
  - stateVersion is per-domain object { presence: N, health: N }, not a single number
  - features.methods list determines which UI features to enable (feature detection pattern)
---

## 2026-02-10 01:40 CST - US-006
- Refactored GatewayConnection to formalize state machine per architecture §4.2
- Added setOnHelloOk() callback — fires between CONNECTED and READY for snapshot hydration
- Added setConnectionState() for reconnection logic to set RECONNECTING state
- Added connId getter for debugging connection info
- READY only set after onHelloOk callback completes (ensures snapshot is hydrated)
- Files changed: src/lib/gateway/connection.ts
- **Learnings for future iterations:**
  - setOnHelloOk callback pattern allows SnapshotStore hydration before READY
  - setConnectionState(RECONNECTING) will be used by US-007 reconnection logic
  - connId comes from hello-ok.server.connId — useful for connection status display
---

## 2026-02-10 01:45 CST - US-007
- Implemented Reconnector class in src/lib/gateway/reconnector.ts
- Exponential backoff: 800ms base, 1.7x multiplier, 15s cap
- Tick timeout: 2x policy.tickIntervalMs triggers reconnection
- Shutdown event: uses restartExpectedMs as initial delay when available
- Attempt counter resets on successful connection via onConnected()
- Subscribes to tick and shutdown events via EventBus
- Files changed: src/lib/gateway/reconnector.ts, src/lib/gateway/index.ts
- **Learnings for future iterations:**
  - Reconnector.enable(config) must be called after initial connect succeeds
  - Reconnector.onConnected(tickIntervalMs) resets attempt counter and starts tick monitoring
  - Reconnector.onDisconnect() should be called from GatewayConnection close handler
  - Backoff formula: min(800 * 1.7^attempt, 15000)
---

## 2026-02-10 01:50 CST - US-008
- Created token storage in src/lib/stores/token.ts (localStorage persistence)
- Created TokenEntry.svelte component with gateway URL and token fields
- Created gateway client singleton in src/lib/stores/gateway.ts wiring all subsystems
- Updated +layout.svelte to show TokenEntry when no token, app when token exists
- Auto-connect on token availability via $effect
- call() helper for typed RPC calls
- Files changed: src/lib/stores/token.ts, src/lib/stores/gateway.ts, src/lib/components/TokenEntry.svelte, src/routes/+layout.svelte
- **Learnings for future iterations:**
  - Gateway singleton in stores/gateway.ts wires: connection → correlator (responses) → eventBus (events)
  - connectToGateway() creates instanceId per connection attempt (crypto.randomUUID())
  - Token stored at localStorage key "falcon-dash:gateway-token"
  - Gateway URL stored at localStorage key "falcon-dash:gateway-url"
  - Manual browser verification needed (no dev-browser skill available)
---

## 2026-02-10 01:55 CST - US-009
- Implemented app shell layout with Sidebar + AppShell components
- Sidebar: Chats section (placeholder), Apps section (Projects, Documents, Agent Jobs), Settings/Passwords at bottom
- Connection status dot in sidebar header (green=READY, yellow=CONNECTING/RECONNECTING, red=DISCONNECTED)
- Mobile responsive: sidebar collapses with hamburger menu, overlay on mobile
- AppShell wraps content area with Svelte 5 snippet pattern ({@render children()})
- Updated +layout.svelte to show TokenEntry or AppShell based on token state
- Updated +page.svelte with welcome placeholder
- Files changed: src/lib/components/Sidebar.svelte, src/lib/components/AppShell.svelte, src/routes/+layout.svelte, src/routes/+page.svelte
- **Learnings for future iterations:**
  - `svelte/no-navigation-without-resolve` ESLint rule requires `resolveRoute()` for hrefs, but `resolveRoute` is typed against actual SvelteKit routes — use `<!-- eslint-disable -->` comment for placeholder routes that don't exist yet
  - Svelte 5 Snippet type import: `import('svelte').Snippet` for typing children prop
  - Mobile sidebar pattern: fixed positioning + z-index overlay, md:relative for desktop
  - `resolve` from `$app/paths` is NOT the same as `resolveRoute` — use `resolveRoute` for the ESLint rule
---

## 2026-02-10 02:00 CST - US-010
- Created ConnectionStatus.svelte component with color-coded status dot and text
- Green dot = READY ("Connected"), yellow = CONNECTING/AUTHENTICATING/RECONNECTING, red = DISCONNECTED
- Displays gateway hostname from snapshot.server.host
- Clickable to toggle details panel showing: connId, uptime, protocol version (3), server version
- Click-outside handler to close details panel
- Uptime tracked from READY state with timer
- Updated Sidebar.svelte to use ConnectionStatus component instead of inline dot
- Files changed: src/lib/components/ConnectionStatus.svelte (new), src/lib/components/Sidebar.svelte
- **Learnings for future iterations:**
  - Click-outside pattern in Svelte 5: use window click handler and check if event target is within component element
  - Uptime tracking: setInterval in $effect, clear on state change or unmount
  - snapshot.server is a readable store of `{ version, host, connId } | null` — always null-check
---

## 2026-02-10 02:05 CST - US-011
- Created PresenceList.svelte component showing connected clients from snapshot.presence store
- Displays device type badge, display name (fallback to truncated instanceId), connection duration
- Duration updates every 30s via setInterval in $effect
- Empty state: "No other connections" placeholder
- Added PresenceList to +page.svelte under "Connected Clients" heading
- Files changed: src/lib/components/PresenceList.svelte (new), src/routes/+page.svelte
- **Learnings for future iterations:**
  - PresenceEntry.connectedAt is a timestamp in ms — use Date.now() - connectedAt for duration
  - Deduplication by instanceId is handled by SnapshotStore, not the component
  - Device type values come from gateway: "browser", "api", "agent" etc.
---

## 2026-02-10 02:10 CST - US-012
- Created PWA manifest at static/manifest.json (name, icons, theme, display: standalone)
- Created SVG app icons: static/icon-192.svg and static/icon-512.svg (falcon "F" lettermark)
- Updated src/app.html with manifest link and theme-color meta tag
- Theme color: #030712 (gray-950, matches app background)
- Files changed: static/manifest.json (new), static/icon-192.svg (new), static/icon-512.svg (new), src/app.html
- **Learnings for future iterations:**
  - Static files in SvelteKit go in `static/` dir, served at root path
  - Use `%sveltekit.assets%/manifest.json` in app.html for proper path resolution
  - SVG icons work well for PWA — scalable, no need for raster at multiple sizes
  - Phase 1 complete with US-012
---

## 2026-02-10 02:15 CST - US-013
- Created AgentStreamManager in src/lib/gateway/stream.ts
- Tracks active runs by runId with two-stage response handling (ack → stream → final)
- Accumulates text deltas using full-text comparison (length check for out-of-order)
- Emits higher-level events: messageStart, delta, toolCall, toolResult, messageEnd
- Seq gap detection per run (tracks missing sequence numbers)
- Auto-creates run if agent events arrive before ack
- Handles chat event states: delta, final, aborted, error
- Updated index.ts with AgentStreamManager and type exports
- Files changed: src/lib/gateway/stream.ts (new), src/lib/gateway/index.ts
- **Learnings for future iterations:**
  - Agent events use `stream` field: "assistant", "tool", "lifecycle", "error", "compaction"
  - Chat deltas contain FULL accumulated text — compare length to avoid regression
  - Agent seq is per-run, not global — gap detection is per-run tracking
  - onAck() and onFinal() are called externally by the gateway store when handling response frames
  - Tool events may use toolCallId or id, args or input — handle both field names
---

## 2026-02-10 02:20 CST - US-014
- Created per-session chat store in src/lib/stores/chat.ts
- createChatSession(sessionKey) returns reactive stores: messages, activeRunId, isStreaming, hasActiveRun
- Optimistic send: user message appears immediately with status "sending", confirmed on ack
- AgentStreamManager integration: delta/toolCall/toolResult/messageEnd events update message store
- send() calls chat.send with idempotencyKey, creates assistant placeholder on ack
- abort() calls chat.abort and finalizes the stream
- loadHistory() fetches chat.history and deduplicates by message ID (for reconnect)
- Files changed: src/lib/stores/chat.ts (new)
- **Learnings for future iterations:**
  - chat.send needs deliver: false for webchat mode (don't forward to external channels)
  - idempotencyKey doubles as the user message ID for dedup
  - streamManager.onAck/onFinal must be called from the store when handling response frames
  - Message status flow: sending → sent → streaming → complete/error
  - ChatSessionStore type exported as ReturnType<typeof createChatSession>
---

## 2026-02-10 02:25 CST - US-015
- Created markdown pipeline in src/lib/chat/markdown.ts using unified/remark/rehype
- Installed: unified, remark-parse, remark-gfm, remark-rehype, rehype-stringify, rehype-sanitize, rehype-raw
- Supports CommonMark + GFM (tables, strikethrough, task lists)
- Custom sanitize schema allows details/summary/hr elements
- Compaction divider (---) rendered as dashed visual separator
- Created MarkdownRenderer.svelte component with dark-themed CSS
- Both async (renderMarkdown) and sync (renderMarkdownSync) rendering
- Files changed: src/lib/chat/markdown.ts (new), src/lib/components/MarkdownRenderer.svelte (new), package.json
- **Learnings for future iterations:**
  - rehype-raw needed to parse HTML elements (details/summary) that pass through remark
  - rehype-sanitize defaultSchema must be extended for custom elements
  - processSync() for reactive $derived contexts, async process() for one-off renders
  - @html directive needs eslint-disable svelte/no-at-html-tags comment
  - Scoped styles in Svelte need :global() for dynamically generated HTML content
---

## 2026-02-10 02:30 CST - US-016
- Added KaTeX support via remark-math + rehype-katex to markdown pipeline
- Extended sanitize schema for KaTeX-generated math elements (span, div, math, semantics, etc.)
- Created MermaidDiagram.svelte with lazy-loaded mermaid.js (dynamic import)
- Updated MarkdownRenderer to extract mermaid blocks and render separately
- KaTeX CSS loaded via CDN in svelte:head
- Graceful error fallback for malformed math/diagrams
- Installed: katex, remark-math, rehype-katex, mermaid, @types/katex
- Files changed: src/lib/chat/markdown.ts, src/lib/components/MarkdownRenderer.svelte, src/lib/components/MermaidDiagram.svelte (new), package.json
- **Learnings for future iterations:**
  - Mermaid must be lazy-loaded (large bundle) with dynamic import in onMount
  - KaTeX generates complex HTML with math/semantics/mrow elements — sanitize schema must allow them
  - Mermaid blocks extracted via regex before markdown processing, rendered as separate components
  - mermaid.initialize({ startOnLoad: false, theme: 'dark', securityLevel: 'strict' })
  - crypto.randomUUID() for unique mermaid element IDs
---

## 2026-02-10 02:35 CST - US-017
- Created Shiki highlighter in src/lib/chat/highlighter.ts (23 common languages, github-dark theme)
- Created CodeBlock.svelte with language label, copy button, and async Shiki highlighting
- Created Admonition.svelte for NOTE/TIP/WARNING/CAUTION/IMPORTANT callouts
- Updated MarkdownRenderer to extract fenced code blocks and render via CodeBlock component
- Added admonition preprocessing: GFM `> [!NOTE]` syntax → HTML admonition divs
- Updated markdown.ts sanitize schema to allow data-type attribute on divs
- Installed: shiki
- Files changed: src/lib/chat/highlighter.ts (new), src/lib/components/CodeBlock.svelte (new), src/lib/components/Admonition.svelte (new), src/lib/components/MarkdownRenderer.svelte, src/lib/chat/markdown.ts, package.json
- **Learnings for future iterations:**
  - Shiki createHighlighter is async — use singleton pattern with initPromise
  - Code blocks extracted before markdown processing (same pattern as mermaid)
  - GFM admonitions: `> [!TYPE]` syntax, preprocessed to HTML before remark
  - navigator.clipboard.writeText for copy button
  - Shiki codeToHtml returns full HTML — style pre/code to transparent bg
---

## 2026-02-10 02:40 CST - US-018
- Created ThinkingBlock.svelte with collapsible thinking section
- Default collapsed, user can expand to watch thinking in progress
- Label: "Thinking..." with spinner while streaming, "Thought for Xs" when complete
- Elapsed time tracked via setInterval in $effect, cleared on unmount
- Monospace text display with max-height and scrollable overflow
- Works for all thinking levels (renders based on thinkingText presence)
- Files changed: src/lib/components/ThinkingBlock.svelte (new)
- **Learnings for future iterations:**
  - ThinkingBlock takes thinkingText, isStreaming, startedAt props
  - Component renders nothing when thinkingText is empty (thinking level "off")
  - Collapse state persists across re-renders via $state
  - Duration formatting: seconds < 60 → "Xs", otherwise "Xm Ys"
---

## 2026-02-10 02:45 CST - US-019
- Created ToolCallCard.svelte with expandable tool call display
- Shows tool name, status indicator (spinner=running, checkmark=complete)
- Collapsible JSON display for arguments and results
- Shell/runtime info badge when available in args
- Blue border for running, green for completed
- Files changed: src/lib/components/ToolCallCard.svelte (new)
- **Learnings for future iterations:**
  - Tool call args may contain shell/runtime info — display as badge
  - JSON.stringify with try/catch for safe formatting of unknown values
  - Status distinction: 'running' (blue, spinner) vs 'complete' (green, checkmark)
---

## 2026-02-10 02:50 CST - US-020
- Created MessageComposer.svelte with rich message input
- SHIFT+ENTER for newlines, ENTER to send
- File upload button, drag-and-drop, clipboard paste support
- Auto-resize textarea (max 200px), attachment previews with remove
- Disabled state while streaming, abort button shown during active run
- Files changed: src/lib/components/MessageComposer.svelte (new)
- **Learnings for future iterations:**
  - Auto-resize: set height='auto' then scrollHeight (capped at max)
  - Drag-and-drop: ondrop/ondragover/ondragleave on container div
  - Clipboard paste: check clipboardData.items for file kind
  - Hidden file input triggered by button click
---

## 2026-02-10 02:55 CST - US-021
- Created slash command registry in src/lib/chat/commands.ts (10 commands)
- Created SlashCommandMenu.svelte Discord-style autocomplete dropdown
- Commands: /new, /stop, /reasoning, /compact, /status, /usage, /verbose, /context, /subagents, /send
- Fuzzy filtering via name.includes(query)
- Parent manages selectedIndex and keyboard navigation (Svelte 5 no export function)
- Files changed: src/lib/chat/commands.ts (new), src/lib/components/SlashCommandMenu.svelte (new)
- **Learnings for future iterations:**
  - Svelte 5 does NOT support `export function` in components — use props for parent control
  - Thinking levels: off/minimal/low/medium/high/xhigh (NOT off/on/stream)
  - /send command needs sessionKey + message args parsed from space-separated input
  - Some commands (/status, /usage, /context) are UI-only — handler is no-op, UI reads state
---

## 2026-02-10 03:00 CST - US-022
- Created session list store in src/lib/stores/sessions.ts
- Created ChatList.svelte with search, rename (dblclick), delete, unread badges
- Store: loadSessions, setActiveSession, renameSession, deleteSession, live event subscription
- General session pinned to top, sorted by updatedAt descending
- Derived filteredSessions store for search filtering
- Files changed: src/lib/stores/sessions.ts (new), src/lib/components/ChatList.svelte (new)
- **Learnings for future iterations:**
  - Use `get()` from svelte/store for synchronous store reads in non-reactive contexts
  - Gateway `sessions.list` returns `sessions` array with sessionKey, displayName, etc.
  - Gateway `sessions.patch` for create/update, `sessions.delete` for removal
  - EventBus 'session' events have action: created/updated/deleted
---

## 2026-02-10 03:10 CST - US-023
- Added createSession function to sessions store
- Generates key: agent:<agentId>:webchat:group:<uuid> using defaultAgentId from snapshot
- Optimistic update: adds session to list immediately, sets as active
- Creates on server via sessions.patch
- Added "+ New Chat" button to ChatList.svelte (blue, with plus icon)
- Files changed: src/lib/stores/sessions.ts (modified), src/lib/components/ChatList.svelte (modified)
- **Learnings for future iterations:**
  - Use `get(snapshot.sessionDefaults)` to read defaultAgentId synchronously
  - Session key format: agent:<agentId>:webchat:group:<uuid>
  - Optimistic updates should add to list AND set active before server call
---

## 2026-02-10 03:20 CST - US-024
- Added ensureGeneralSession() to sessions store
- Checks sessions.list for isGeneral session, creates if missing
- General session key: agent:<agentId>:webchat:group:general (fixed key, not UUID)
- Auto-sets General as active session on connect
- Added $effect in +layout.svelte watching connection.state for 'READY'
- On READY: calls ensureGeneralSession() and subscribeToEvents()
- Files changed: src/lib/stores/sessions.ts (modified), src/routes/+layout.svelte (modified)
- **Learnings for future iterations:**
  - Connection state values are uppercase strings: 'READY', 'DISCONNECTED', etc.
  - ensureGeneralSession should be called after connection is READY (not during connect)
  - General session uses fixed key suffix 'general' not a random UUID
  - $effect cleanup in layout handles unsubscribeFromEvents on teardown
---

## 2026-02-10 02:30 CST - US-025
- Implemented ChatHeader.svelte component with session settings panel
- Chat header shows current model name and settings gear icon
- Settings panel includes: model override input, thinking level dropdown (off/minimal/low/medium/high/xhigh), verbose toggle
- Reset session button calls sessions.reset (equivalent to /new command)
- Compact transcript button calls sessions.compact (equivalent to /compact command)
- Settings applied via sessions.patch gateway call with active sessionKey
- Defaults read from snapshot.sessionDefaults store (model, thinkingLevel)
- Files changed: src/lib/components/ChatHeader.svelte
- **Learnings for future iterations:**
  - ChatHeader component is ready but not yet integrated into any route/page (chat routes not yet created)
  - Component uses $effect() to subscribe to snapshot.sessionDefaults and activeSessionKey stores
  - Settings changes call sessions.patch with individual field updates (model, thinkingLevel, verbose)
  - Thinking levels are off/minimal/low/medium/high/xhigh (NOT off/on/stream as noted in US-018)
  - Component follows Svelte 5 patterns: $state() for local reactive state, onclick handlers (not on:click)
  - Browser verification deferred until chat UI is fully integrated (no chat routes exist yet)
---

## 2026-02-10 03:30 CST - US-026
- Added connection-aware message queueing to chat store
- Messages typed while disconnected are queued in _pendingQueue writable
- send() checks connection.state — if not READY, queues message and shows optimistically
- Added reconcile() function: loads history, flushes queue, resumes active streaming runs
- Created chat-resilience.ts with watchConnectionForChat() connection state watcher
- Tracks disconnection duration — silent reconnect if <2s
- Files changed: src/lib/stores/chat.ts (modified), src/lib/stores/chat-resilience.ts (new)
- **Learnings for future iterations:**
  - Use `get(connection.state)` for synchronous connection state check in send()
  - reconcile() should load history FIRST, then flush queued messages
  - watchConnectionForChat returns an unsubscribe function for cleanup
  - Silent reconnect threshold is 2000ms — below that, no reconnection banner
---

## 2026-02-10 03:40 CST - US-027
- Added replyToMessageId to ChatMessage interface
- Added _replyTo store and setReplyTo function to chat session
- send() includes replyToMessageId in chat.send params and clears reply state after send
- Created ReplyPreview.svelte — compact preview with role, truncated content, cancel/click modes
- Created MessageActions.svelte — hover toolbar with Reply button
- Files changed: src/lib/stores/chat.ts (modified), src/lib/components/ReplyPreview.svelte (new), src/lib/components/MessageActions.svelte (new)
- **Learnings for future iterations:**
  - Reply preview shows first 100 chars of content with ellipsis
  - ReplyPreview has two modes: showCancel (composer) and onclick (in-message, scroll-to)
  - MessageActions is a floating toolbar — meant to appear on message hover (parent manages visibility)
  - replyToMessageId is stored both in ChatMessage and sent as chat.send param
---

## 2026-02-10 03:50 CST - US-028
- Created thread store (src/lib/stores/threads.ts) with openThread, closeThread, getThreadForMessage
- Thread key format: agent:<agentId>:webchat:group:<parentId>:thread:<uuid>
- Creates thread session via sessions.patch with parentSessionId and originMessageId
- Each thread gets its own ChatSessionStore via createChatSession()
- Created ThreadPanel.svelte — 80-width side panel with header, messages, composer
- Added 'Start Thread' button to MessageActions.svelte (onthread prop)
- Files changed: src/lib/stores/threads.ts (new), src/lib/components/ThreadPanel.svelte (new), src/lib/components/MessageActions.svelte (modified)
- **Learnings for future iterations:**
  - Thread sessions reuse createChatSession() — same message handling, streaming, etc.
  - Thread key includes parentId extracted from parent session key
  - Previous thread session is destroyed when opening a new thread
  - MessageActions now has both onreply and onthread props
---

## 2026-02-10 04:00 CST - US-029
- Added ThreadState type (active/archived/locked) and lifecycle functions to threads store
- archiveThread, unarchiveThread, lockThread — update local state + call sessions.patch
- loadThreads(parentSessionKey) — fetches threads from server via sessions.list
- threadsForSession(parentSessionKey) — derived store filtering threads by parent
- checkAutoArchive() — auto-archives threads inactive >24h
- Created ThreadList.svelte — displays threads with state color, message count, last activity
- Added threads button to ChatHeader.svelte — toggles thread list panel
- Files changed: src/lib/stores/threads.ts (modified), src/lib/components/ThreadList.svelte (new), src/lib/components/ChatHeader.svelte (modified)
- **Learnings for future iterations:**
  - ThreadState is 'active' | 'archived' | 'locked' — server stores state via sessions.patch
  - Auto-archive threshold is 24h (configurable via AUTO_ARCHIVE_MS constant)
  - threadsForSession returns a custom Readable that filters _threads map
  - ChatHeader now has both showSettings and showThreads toggle states
---
