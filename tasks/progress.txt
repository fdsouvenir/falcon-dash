# Ralph Progress Log
Started: Tue Feb 10 01:06:48 AM CST 2026

## Codebase Patterns
- Prettier config: tabs, single quotes, no trailing commas, printWidth 100
- Svelte 5 syntax: use `$props()` not `export let`, use `{@render children()}` not `<slot />`
- TypeScript strict mode enabled in tsconfig.json
- Tailwind CSS v4 with `@import 'tailwindcss'` in app.css (not v3 @tailwind directives)
- ESLint v9 flat config format (eslint.config.js, not .eslintrc)
- Vite dev proxy at `/ws` routes to `ws://127.0.0.1:18789`
- Always run `npm run format` after writing code
- Don't commit `.omc/` directory (local state)
- Gateway connection: client.id must be "openclaw-control-ui", client.mode must be "webchat" (gateway validates)
- Prettier adds semicolons on format â€” don't write them manually, let Prettier handle it
- Use `.js` extension in TypeScript imports (e.g., `from './types.js'`) for ESM compatibility
- `svelte/no-navigation-without-resolve` ESLint rule: use `<!-- eslint-disable svelte/no-navigation-without-resolve -->` for placeholder routes not yet created
- Svelte 5 children prop type: `{ children }: { children: import('svelte').Snippet }`

---

## 2026-02-10 01:15 CST - US-001
- Scaffolded SvelteKit project with TypeScript strict mode
- Configured Tailwind CSS v4, ESLint v9 flat config, Prettier
- Created directory structure: src/lib/gateway/, src/lib/stores/, src/lib/components/, src/routes/
- Configured vite.config.ts with dev proxy to gateway port 18789
- Files changed: package.json, svelte.config.js, vite.config.ts, tsconfig.json, .prettierrc, .prettierignore, eslint.config.js, src/app.html, src/app.css, src/app.d.ts, src/routes/+layout.svelte, src/routes/+page.svelte, src/lib/gateway/.gitkeep, src/lib/stores/.gitkeep, src/lib/components/.gitkeep
- **Learnings for future iterations:**
  - Tailwind CSS v4 uses `@import 'tailwindcss'` instead of v3's `@tailwind base/components/utilities`
  - ESLint v9 uses flat config (eslint.config.js) with `ts.config()` wrapper, not .eslintrc
  - SvelteKit `svelte-kit sync` must run before `svelte-check` to generate types
  - `.svelte-kit/tsconfig.json` is auto-generated â€” our tsconfig.json extends it
  - `@tailwindcss/vite` plugin is used for Tailwind v4 integration (not postcss)
---

## 2026-02-10 01:20 CST - US-002
- Implemented GatewayConnection class in src/lib/gateway/connection.ts
- Created type definitions in src/lib/gateway/types.ts (Frame types, ConnectionState, HelloOkPayload, etc.)
- Created barrel export in src/lib/gateway/index.ts
- Connection lifecycle: DISCONNECTED â†’ CONNECTING â†’ AUTHENTICATING â†’ CONNECTED â†’ READY
- Handles connect.challenge event, sends connect frame with protocol v3
- Parses hello-ok response, exposes snapshot/features/policy via helloOk readable store
- Exposes connection state as Svelte readable store
- Files changed: src/lib/gateway/connection.ts, src/lib/gateway/types.ts, src/lib/gateway/index.ts
- **Learnings for future iterations:**
  - ESLint flags unused params even with underscore prefix â€” store challenge for future Ed25519 signing (US-102)
  - Prettier auto-adds semicolons â€” the original code was written without them but Prettier normalizes
  - Use `readonly()` from svelte/store to expose writable stores as read-only to consumers
  - Connection uses id "1" for the connect request â€” future RequestCorrelator will use different IDs
  - WebSocket close code 1008 indicates "pairing required" from gateway
---

## 2026-02-10 01:25 CST - US-003
- Implemented RequestCorrelator class in src/lib/gateway/correlator.ts
- Maps req.id â†’ pending Promise, resolves on ok:true, rejects on ok:false with GatewayRequestError
- Monotonic counter for request IDs, crypto.randomUUID() for idempotency keys
- Configurable timeout per request (default 30s), cancelAll() for disconnect cleanup
- Updated src/lib/gateway/index.ts with new exports
- Files changed: src/lib/gateway/correlator.ts, src/lib/gateway/index.ts
- **Learnings for future iterations:**
  - GatewayRequestError wraps gateway error shape (code, message, details, retryable, retryAfterMs)
  - Use `track<T>()` generic to get typed Promise returns
  - cancelAll() should be called on disconnect to reject all pending requests
  - Monotonic counter starts at 0 â€” avoid using id "1" for connect (reserved in GatewayConnection)
---

## 2026-02-10 01:30 CST - US-004
- Implemented EventBus class in src/lib/gateway/event-bus.ts
- on(event, handler) returns unsubscribe function, once(event) returns Promise
- Wildcard support: "pm.*" matches "pm.task.create", "*" matches everything
- clear() for auto-cleanup on disconnect
- handleFrame() dispatches EventFrame to exact and wildcard handlers
- Files changed: src/lib/gateway/event-bus.ts, src/lib/gateway/index.ts
- **Learnings for future iterations:**
  - Wildcard matching uses prefix: "pm.*" â†’ startsWith("pm.")
  - EventBus.clear() must be called on disconnect to prevent stale handler references
  - Handlers receive both payload and full EventFrame (for seq/stateVersion access)
---

## 2026-02-10 01:35 CST - US-005
- Implemented SnapshotStore class in src/lib/gateway/snapshot-store.ts
- Seven readable stores: presence, health, stateVersion, sessionDefaults, features, server, policy
- hydrate() initializes from hello-ok payload, subscribe() connects to EventBus for incremental updates
- Presence events: add/update/remove entries by instanceId, tracks stateVersion
- Health events: merge payload into health store, tracks stateVersion
- hasMethod() derived store for runtime feature detection (e.g., check pm.* availability)
- Files changed: src/lib/gateway/snapshot-store.ts, src/lib/gateway/index.ts
- **Learnings for future iterations:**
  - SnapshotStore.subscribe(eventBus) must be called after hydrate() for incremental updates
  - Presence dedup is by instanceId (unique per tab)
  - stateVersion is per-domain object { presence: N, health: N }, not a single number
  - features.methods list determines which UI features to enable (feature detection pattern)
---

## 2026-02-10 01:40 CST - US-006
- Refactored GatewayConnection to formalize state machine per architecture Â§4.2
- Added setOnHelloOk() callback â€” fires between CONNECTED and READY for snapshot hydration
- Added setConnectionState() for reconnection logic to set RECONNECTING state
- Added connId getter for debugging connection info
- READY only set after onHelloOk callback completes (ensures snapshot is hydrated)
- Files changed: src/lib/gateway/connection.ts
- **Learnings for future iterations:**
  - setOnHelloOk callback pattern allows SnapshotStore hydration before READY
  - setConnectionState(RECONNECTING) will be used by US-007 reconnection logic
  - connId comes from hello-ok.server.connId â€” useful for connection status display
---

## 2026-02-10 01:45 CST - US-007
- Implemented Reconnector class in src/lib/gateway/reconnector.ts
- Exponential backoff: 800ms base, 1.7x multiplier, 15s cap
- Tick timeout: 2x policy.tickIntervalMs triggers reconnection
- Shutdown event: uses restartExpectedMs as initial delay when available
- Attempt counter resets on successful connection via onConnected()
- Subscribes to tick and shutdown events via EventBus
- Files changed: src/lib/gateway/reconnector.ts, src/lib/gateway/index.ts
- **Learnings for future iterations:**
  - Reconnector.enable(config) must be called after initial connect succeeds
  - Reconnector.onConnected(tickIntervalMs) resets attempt counter and starts tick monitoring
  - Reconnector.onDisconnect() should be called from GatewayConnection close handler
  - Backoff formula: min(800 * 1.7^attempt, 15000)
---

## 2026-02-10 01:50 CST - US-008
- Created token storage in src/lib/stores/token.ts (localStorage persistence)
- Created TokenEntry.svelte component with gateway URL and token fields
- Created gateway client singleton in src/lib/stores/gateway.ts wiring all subsystems
- Updated +layout.svelte to show TokenEntry when no token, app when token exists
- Auto-connect on token availability via $effect
- call() helper for typed RPC calls
- Files changed: src/lib/stores/token.ts, src/lib/stores/gateway.ts, src/lib/components/TokenEntry.svelte, src/routes/+layout.svelte
- **Learnings for future iterations:**
  - Gateway singleton in stores/gateway.ts wires: connection â†’ correlator (responses) â†’ eventBus (events)
  - connectToGateway() creates instanceId per connection attempt (crypto.randomUUID())
  - Token stored at localStorage key "falcon-dash:gateway-token"
  - Gateway URL stored at localStorage key "falcon-dash:gateway-url"
  - Manual browser verification needed (no dev-browser skill available)
---

## 2026-02-10 01:55 CST - US-009
- Implemented app shell layout with Sidebar + AppShell components
- Sidebar: Chats section (placeholder), Apps section (Projects, Documents, Agent Jobs), Settings/Passwords at bottom
- Connection status dot in sidebar header (green=READY, yellow=CONNECTING/RECONNECTING, red=DISCONNECTED)
- Mobile responsive: sidebar collapses with hamburger menu, overlay on mobile
- AppShell wraps content area with Svelte 5 snippet pattern ({@render children()})
- Updated +layout.svelte to show TokenEntry or AppShell based on token state
- Updated +page.svelte with welcome placeholder
- Files changed: src/lib/components/Sidebar.svelte, src/lib/components/AppShell.svelte, src/routes/+layout.svelte, src/routes/+page.svelte
- **Learnings for future iterations:**
  - `svelte/no-navigation-without-resolve` ESLint rule requires `resolveRoute()` for hrefs, but `resolveRoute` is typed against actual SvelteKit routes â€” use `<!-- eslint-disable -->` comment for placeholder routes that don't exist yet
  - Svelte 5 Snippet type import: `import('svelte').Snippet` for typing children prop
  - Mobile sidebar pattern: fixed positioning + z-index overlay, md:relative for desktop
  - `resolve` from `$app/paths` is NOT the same as `resolveRoute` â€” use `resolveRoute` for the ESLint rule
---

## 2026-02-10 02:00 CST - US-010
- Created ConnectionStatus.svelte component with color-coded status dot and text
- Green dot = READY ("Connected"), yellow = CONNECTING/AUTHENTICATING/RECONNECTING, red = DISCONNECTED
- Displays gateway hostname from snapshot.server.host
- Clickable to toggle details panel showing: connId, uptime, protocol version (3), server version
- Click-outside handler to close details panel
- Uptime tracked from READY state with timer
- Updated Sidebar.svelte to use ConnectionStatus component instead of inline dot
- Files changed: src/lib/components/ConnectionStatus.svelte (new), src/lib/components/Sidebar.svelte
- **Learnings for future iterations:**
  - Click-outside pattern in Svelte 5: use window click handler and check if event target is within component element
  - Uptime tracking: setInterval in $effect, clear on state change or unmount
  - snapshot.server is a readable store of `{ version, host, connId } | null` â€” always null-check
---

## 2026-02-10 02:05 CST - US-011
- Created PresenceList.svelte component showing connected clients from snapshot.presence store
- Displays device type badge, display name (fallback to truncated instanceId), connection duration
- Duration updates every 30s via setInterval in $effect
- Empty state: "No other connections" placeholder
- Added PresenceList to +page.svelte under "Connected Clients" heading
- Files changed: src/lib/components/PresenceList.svelte (new), src/routes/+page.svelte
- **Learnings for future iterations:**
  - PresenceEntry.connectedAt is a timestamp in ms â€” use Date.now() - connectedAt for duration
  - Deduplication by instanceId is handled by SnapshotStore, not the component
  - Device type values come from gateway: "browser", "api", "agent" etc.
---

## 2026-02-10 02:10 CST - US-012
- Created PWA manifest at static/manifest.json (name, icons, theme, display: standalone)
- Created SVG app icons: static/icon-192.svg and static/icon-512.svg (falcon "F" lettermark)
- Updated src/app.html with manifest link and theme-color meta tag
- Theme color: #030712 (gray-950, matches app background)
- Files changed: static/manifest.json (new), static/icon-192.svg (new), static/icon-512.svg (new), src/app.html
- **Learnings for future iterations:**
  - Static files in SvelteKit go in `static/` dir, served at root path
  - Use `%sveltekit.assets%/manifest.json` in app.html for proper path resolution
  - SVG icons work well for PWA â€” scalable, no need for raster at multiple sizes
  - Phase 1 complete with US-012
---

## 2026-02-10 02:15 CST - US-013
- Created AgentStreamManager in src/lib/gateway/stream.ts
- Tracks active runs by runId with two-stage response handling (ack â†’ stream â†’ final)
- Accumulates text deltas using full-text comparison (length check for out-of-order)
- Emits higher-level events: messageStart, delta, toolCall, toolResult, messageEnd
- Seq gap detection per run (tracks missing sequence numbers)
- Auto-creates run if agent events arrive before ack
- Handles chat event states: delta, final, aborted, error
- Updated index.ts with AgentStreamManager and type exports
- Files changed: src/lib/gateway/stream.ts (new), src/lib/gateway/index.ts
- **Learnings for future iterations:**
  - Agent events use `stream` field: "assistant", "tool", "lifecycle", "error", "compaction"
  - Chat deltas contain FULL accumulated text â€” compare length to avoid regression
  - Agent seq is per-run, not global â€” gap detection is per-run tracking
  - onAck() and onFinal() are called externally by the gateway store when handling response frames
  - Tool events may use toolCallId or id, args or input â€” handle both field names
---

## 2026-02-10 02:20 CST - US-014
- Created per-session chat store in src/lib/stores/chat.ts
- createChatSession(sessionKey) returns reactive stores: messages, activeRunId, isStreaming, hasActiveRun
- Optimistic send: user message appears immediately with status "sending", confirmed on ack
- AgentStreamManager integration: delta/toolCall/toolResult/messageEnd events update message store
- send() calls chat.send with idempotencyKey, creates assistant placeholder on ack
- abort() calls chat.abort and finalizes the stream
- loadHistory() fetches chat.history and deduplicates by message ID (for reconnect)
- Files changed: src/lib/stores/chat.ts (new)
- **Learnings for future iterations:**
  - chat.send needs deliver: false for webchat mode (don't forward to external channels)
  - idempotencyKey doubles as the user message ID for dedup
  - streamManager.onAck/onFinal must be called from the store when handling response frames
  - Message status flow: sending â†’ sent â†’ streaming â†’ complete/error
  - ChatSessionStore type exported as ReturnType<typeof createChatSession>
---

## 2026-02-10 02:25 CST - US-015
- Created markdown pipeline in src/lib/chat/markdown.ts using unified/remark/rehype
- Installed: unified, remark-parse, remark-gfm, remark-rehype, rehype-stringify, rehype-sanitize, rehype-raw
- Supports CommonMark + GFM (tables, strikethrough, task lists)
- Custom sanitize schema allows details/summary/hr elements
- Compaction divider (---) rendered as dashed visual separator
- Created MarkdownRenderer.svelte component with dark-themed CSS
- Both async (renderMarkdown) and sync (renderMarkdownSync) rendering
- Files changed: src/lib/chat/markdown.ts (new), src/lib/components/MarkdownRenderer.svelte (new), package.json
- **Learnings for future iterations:**
  - rehype-raw needed to parse HTML elements (details/summary) that pass through remark
  - rehype-sanitize defaultSchema must be extended for custom elements
  - processSync() for reactive $derived contexts, async process() for one-off renders
  - @html directive needs eslint-disable svelte/no-at-html-tags comment
  - Scoped styles in Svelte need :global() for dynamically generated HTML content
---

## 2026-02-10 02:30 CST - US-016
- Added KaTeX support via remark-math + rehype-katex to markdown pipeline
- Extended sanitize schema for KaTeX-generated math elements (span, div, math, semantics, etc.)
- Created MermaidDiagram.svelte with lazy-loaded mermaid.js (dynamic import)
- Updated MarkdownRenderer to extract mermaid blocks and render separately
- KaTeX CSS loaded via CDN in svelte:head
- Graceful error fallback for malformed math/diagrams
- Installed: katex, remark-math, rehype-katex, mermaid, @types/katex
- Files changed: src/lib/chat/markdown.ts, src/lib/components/MarkdownRenderer.svelte, src/lib/components/MermaidDiagram.svelte (new), package.json
- **Learnings for future iterations:**
  - Mermaid must be lazy-loaded (large bundle) with dynamic import in onMount
  - KaTeX generates complex HTML with math/semantics/mrow elements â€” sanitize schema must allow them
  - Mermaid blocks extracted via regex before markdown processing, rendered as separate components
  - mermaid.initialize({ startOnLoad: false, theme: 'dark', securityLevel: 'strict' })
  - crypto.randomUUID() for unique mermaid element IDs
---

## 2026-02-10 02:35 CST - US-017
- Created Shiki highlighter in src/lib/chat/highlighter.ts (23 common languages, github-dark theme)
- Created CodeBlock.svelte with language label, copy button, and async Shiki highlighting
- Created Admonition.svelte for NOTE/TIP/WARNING/CAUTION/IMPORTANT callouts
- Updated MarkdownRenderer to extract fenced code blocks and render via CodeBlock component
- Added admonition preprocessing: GFM `> [!NOTE]` syntax â†’ HTML admonition divs
- Updated markdown.ts sanitize schema to allow data-type attribute on divs
- Installed: shiki
- Files changed: src/lib/chat/highlighter.ts (new), src/lib/components/CodeBlock.svelte (new), src/lib/components/Admonition.svelte (new), src/lib/components/MarkdownRenderer.svelte, src/lib/chat/markdown.ts, package.json
- **Learnings for future iterations:**
  - Shiki createHighlighter is async â€” use singleton pattern with initPromise
  - Code blocks extracted before markdown processing (same pattern as mermaid)
  - GFM admonitions: `> [!TYPE]` syntax, preprocessed to HTML before remark
  - navigator.clipboard.writeText for copy button
  - Shiki codeToHtml returns full HTML â€” style pre/code to transparent bg
---

## 2026-02-10 02:40 CST - US-018
- Created ThinkingBlock.svelte with collapsible thinking section
- Default collapsed, user can expand to watch thinking in progress
- Label: "Thinking..." with spinner while streaming, "Thought for Xs" when complete
- Elapsed time tracked via setInterval in $effect, cleared on unmount
- Monospace text display with max-height and scrollable overflow
- Works for all thinking levels (renders based on thinkingText presence)
- Files changed: src/lib/components/ThinkingBlock.svelte (new)
- **Learnings for future iterations:**
  - ThinkingBlock takes thinkingText, isStreaming, startedAt props
  - Component renders nothing when thinkingText is empty (thinking level "off")
  - Collapse state persists across re-renders via $state
  - Duration formatting: seconds < 60 â†’ "Xs", otherwise "Xm Ys"
---

## 2026-02-10 02:45 CST - US-019
- Created ToolCallCard.svelte with expandable tool call display
- Shows tool name, status indicator (spinner=running, checkmark=complete)
- Collapsible JSON display for arguments and results
- Shell/runtime info badge when available in args
- Blue border for running, green for completed
- Files changed: src/lib/components/ToolCallCard.svelte (new)
- **Learnings for future iterations:**
  - Tool call args may contain shell/runtime info â€” display as badge
  - JSON.stringify with try/catch for safe formatting of unknown values
  - Status distinction: 'running' (blue, spinner) vs 'complete' (green, checkmark)
---

## 2026-02-10 02:50 CST - US-020
- Created MessageComposer.svelte with rich message input
- SHIFT+ENTER for newlines, ENTER to send
- File upload button, drag-and-drop, clipboard paste support
- Auto-resize textarea (max 200px), attachment previews with remove
- Disabled state while streaming, abort button shown during active run
- Files changed: src/lib/components/MessageComposer.svelte (new)
- **Learnings for future iterations:**
  - Auto-resize: set height='auto' then scrollHeight (capped at max)
  - Drag-and-drop: ondrop/ondragover/ondragleave on container div
  - Clipboard paste: check clipboardData.items for file kind
  - Hidden file input triggered by button click
---

## 2026-02-10 02:55 CST - US-021
- Created slash command registry in src/lib/chat/commands.ts (10 commands)
- Created SlashCommandMenu.svelte Discord-style autocomplete dropdown
- Commands: /new, /stop, /reasoning, /compact, /status, /usage, /verbose, /context, /subagents, /send
- Fuzzy filtering via name.includes(query)
- Parent manages selectedIndex and keyboard navigation (Svelte 5 no export function)
- Files changed: src/lib/chat/commands.ts (new), src/lib/components/SlashCommandMenu.svelte (new)
- **Learnings for future iterations:**
  - Svelte 5 does NOT support `export function` in components â€” use props for parent control
  - Thinking levels: off/minimal/low/medium/high/xhigh (NOT off/on/stream)
  - /send command needs sessionKey + message args parsed from space-separated input
  - Some commands (/status, /usage, /context) are UI-only â€” handler is no-op, UI reads state
---

## 2026-02-10 03:00 CST - US-022
- Created session list store in src/lib/stores/sessions.ts
- Created ChatList.svelte with search, rename (dblclick), delete, unread badges
- Store: loadSessions, setActiveSession, renameSession, deleteSession, live event subscription
- General session pinned to top, sorted by updatedAt descending
- Derived filteredSessions store for search filtering
- Files changed: src/lib/stores/sessions.ts (new), src/lib/components/ChatList.svelte (new)
- **Learnings for future iterations:**
  - Use `get()` from svelte/store for synchronous store reads in non-reactive contexts
  - Gateway `sessions.list` returns `sessions` array with sessionKey, displayName, etc.
  - Gateway `sessions.patch` for create/update, `sessions.delete` for removal
  - EventBus 'session' events have action: created/updated/deleted
---

## 2026-02-10 03:10 CST - US-023
- Added createSession function to sessions store
- Generates key: agent:<agentId>:webchat:group:<uuid> using defaultAgentId from snapshot
- Optimistic update: adds session to list immediately, sets as active
- Creates on server via sessions.patch
- Added "+ New Chat" button to ChatList.svelte (blue, with plus icon)
- Files changed: src/lib/stores/sessions.ts (modified), src/lib/components/ChatList.svelte (modified)
- **Learnings for future iterations:**
  - Use `get(snapshot.sessionDefaults)` to read defaultAgentId synchronously
  - Session key format: agent:<agentId>:webchat:group:<uuid>
  - Optimistic updates should add to list AND set active before server call
---

## 2026-02-10 03:20 CST - US-024
- Added ensureGeneralSession() to sessions store
- Checks sessions.list for isGeneral session, creates if missing
- General session key: agent:<agentId>:webchat:group:general (fixed key, not UUID)
- Auto-sets General as active session on connect
- Added $effect in +layout.svelte watching connection.state for 'READY'
- On READY: calls ensureGeneralSession() and subscribeToEvents()
- Files changed: src/lib/stores/sessions.ts (modified), src/routes/+layout.svelte (modified)
- **Learnings for future iterations:**
  - Connection state values are uppercase strings: 'READY', 'DISCONNECTED', etc.
  - ensureGeneralSession should be called after connection is READY (not during connect)
  - General session uses fixed key suffix 'general' not a random UUID
  - $effect cleanup in layout handles unsubscribeFromEvents on teardown
---

## 2026-02-10 02:30 CST - US-025
- Implemented ChatHeader.svelte component with session settings panel
- Chat header shows current model name and settings gear icon
- Settings panel includes: model override input, thinking level dropdown (off/minimal/low/medium/high/xhigh), verbose toggle
- Reset session button calls sessions.reset (equivalent to /new command)
- Compact transcript button calls sessions.compact (equivalent to /compact command)
- Settings applied via sessions.patch gateway call with active sessionKey
- Defaults read from snapshot.sessionDefaults store (model, thinkingLevel)
- Files changed: src/lib/components/ChatHeader.svelte
- **Learnings for future iterations:**
  - ChatHeader component is ready but not yet integrated into any route/page (chat routes not yet created)
  - Component uses $effect() to subscribe to snapshot.sessionDefaults and activeSessionKey stores
  - Settings changes call sessions.patch with individual field updates (model, thinkingLevel, verbose)
  - Thinking levels are off/minimal/low/medium/high/xhigh (NOT off/on/stream as noted in US-018)
  - Component follows Svelte 5 patterns: $state() for local reactive state, onclick handlers (not on:click)
  - Browser verification deferred until chat UI is fully integrated (no chat routes exist yet)
---

## 2026-02-10 03:30 CST - US-026
- Added connection-aware message queueing to chat store
- Messages typed while disconnected are queued in _pendingQueue writable
- send() checks connection.state â€” if not READY, queues message and shows optimistically
- Added reconcile() function: loads history, flushes queue, resumes active streaming runs
- Created chat-resilience.ts with watchConnectionForChat() connection state watcher
- Tracks disconnection duration â€” silent reconnect if <2s
- Files changed: src/lib/stores/chat.ts (modified), src/lib/stores/chat-resilience.ts (new)
- **Learnings for future iterations:**
  - Use `get(connection.state)` for synchronous connection state check in send()
  - reconcile() should load history FIRST, then flush queued messages
  - watchConnectionForChat returns an unsubscribe function for cleanup
  - Silent reconnect threshold is 2000ms â€” below that, no reconnection banner
---

## 2026-02-10 03:40 CST - US-027
- Added replyToMessageId to ChatMessage interface
- Added _replyTo store and setReplyTo function to chat session
- send() includes replyToMessageId in chat.send params and clears reply state after send
- Created ReplyPreview.svelte â€” compact preview with role, truncated content, cancel/click modes
- Created MessageActions.svelte â€” hover toolbar with Reply button
- Files changed: src/lib/stores/chat.ts (modified), src/lib/components/ReplyPreview.svelte (new), src/lib/components/MessageActions.svelte (new)
- **Learnings for future iterations:**
  - Reply preview shows first 100 chars of content with ellipsis
  - ReplyPreview has two modes: showCancel (composer) and onclick (in-message, scroll-to)
  - MessageActions is a floating toolbar â€” meant to appear on message hover (parent manages visibility)
  - replyToMessageId is stored both in ChatMessage and sent as chat.send param
---

## 2026-02-10 03:50 CST - US-028
- Created thread store (src/lib/stores/threads.ts) with openThread, closeThread, getThreadForMessage
- Thread key format: agent:<agentId>:webchat:group:<parentId>:thread:<uuid>
- Creates thread session via sessions.patch with parentSessionId and originMessageId
- Each thread gets its own ChatSessionStore via createChatSession()
- Created ThreadPanel.svelte â€” 80-width side panel with header, messages, composer
- Added 'Start Thread' button to MessageActions.svelte (onthread prop)
- Files changed: src/lib/stores/threads.ts (new), src/lib/components/ThreadPanel.svelte (new), src/lib/components/MessageActions.svelte (modified)
- **Learnings for future iterations:**
  - Thread sessions reuse createChatSession() â€” same message handling, streaming, etc.
  - Thread key includes parentId extracted from parent session key
  - Previous thread session is destroyed when opening a new thread
  - MessageActions now has both onreply and onthread props
---

## 2026-02-10 04:00 CST - US-029
- Added ThreadState type (active/archived/locked) and lifecycle functions to threads store
- archiveThread, unarchiveThread, lockThread â€” update local state + call sessions.patch
- loadThreads(parentSessionKey) â€” fetches threads from server via sessions.list
- threadsForSession(parentSessionKey) â€” derived store filtering threads by parent
- checkAutoArchive() â€” auto-archives threads inactive >24h
- Created ThreadList.svelte â€” displays threads with state color, message count, last activity
- Added threads button to ChatHeader.svelte â€” toggles thread list panel
- Files changed: src/lib/stores/threads.ts (modified), src/lib/components/ThreadList.svelte (new), src/lib/components/ChatHeader.svelte (modified)
- **Learnings for future iterations:**
  - ThreadState is 'active' | 'archived' | 'locked' â€” server stores state via sessions.patch
  - Auto-archive threshold is 24h (configurable via AUTO_ARCHIVE_MS constant)
  - threadsForSession returns a custom Readable that filters _threads map
  - ChatHeader now has both showSettings and showThreads toggle states
---

## 2026-02-10 04:10 CST - US-030
- Created Discord status store (src/lib/stores/discord.ts)
- discordStatus readable, isDiscordConnected derived, initDiscordStatus from health snapshot
- subscribeToDiscordEvents handles connect/disconnect events
- Created DiscordSyncBadge.svelte â€” indigo badge with Discord logo when connected
- Added channel field to ChatSessionInfo and createSession function
- ChatList shows Discord icon next to sessions with channel field
- Files changed: src/lib/stores/discord.ts (new), src/lib/components/DiscordSyncBadge.svelte (new), src/lib/stores/sessions.ts (modified), src/lib/components/ChatList.svelte (modified)
- **Learnings for future iterations:**
  - Discord status comes from snapshot.health.discord object
  - createSession accepts optional channel param for Discord sync
  - Gateway handles actual sync â€” dashboard just passes channel info
  - Discord events on eventBus: action 'connected' / 'disconnected'
---

## 2026-02-10 04:20 CST - US-031
- Added channel field to ThreadInfo interface for Discord thread sync
- openThread() accepts optional channel param, passes to sessions.patch
- Added subscribeToThreadEvents() â€” handles session events for Discord-originated threads
- Handles actions: created, updated, deleted, archived, unarchived
- loadThreads parses channel field from server response
- Files changed: src/lib/stores/threads.ts (modified)
- **Learnings for future iterations:**
  - Thread events come via 'session' event with parentSessionId present
  - Discord thread sync uses same session events as regular threads
  - subscribeToThreadEvents/unsubscribeFromThreadEvents pattern mirrors sessions store
---

## 2026-02-10 04:30 CST - US-032
- Added handleIncomingMessage to chat store for Discord-originated messages
- Subscribes to 'chat.message' eventBus events, deduplicates by ID
- Preserves replyToMessageId from incoming messages
- Created reply-utils.ts â€” findReferencedMessage, getReplyPreviewText, isReply
- Updated destroy() to unsubscribe from chat events
- Files changed: src/lib/stores/chat.ts (modified), src/lib/chat/reply-utils.ts (new)
- **Learnings for future iterations:**
  - Incoming Discord messages arrive via 'chat.message' eventBus events
  - handleIncomingMessage filters by sessionKey to only process relevant messages
  - reply-utils provides stateless helpers for UI components
---

## 2026-02-10 04:40 CST - US-033
- Extended MessageActions with Copy, React, Bookmark buttons (optional props)
- Created bookmarks store â€” Set-based toggle with isBookmarked/getBookmarks
- Created EmojiPicker.svelte â€” 12 quick emojis, backdrop dismiss, absolute positioned
- Created clipboard.ts â€” navigator.clipboard.writeText with execCommand fallback
- Bookmark star icon fills when bookmarked (yellow), empty when not
- Files changed: src/lib/components/MessageActions.svelte (modified), src/lib/stores/bookmarks.ts (new), src/lib/components/EmojiPicker.svelte (new), src/lib/chat/clipboard.ts (new)
- **Learnings for future iterations:**
  - MessageActions props are all optional except onreply and onthread
  - Bookmark uses Set<string> for O(1) lookups
  - EmojiPicker uses fixed backdrop + absolute positioning pattern
  - clipboard.ts uses navigator.clipboard with document.execCommand fallback
---

## 2026-02-10 04:50 CST - US-034
- Created chat-search store â€” searchAllChats, searchInSession via chat.search gateway call
- Created ChatSearch.svelte â€” search panel with All Chats / This Chat toggle, debounced input
- Created ScrollManager.svelte â€” infinite scroll, jump-to-bottom, new message count badge
- Created time-utils.ts â€” formatRelativeTime, formatAbsoluteTime, formatMessageTime
- ScrollManager uses onscrollmanager callback prop (Svelte 5 no export function)
- Highlight animation on jump-to-message via CSS keyframes
- Files changed: src/lib/stores/chat-search.ts (new), src/lib/components/ChatSearch.svelte (new), src/lib/components/ScrollManager.svelte (new), src/lib/chat/time-utils.ts (new)
- **Learnings for future iterations:**
  - Search uses debounced input (300ms) to avoid excessive gateway calls
  - ScrollManager exposes API via onscrollmanager callback prop, not export function
  - Scroll position detection: scrollTop < 50 triggers loadmore, >100px from bottom shows jump button
  - data-message-id attribute on message elements enables scrollToMessage targeting
---

## 2026-02-10 05:00 CST - US-035
- Created notifications store with settings persistence (localStorage)
- Tab title updates with unread count: "(3) Falcon Dash"
- Audio notification with configurable volume
- Browser Notification API with permission request workflow
- notifyNewMessage orchestrates: increment unread + play sound + browser notification
- Created NotificationSettings.svelte â€” toggles for sound/browser notifications, volume slider
- Files changed: src/lib/stores/notifications.ts (new), src/lib/components/NotificationSettings.svelte (new)
- **Learnings for future iterations:**
  - Settings persist via localStorage key 'falcon-dash-notifications'
  - Browser notifications only show when tab is NOT focused (document.hasFocus())
  - Audio play may fail due to autoplay policy â€” silently caught
  - This completes Phase 2 of the PRD
---

## 2026-02-10 05:10 CST - US-036
- Created files-config.ts â€” getDocumentsRoot, resolveFilePath (path traversal protection), isSecretPath
- Created SvelteKit server route at /api/files/[...path]/+server.ts
- GET: directory listing or file content with SHA-256 hash
- PUT: write with X-Base-Hash header for optimistic concurrency (409 on conflict)
- POST: create file (wx flag) or directory (recursive mkdir)
- DELETE: rm with recursive option
- .secrets/ directory blocked at all levels
- MIME type detection for common file extensions
- Root resolves to FALCON_DOCUMENTS_PATH env or ~/Documents
- Files changed: src/lib/server/files-config.ts (new), src/routes/api/files/[...path]/+server.ts (new)
- **Learnings for future iterations:**
  - SvelteKit server routes: +server.ts with exported GET/PUT/POST/DELETE
  - $types import path auto-generated by SvelteKit for RequestHandler type
  - Path traversal protection: resolve + startsWith check against root
  - writeFile flag 'wx' = exclusive create (fail if exists)
  - Phase 3A: Documents begins here
---

## 2026-02-10 05:20 CST - US-037
- Created files store â€” loadDirectory, setSortField, navigateUp, breadcrumbs derived
- sortedEntries: directories first, then by field/direction, with search filter
- Created DocumentBrowser.svelte â€” grid layout with sortable column headers
- File type icons (emoji) based on extension, relative timestamps, formatted sizes
- Breadcrumb navigation, back (..) entry, search input
- Created /documents route page
- Files changed: src/lib/stores/files.ts (new), src/lib/components/DocumentBrowser.svelte (new), src/routes/documents/+page.svelte (new)
- **Learnings for future iterations:**
  - File browser fetches from /api/files/ (US-036 routes)
  - Directories always sorted before files regardless of sort field
  - breadcrumbs derived store splits path and accumulates segments
  - setSortField toggles direction if same field clicked again
---

## 2026-02-10 â€” US-038: Document editor with preview and save
- Created `src/lib/stores/editor.ts` with openFile, saveFile, updateContent, closeFile
- Created `src/lib/components/DocumentEditor.svelte` with textarea editing, markdown side-by-side preview, JSON formatting
- Modified DocumentBrowser.svelte to open files in the editor panel
- Hash-based optimistic concurrency (X-Base-Hash header) for conflict detection on save
- File type detection: markdown, json, code, image, text
- Ctrl+S keyboard shortcut for save
- **Learnings for future iterations:**
  - editor.ts uses synchronous `subscribe()/unsubscribe()` pattern to read current state in async functions
  - Image files store blob URL in content field, not raw data
  - formatJson() in editor component handles display formatting without modifying stored content
  - 409 status from PUT indicates external modification â€” show reload prompt
---

## 2026-02-10 â€” US-039: Document create and upload
- Added PATCH handler to `src/routes/api/files/[...path]/+server.ts` for rename operations
- Added createFile, createFolder, deleteEntry, renameEntry, uploadFile to `src/lib/stores/files.ts`
- Enhanced `src/lib/components/DocumentBrowser.svelte` with full file management:
  - Toolbar: + File, + Folder, Upload buttons
  - Inline hover actions: Rename, Copy Path, Download, Delete
  - Right-click context menu with same actions
  - Drag-and-drop upload with visual overlay
  - Modal dialogs for create file, create folder, delete confirmation
  - Inline rename with Enter/Escape keyboard support
- **Learnings for future iterations:**
  - PATCH handler validates newName to prevent path traversal (no / or ..)
  - Upload uses POST for new files, falls back to PUT if file exists (409)
  - Context menu uses fixed positioning with click-away-to-close pattern
  - Drag-and-drop uses ondragover/ondragleave/ondrop on container div
  - File download creates temporary anchor element with download attribute
---

## 2026-02-10 â€” US-040: Document bulk operations
- Created `src/routes/api/files-bulk/+server.ts` with POST handler for delete/move/download actions
- Added selection state to `src/lib/stores/files.ts`: selectedPaths, selectedCount, toggleSelection, selectAll, clearSelection, selectRange
- Added bulk operation functions: bulkDelete, bulkMove, bulkDownload
- Enhanced `src/lib/components/DocumentBrowser.svelte` with:
  - Checkboxes per entry row (4-column grid layout)
  - Shift-click range selection
  - Bulk action toolbar (shows when items selected): Select All, Clear, Download, Move, Delete
  - Bulk delete confirmation dialog
  - Move destination picker dialog (lists available folders)
  - Select-all checkbox in column headers
- loadDirectory() now clears selection when navigating
- **Learnings for future iterations:**
  - Bulk API endpoint uses single POST with `action` field to handle multiple operations
  - Selection state uses Set<string> for O(1) lookup performance
  - selectRange uses entry index positions from sorted entries array
  - Bulk download returns file contents as JSON for client-side individual downloads
  - Move dialog filters out selected folders from destination options to prevent self-move
---

## 2026-02-10 â€” US-041: Cron job list
- Created `src/lib/stores/cron.ts` with loadCronJobs, subscribeToCronEvents, formatSchedule
- Created `src/lib/components/CronJobList.svelte` with grid columns: name, schedule, next/last run, status
- Created `src/routes/jobs/+page.svelte` route
- Status badges: Enabled (green), Disabled (gray), Error (red)
- Empty state with clock icon and "Create Job" prompt
- Live updates: subscribes to `event:cron` and reloads on any action
- **Learnings for future iterations:**
  - Gateway call pattern: `call<T>('method.name', { params })` returns Promise<T>
  - Event subscription: `eventBus.on('eventType', callback)` returns unsub function
  - Cron events reload full list rather than patching individual items (simpler)
  - Use `@const` in Svelte template for computed values like `{@const badge = statusBadge(job)}`
---

## 2026-02-10 â€” US-042: Cron job CRUD
- Added CronJobInput interface and CRUD functions to `src/lib/stores/cron.ts`: createCronJob, updateCronJob, deleteCronJob, runCronJob, toggleCronJob
- Created `src/lib/components/CronJobForm.svelte` modal form for create/edit with all fields
- Enhanced `src/lib/components/CronJobList.svelte` with action buttons per row: toggle, run now, edit, delete
- Added "+ Create Job" button in header and clickable empty state
- Delete confirmation dialog with job name display
- **Learnings for future iterations:**
  - Use `$props()` for component props in Svelte 5 (NOT `export let`)
  - Form fields use `bind:value` for two-way binding
  - Dynamic label text based on scheduleType (cron/interval/one-shot)
  - Toggle uses `updateCronJob(id, { enabled: !job.enabled })` convenience wrapper
  - `cron.run({ id, mode: 'force' })` triggers immediate execution
---

## 2026-02-10 â€” US-043: Cron run history
- Added CronRun interface, loadCronRuns, clearCronRuns to `src/lib/stores/cron.ts`
- Created `src/lib/components/CronRunHistory.svelte` with expandable output rows
- Updated CronJobList with history button (ðŸ“Š) and conditional history view
- Columns: timestamp, status (success/error badges), duration, output preview
- Click row to expand full output in pre block
- Back button to return to job list
- **Learnings for future iterations:**
  - `cron.runs({ id, limit: 50 })` returns run history for a specific job
  - Expandable rows use toggle state (expandedRunId) on click
  - CronRunHistory replaces CronJobList view conditionally (no route change needed)
  - Duration formatting: <1s shows ms, >=1s shows decimal seconds
---

## 2026-02-10 â€” US-044: Heartbeat configuration
- Created `src/lib/stores/heartbeat.ts` with loadHeartbeatConfig, updateHeartbeatConfig, saveHeartbeatTemplate
- Created `src/lib/components/HeartbeatPanel.svelte` with status, config, and template sections
- Created `src/routes/heartbeat/+page.svelte` route
- Status section: active/paused toggle, interval, last run, next run
- Config section: active hours (start/end/timezone), delivery target with edit dialog
- Template section: HEARTBEAT.md editor with live MarkdownRenderer preview
- Save via `agents-files.set`, config via `config.patch`
- **Learnings for future iterations:**
  - `config.get` uses path param to scope the config section returned
  - `config.patch` merges partial updates into existing config
  - `agents-files.set` writes file content by path (like HEARTBEAT.md)
  - Promise.all for parallel loading of config, status, and template
---

## 2026-02-10 â€” US-045: Heartbeat history
- Added HeartbeatExecution interface, loadHeartbeatHistory to `src/lib/stores/heartbeat.ts`
- Created `src/lib/components/HeartbeatHistory.svelte` with expandable execution rows
- Added HeartbeatHistory section to HeartbeatPanel
- Shows checked items and surfaced items with expandable details
- **Learnings for future iterations:**
  - `last-heartbeat` method returns recent heartbeat executions
  - Expandable detail pattern reused from CronRunHistory
---

## 2026-02-10 â€” US-046: Cron event integration with toasts
- Created `src/lib/stores/toast.ts` with addToast, removeToast, auto-dismiss
- Created `src/lib/components/ToastContainer.svelte` with bottom-right positioning
- Updated cron.ts subscribeToCronEvents to show toast notifications on events
- Added ToastContainer to root +layout.svelte
- Toast types: success (green), error (red), info (gray)
- End of Phase 3B
- **Learnings for future iterations:**
  - Toast store uses setTimeout for auto-dismiss with configurable duration
  - ToastContainer mounted in root layout for global visibility
  - crypto.randomUUID() for unique toast IDs
  - Toast pattern reusable for other event-driven notifications
---

## 2026-02-10 â€” US-047: Password server routes
- Created `src/lib/server/passwords-config.ts` with in-memory session management (30min expiry)
- Created `src/lib/server/keepassxc.ts` with spawn-based CLI wrapper (no shell injection)
- Created `src/routes/api/passwords/+server.ts` for list/unlock/lock/init
- Created `src/routes/api/passwords/[...path]/+server.ts` for get/put/delete
- Session token via X-Session-Token header
- PUT uses edit-then-add fallback pattern for create-or-update
- **Learnings for future iterations:**
  - Use spawn with args array NOT exec with string concatenation for security
  - KeePassXC CLI reads password from stdin (proc.stdin.write)
  - `ls -R -f` lists all entries recursively with full paths
  - `show -s` skips password display, `show` includes password
  - In-memory session store maps token -> { password, expires }
---

## 2026-02-10 â€” US-048: Vault creation flow
- Created `src/lib/stores/passwords.ts` with checkVaultStatus, initVault, unlockVault, lockVault, validatePasswordStrength
- Created `src/lib/components/VaultSetup.svelte` with password + confirm inputs, strength meter
- Created `src/lib/components/VaultUnlock.svelte` with simple unlock form
- Created `src/routes/passwords/+page.svelte` with conditional state routing
- VaultState: checking -> no-vault | locked | unlocked
- **Learnings for future iterations:**
  - Password strength validation: 8+ chars, uppercase, lowercase, number
  - $derived() for computed validation state reacts to input changes
  - Vault status check uses GET /api/passwords with empty token to detect 404 vs 401
---

## 2026-02-10 â€” US-049: Password list UI
- Created `src/lib/components/PasswordList.svelte` with grid columns: title, username, URL
- Group/folder navigation with breadcrumbs
- Search by title/username/URL (case-insensitive)
- Sort by title with toggle direction
- Self-contained component with sessionToken prop
- **Learnings for future iterations:**
  - PasswordList takes sessionToken as prop for API auth (x-session-token header)
  - Group hierarchy extracted from entry paths (split on /)
  - Passwords never shown in list view â€” only in detail view
---

## 2026-02-10 ~09:55 CST - US-050
- Implemented password CRUD operations
- Files created: src/lib/components/PasswordForm.svelte, src/lib/components/PasswordDetail.svelte
- Files modified: src/routes/passwords/+page.svelte
- PasswordForm: create/edit modal with password generator (crypto.getRandomValues), toggle visibility
- PasswordDetail: entry detail view with edit/delete actions, delete confirmation dialog
- **Learnings for future iterations:**
  - Variable named `state` conflicts with Svelte 5 `$state` rune â€” use a descriptive name like `vaultStatus`
  - Password page wires PasswordList, PasswordDetail, and PasswordForm with refreshKey pattern
---

## 2026-02-10 ~09:55 CST - US-051
- Implemented vault unlock flow enhancements
- Files created: src/lib/passwords/clipboard.ts, src/lib/components/PasswordReveal.svelte
- Files modified: src/lib/stores/passwords.ts, src/lib/server/passwords-config.ts
- Auto-lock timer with 5min default, activity monitor (click/keydown/mousemove)
- Clipboard copy with auto-clear after 30s
- PasswordReveal: inline reveal/hide toggle with auto-hide after 30s
- refreshSession added to server config for session extension
- **Learnings for future iterations:**
  - Use copyWithAutoClear pattern for sensitive clipboard data
  - Activity monitor returns cleanup function for $effect teardown
---

## 2026-02-10 ~10:05 CST - US-052
- Implemented secrets migration feature
- Files created: src/routes/api/passwords/import-secrets/+server.ts, src/lib/components/SecretsMigration.svelte
- Files modified: src/routes/passwords/+page.svelte
- GET endpoint scans ~/.openclaw/secrets/ and returns file list with masked preview
- POST endpoint imports files into vault using addEntry, filename as title
- SecretsMigration component: scan button, preview table, import with confirmation
- **Learnings for future iterations:**
  - Handle missing directories gracefully (return empty array, not error)
  - Mask preview content in scan results for security
---

## 2026-02-10 ~10:05 CST - US-053
- Implemented password security model utilities
- Files created: src/lib/server/password-security.ts
- Files modified: src/routes/api/passwords/[...path]/+server.ts
- sanitizeForAI strips vault:// references and password patterns before AI model
- maskSecretInLog replaces sensitive data with [REDACTED] for logging
- Added X-Secret-Content: true header to password detail GET responses
- **Learnings for future iterations:**
  - Most security was already in place from US-047/048/051 (keepassxc-cli, masking, auto-clear)
  - X-Secret-Content header pattern useful for middleware to detect sensitive responses
---

## 2026-02-10 ~10:20 CST - US-054
- Implemented PM database schema and migrations
- Files created: src/lib/server/pm/database.ts
- Dependencies added: better-sqlite3, @types/better-sqlite3
- Full schema: domains, focuses, milestones, projects, tasks, comments, blocks, activities, attachments, sync_mappings
- Added sort_order columns on domains, focuses, tasks for drag-and-drop
- WAL mode and foreign keys enabled, singleton pattern with getDb()
- All entity TypeScript interfaces exported
- **Learnings for future iterations:**
  - Use IF NOT EXISTS for all CREATE statements for idempotent schema
  - better-sqlite3 is synchronous â€” no async/await needed
---

## 2026-02-10 ~10:20 CST - US-055
- Implemented PM CRUD operations and activity logging
- Files created: src/lib/server/pm/crud.ts
- Complete CRUD for all 9 entity types with proper signatures
- Activity auto-logging: created/updated/status_changed/commented
- resolveProjectId() walks parent chain for nested tasks
- Reorder operations use transactions for atomicity
- **Learnings for future iterations:**
  - last_activity_at propagates UP through hierarchy (task -> project)
  - updated_at only on direct field edits, not on child activities
  - Use db.transaction() wrapper for multi-statement operations
---

## 2026-02-10 ~10:20 CST - US-056
- Implemented PM FTS5 search index
- Files created: src/lib/server/pm/search.ts
- FTS5 virtual table with porter unicode61 tokenizer
- Auto-sync triggers on projects, tasks, comments (insert/update/delete)
- searchPM() with ranked results, snippets, entity/project filtering
- rebuildSearchIndex() for full re-indexing
- **Learnings for future iterations:**
  - FTS5 stores everything as text â€” CAST needed for integer columns in results
  - snippet() function takes column index, markers, and word count params
---

## 2026-02-10 ~10:35 CST - US-057
- Implemented PM WS methods for Domain, Focus, Milestone
- Files created: src/lib/stores/pm-domains.ts
- Writable/readonly store pattern with loading/error state
- 18 gateway call wrappers: list/get/create/update/delete/reorder for each entity
- Event subscriptions for real-time sync (pm.domain.changed, pm.focus.changed, pm.milestone.changed)
- **Learnings for future iterations:**
  - PM stores follow same pattern as cron.ts: writable internal, readonly export, call() wrapper
---

## 2026-02-10 ~10:35 CST - US-058
- Implemented PM WS methods for Project and Task
- Files created: src/lib/stores/pm-projects.ts
- Project: list/get/create/update/delete (5 methods)
- Task: list/get/create/update/move/reorder/delete (7 methods)
- currentProject and currentTasks tracking for detail views
- **Learnings for future iterations:**
  - Use separate loading states for projects vs tasks
  - Cast filter objects with `as Record<string, unknown>` for call()
---

## 2026-02-10 ~10:35 CST - US-059
- Implemented remaining PM WS methods
- Files created: src/lib/stores/pm-operations.ts
- 18 functions: comments(4), blocks(3), attachments(3), activities(1), context(3), search(1), bulk(2), stats(1)
- Pure functions (no stores needed) â€” UI calls them directly
- Context types: DashboardContext, DomainContext, ProjectContext for pre-assembled views
- **Learnings for future iterations:**
  - Pure call wrappers don't need stores â€” only use stores when UI needs reactive updates
---

## 2026-02-10 ~10:50 CST - US-060
- Implemented PM request validation
- Files created: src/lib/server/pm/validation.ts
- PMError class with PM_NOT_FOUND, PM_CONSTRAINT, PM_INVALID_PARENT, PM_CIRCULAR_BLOCK, PM_DUPLICATE
- parseId() handles raw integers and prefixed IDs (P-42 -> 42)
- Cursor-based pagination: parsePagination(), paginate() with default 50, max 200
- Idempotency cache with 5-minute expiry
- Field validators: requireString, requireNumber, validateStatus, validatePriority
- Circular block detection via BFS
---

## 2026-02-10 ~10:50 CST - US-061
- Implemented PM real-time events
- Files created: src/lib/server/pm/events.ts, src/lib/stores/pm-events.ts
- Server: emitPMEvent with monotonic stateVersion, listener pattern, 100-event buffer
- Client: subscribeToPMEvents listens to event:pm and auto-refreshes relevant stores
- PMAction types: created/updated/deleted/moved/reordered/status_changed
---

## 2026-02-10 ~10:50 CST - US-062
- Implemented PM context generation
- Files created: src/lib/server/pm/context.ts
- Dashboard: active projects, due soon, blocked, recent activity (~1-2k tokens)
- Domain: focuses with project summaries and progress (~3-5k tokens)
- Project: full detail with tasks, subtasks, blocks, comments, activity (~5-10k tokens)
- Each returns { markdown, generated_at, stats }
---

## 2026-02-10 ~10:50 CST - US-063
- Implemented PM stats aggregates
- Files created: src/lib/server/pm/stats.ts
- Returns: project/task counts by status, blocked, overdue, recentActivity (24h), dueSoon (7d)
- Uses ISO date strings for SQLite date comparisons
---

## 2026-02-10 ~11:00 CST - US-064
- Implemented PM bulk operations backend
- Files created: src/lib/server/pm/bulk.ts
- bulkUpdate: status/priority/milestone/due_date on multiple projects or tasks
- bulkMove: moves tasks to new parent with circular dependency check
- Returns { updated, errors[] } with per-item error reporting
- Uses db.transaction() for atomicity
---

## 2026-02-10 ~11:00 CST - US-065
- Implemented PM store layer
- Files created: src/lib/stores/pm-store.ts
- Map-based caches for domains, focuses, projects, tasks
- hydratePMStores() loads all in parallel via Promise.all
- Optimistic updates with rollback on error for projects and tasks
- stateVersion gap detection (threshold=5) triggers full refetch
- Derived views: kanbanView (by status), listView (by activity), treeView (hierarchy)
- Feature detection: checkPMAvailability() checks features.methods
---

## 2026-02-10 ~11:30 CST - US-066
- Implemented PM dashboard view
- Files created: src/lib/components/pm/PMDashboard.svelte, src/routes/projects/+page.svelte
- Stats header: 5 cards (total projects, in-progress, tasks, blocked, overdue)
- Due soon list with date formatting
- In-progress projects with progress bars (done/total tasks)
- Blocked items display
- Recent activity feed
- Auto-refreshes via hydratePMStores on mount
- **Learnings for future iterations:**
  - PM components live in src/lib/components/pm/ subdirectory
  - Stats come from pm.stats.overview gateway call
  - Progress bars use percentage width with inline styles
---

## 2026-02-10 ~11:30 CST - US-067
- Implemented domain/focus navigation tree
- Files created: src/lib/components/pm/PMNavTree.svelte
- Domain->Focus hierarchy sidebar with expand/collapse
- Selection filtering updates parent project list
- Count badges showing project counts per focus
- Visual indicators for active selection
- **Learnings for future iterations:**
  - Nav tree uses expand/collapse state per domain
  - Selection dispatches via onselect callback prop
  - Count badges query project count per focus_id
---

## 2026-02-10 ~11:30 CST - US-068
- Implemented project list view
- Files created: src/lib/components/pm/ProjectList.svelte
- Sortable table with columns: title, status, priority, focus, due date, tasks
- Filters: status, priority, milestone, due date range, overdue toggle
- Cursor-based pagination (50 per page)
- Inline create form for quick project creation
- Click row to open detail view (placeholder)
- **Learnings for future iterations:**
  - Pagination uses cursor-based approach with last item ID
  - Filter state managed locally with reactive updates
  - Inline create uses minimal form that expands on focus
---
