# Ralph Progress Log
Started: Tue Feb 10 01:06:48 AM CST 2026

## Codebase Patterns
- Prettier config: tabs, single quotes, no trailing commas, printWidth 100
- Svelte 5 syntax: use `$props()` not `export let`, use `{@render children()}` not `<slot />`
- TypeScript strict mode enabled in tsconfig.json
- Tailwind CSS v4 with `@import 'tailwindcss'` in app.css (not v3 @tailwind directives)
- ESLint v9 flat config format (eslint.config.js, not .eslintrc)
- Vite dev proxy at `/ws` routes to `ws://127.0.0.1:18789`
- Always run `npm run format` after writing code
- Don't commit `.omc/` directory (local state)
- Gateway connection: client.id must be "openclaw-control-ui", client.mode must be "webchat" (gateway validates)
- Prettier adds semicolons on format — don't write them manually, let Prettier handle it
- Use `.js` extension in TypeScript imports (e.g., `from './types.js'`) for ESM compatibility

---

## 2026-02-10 01:15 CST - US-001
- Scaffolded SvelteKit project with TypeScript strict mode
- Configured Tailwind CSS v4, ESLint v9 flat config, Prettier
- Created directory structure: src/lib/gateway/, src/lib/stores/, src/lib/components/, src/routes/
- Configured vite.config.ts with dev proxy to gateway port 18789
- Files changed: package.json, svelte.config.js, vite.config.ts, tsconfig.json, .prettierrc, .prettierignore, eslint.config.js, src/app.html, src/app.css, src/app.d.ts, src/routes/+layout.svelte, src/routes/+page.svelte, src/lib/gateway/.gitkeep, src/lib/stores/.gitkeep, src/lib/components/.gitkeep
- **Learnings for future iterations:**
  - Tailwind CSS v4 uses `@import 'tailwindcss'` instead of v3's `@tailwind base/components/utilities`
  - ESLint v9 uses flat config (eslint.config.js) with `ts.config()` wrapper, not .eslintrc
  - SvelteKit `svelte-kit sync` must run before `svelte-check` to generate types
  - `.svelte-kit/tsconfig.json` is auto-generated — our tsconfig.json extends it
  - `@tailwindcss/vite` plugin is used for Tailwind v4 integration (not postcss)
---

## 2026-02-10 01:20 CST - US-002
- Implemented GatewayConnection class in src/lib/gateway/connection.ts
- Created type definitions in src/lib/gateway/types.ts (Frame types, ConnectionState, HelloOkPayload, etc.)
- Created barrel export in src/lib/gateway/index.ts
- Connection lifecycle: DISCONNECTED → CONNECTING → AUTHENTICATING → CONNECTED → READY
- Handles connect.challenge event, sends connect frame with protocol v3
- Parses hello-ok response, exposes snapshot/features/policy via helloOk readable store
- Exposes connection state as Svelte readable store
- Files changed: src/lib/gateway/connection.ts, src/lib/gateway/types.ts, src/lib/gateway/index.ts
- **Learnings for future iterations:**
  - ESLint flags unused params even with underscore prefix — store challenge for future Ed25519 signing (US-102)
  - Prettier auto-adds semicolons — the original code was written without them but Prettier normalizes
  - Use `readonly()` from svelte/store to expose writable stores as read-only to consumers
  - Connection uses id "1" for the connect request — future RequestCorrelator will use different IDs
  - WebSocket close code 1008 indicates "pairing required" from gateway
---

## 2026-02-10 01:25 CST - US-003
- Implemented RequestCorrelator class in src/lib/gateway/correlator.ts
- Maps req.id → pending Promise, resolves on ok:true, rejects on ok:false with GatewayRequestError
- Monotonic counter for request IDs, crypto.randomUUID() for idempotency keys
- Configurable timeout per request (default 30s), cancelAll() for disconnect cleanup
- Updated src/lib/gateway/index.ts with new exports
- Files changed: src/lib/gateway/correlator.ts, src/lib/gateway/index.ts
- **Learnings for future iterations:**
  - GatewayRequestError wraps gateway error shape (code, message, details, retryable, retryAfterMs)
  - Use `track<T>()` generic to get typed Promise returns
  - cancelAll() should be called on disconnect to reject all pending requests
  - Monotonic counter starts at 0 — avoid using id "1" for connect (reserved in GatewayConnection)
---

## 2026-02-10 01:30 CST - US-004
- Implemented EventBus class in src/lib/gateway/event-bus.ts
- on(event, handler) returns unsubscribe function, once(event) returns Promise
- Wildcard support: "pm.*" matches "pm.task.create", "*" matches everything
- clear() for auto-cleanup on disconnect
- handleFrame() dispatches EventFrame to exact and wildcard handlers
- Files changed: src/lib/gateway/event-bus.ts, src/lib/gateway/index.ts
- **Learnings for future iterations:**
  - Wildcard matching uses prefix: "pm.*" → startsWith("pm.")
  - EventBus.clear() must be called on disconnect to prevent stale handler references
  - Handlers receive both payload and full EventFrame (for seq/stateVersion access)
---

## 2026-02-10 01:35 CST - US-005
- Implemented SnapshotStore class in src/lib/gateway/snapshot-store.ts
- Seven readable stores: presence, health, stateVersion, sessionDefaults, features, server, policy
- hydrate() initializes from hello-ok payload, subscribe() connects to EventBus for incremental updates
- Presence events: add/update/remove entries by instanceId, tracks stateVersion
- Health events: merge payload into health store, tracks stateVersion
- hasMethod() derived store for runtime feature detection (e.g., check pm.* availability)
- Files changed: src/lib/gateway/snapshot-store.ts, src/lib/gateway/index.ts
- **Learnings for future iterations:**
  - SnapshotStore.subscribe(eventBus) must be called after hydrate() for incremental updates
  - Presence dedup is by instanceId (unique per tab)
  - stateVersion is per-domain object { presence: N, health: N }, not a single number
  - features.methods list determines which UI features to enable (feature detection pattern)
---
